var OTHER_CODE=[8220,8221,8216,8217,65281,12290,65292,12304,12305,12289,65311,65288,65289,12288,12298,12299,65306];function getStrLength(t){if(!t)return 0;for(var e,n=0,a=0;e=t.charCodeAt(n);)n++,e<48||57<e&&e<65||90<e&&e<97||122<e&&e<128||128<e&&0<=OTHER_CODE.indexOf(e)||a++;return a}function bindChapter(){function t(){var t=getStrLength(n.val()+"");e.find("span").text(t),e.find("input").val(t)}var e=$(".length-box"),n=$("#content-box"),a=!1;n.on("input propertychange",function(){t(),a||(a=!0,setTimeout(function(){console.log("saving")},2e3))}).on("keydown",function(t){9===t.keyCode&&(t.preventDefault(),t=this.selectionStart+4,this.value=this.value.substr(0,this.selectionStart)+"    "+this.value.substr(this.selectionStart),this.selectionStart=t,this.selectionEnd=t,this.focus())}),t()}function bindImport(s){function r(t){var e,n,a,i,o;200==t.code&&"object"==typeof t.data&&t.data.key?(e=d.show().find("progress").val(100*t.data.next/t.data.count).next("span"),n=t.data,0<l&&clearInterval(l),a=n.next+"/"+n.count+"(预计需要",i=(new Date).getTime()-c.getTime(),o=Math.ceil(i/n.next*(n.count-n.next)/1e3),l=setInterval(function(){var t=o+"秒";60<o&&(t=Math.floor(o/60)+"分"+Math.ceil(o%60)+"秒"),e.text(a+t+")"),o<1||o--},1e3),postJson(s+"spider/async",t.data,r)):(d.hide(),0<l&&(clearInterval(l),l=0),parseAjax(t))}var i=$(".book-box"),o=[],c=new Date,l=0,d=$(".dialog-progress");$(".search form").submit(function(){return postJson(s+"spider/search",$(this).serialize(),function(t){if(200!=t.code)parseAjax(t);else{o=t.data;for(var e="",n=0;n<o.length;n++){var a=o[n];e+='<div class="book-item" data-index="'+n+'"><div class="info"><p>'+a.name+"("+a.author+")</p><p>总字数： "+a.size+"</p> <p>最新章节： "+a.last_chapter+'</p></div><div class="actions"><a href="javascript:;">同步</a></div></div>'}i.html(e)}}),!1}),i.on("click",".book-item .actions a",function(t){t.preventDefault();t=$(this).closest(".book-item").data("index"),t=o[t];t?(c=new Date,d.show().find("progress").val(0).next("span").text("初始化。。。"),postJson(s+"spider/async",t,r)):Dialog.tip("书籍不存在")})}