var OTHER_CODE=[8220,8221,8216,8217,65281,12290,65292,12304,12305,12289,65311,65288,65289,12288,12298,12299,65306];function getStrLength(t){if(!t)return 0;for(var e,n=0,a=0;e=t.charCodeAt(n);)n++,e<48||57<e&&e<65||90<e&&e<97||122<e&&e<128||128<e&&0<=OTHER_CODE.indexOf(e)||a++;return a}function bindChapter(){var e=$(".length-box"),n=$("#content-box"),t=function(){var t=getStrLength(n.val()+"");e.find("span").text(t),e.find("input").val(t)},a=!1;n.on("input propertychange",function(){t(),a||(a=!0,setTimeout(function(){console.log("saving")},2e3))}).on("keydown",function(t){if(9===t.keyCode){t.preventDefault();var e=this.selectionStart+4;this.value=this.value.substr(0,this.selectionStart)+"    "+this.value.substr(this.selectionStart),this.selectionStart=e,this.selectionEnd=e,this.focus()}}),t()}function bindImport(o){var i=$(".book-box"),s=[],r=new Date,c=0,l=$(".dialog-progress"),d=function(t){if(200==t.code&&"object"==typeof t.data&&t.data.key)return function(e,t){0<c&&clearInterval(c);var n=t.next+"/"+t.count+"(预计需要",a=(new Date).getTime()-r.getTime(),i=Math.ceil(a/t.next*(t.count-t.next)/1e3);c=setInterval(function(){var t=i+"秒";60<i&&(t=Math.floor(i/60)+"分"+Math.ceil(i%60)+"秒"),e.text(n+t+")"),i<1||i--},1e3)}(l.show().find("progress").val(100*t.data.next/t.data.count).next("span"),t.data),void postJson(o+"spider/async",t.data,d);l.hide(),0<c&&(clearInterval(c),c=0),parseAjax(t)};$(".search form").submit(function(){return postJson(o+"spider/search",$(this).serialize(),function(t){if(200==t.code){s=t.data;for(var e="",n=0;n<s.length;n++){var a=s[n];e+='<div class="book-item" data-index="'+n+'"><div class="info"><p>'+a.name+"("+a.author+")</p><p>总字数： "+a.size+"</p> <p>最新章节： "+a.last_chapter+'</p></div><div class="actions"><a href="javascript:;">同步</a></div></div>'}i.html(e)}else parseAjax(t)}),!1}),i.on("click",".book-item .actions a",function(t){t.preventDefault();var e,n,a=$(this).closest(".book-item").data("index"),i=s[a];i?(r=new Date,e=0,n="初始化。。。",l.show().find("progress").val(e).next("span").text(n),postJson(o+"spider/async",i,d)):Dialog.tip("书籍不存在")})}