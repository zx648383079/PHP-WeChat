var ChatType,__extends=this&&this.__extends||function(){var i=function(t,e){return(i=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var n in e)e.hasOwnProperty(n)&&(t[n]=e[n])})(t,e)};return function(t,e){function n(){this.constructor=t}i(t,e),t.prototype=null===e?Object.create(e):(n.prototype=e.prototype,new n)}}();!function(t){t[t.MESSAGE=0]="MESSAGE",t[t.MORE=1]="MORE",t[t.TIP=2]="TIP",t[t.TIME=3]="TIME"}(ChatType||(ChatType={}));var EVENT_REFRESH_USERS="refresh_users",EVENT_REFRESH_GROUPS="refresh_groups",EVENT_GROUP_USERS="refresh_group_users",EVENT_USER_GROUPS="user_groups",EVENT_USER_INFO="user_info",EVENT_GROUP_INFO="group_info",EVENT_SEARCH_USERS="search_users",EVENT_SEARCH_GROUPS="search_groups",EVENT_ADD_USER="add_user",EVENT_SEND_MESSAGE="send_message",EVENT_GET_MESSAGE="get_message",ChatBaseBox=function(){function t(){this.cache_element={}}return t.prototype.find=function(t){return this.cache_element.hasOwnProperty(t)?this.cache_element[t]:this.cache_element[t]=this.box.find(t)},t.prototype.show=function(){return this.box.show(),this},t.prototype.center=function(){return this.box.css({left:Math.max(0,($(window).width()-this.box.outerWidth())/2)+"px",top:Math.max(0,($(window).height()-this.box.outerHeight())/2)+"px"}),this},t.prototype.hide=function(){this.box.hide()},t.format=function(t){for(var n=[],e=1;e<arguments.length;e++)n[e-1]=arguments[e];return t.replace(/\{(\d+)\}/g,function(t,e){return n[e]})},t}(),ChatMenu=function(i){function t(t,e){var n=i.call(this)||this;return n.box=t,n._menus=[],n._events={},n.bindEvent(),n.menus=e,n}return __extends(t,i),Object.defineProperty(t.prototype,"menus",{set:function(t){this._menus=t,this.refresh()},enumerable:!0,configurable:!0}),t.prototype.on=function(t,e){return this._events[t]=e,this},t.prototype.hasEvent=function(t){return this._events.hasOwnProperty(t)},t.prototype.trigger=function(t){for(var e,n=[],i=1;i<arguments.length;i++)n[i-1]=arguments[i];if(this.hasEvent(t))return(e=this._events[t]).call.apply(e,[this].concat(n))},t.prototype.bindEvent=function(){var e=this;this.box.on("click","li",function(t){!1===e.clickLi($(this))&&t.stopPropagation()})},t.prototype.clickLi=function(t){var e,n=t.attr("data-name");if(!(n&&this._menuMap.hasOwnProperty(n)&&(e=this._menuMap[n])&&e.onclick&&!1===e.onclick(t,this.target,this)||n&&this.hasEvent(n)&&!1===this.trigger(n,t,e,this.target,this)))return this.trigger("click",t,e,this.target)},t.prototype.addMenu=function(t){return this._menus.push(t),this.refresh(),this},t.prototype.showPosition=function(t,e,n){this.refresh();var i=$(window).width(),s=this.box.outerWidth();return t=Math.max(0,Math.min(t,i-s)),e=Math.max(0,Math.min(e,$(window).height()-this.box.outerHeight())),this.box.css({left:t+"px",top:e+"px"}).toggleClass("menu-left",i-t+80<2*s).show(),this.target=n,this},t.prototype.hide=function(){this.box.hide(),this.target=null},t.prototype.refresh=function(){this._menuMap={};var t=this.cleanMenuList(this._menus),e=t?this.getMenuHtml(t):"";this.box.html(e)},t.prototype.setChildrenMenu=function(t,e){this._menuMap.hasOwnProperty(t)&&(this._menuMap[t].children=e,this.refresh())},t.prototype.getMenuHtml=function(t){var e=this,n="";return t.forEach(function(t){n+=e.getMenuItemHtml(t)}),"<ul>"+n+"</ul>"},t.prototype.getMenuItemHtml=function(t){var e=t.name||t.text,n='<li data-name="'+e+'"><span>'+(t.icon?'<i class="fa fa-'+t.icon+'"></i>':"")+(t.text||t.name),i=this.cleanMenuList(t.children);return this._menuMap[e]=t,i&&0<i.length?n+'<i class="fa fa-chevron-right"></i></span>'+this.getMenuHtml(i)+"</li>":n+"</span></li>"},t.prototype.cleanMenuList=function(t){var e=this;if(!t||0==t.length)return null;var n=[];return t.forEach(function(t){t.toggle&&!1===t.toggle(e.target,e)||n.push(t)}),n},t}(ChatBaseBox),ChatAddUserBox=function(i){function t(t,e){var n=i.call(this)||this;return n.box=t,n.parent=e,n.bindEvent(),n}return __extends(t,i),Object.defineProperty(t.prototype,"groups",{set:function(t){this._groups=t,this.renderGroup()},enumerable:!0,configurable:!0}),t.prototype.bindEvent=function(){var t=this;this.box.on("click",".dialog-add-action .dialog-yes",function(){t.parent.trigger(EVENT_ADD_USER,t._user,t.find("select").val(),t)})},t.prototype.showWithUser=function(t){this.parent.trigger(EVENT_USER_GROUPS,this),this._user=t,this.refresh(),this.center().show()},t.prototype.refresh=function(){this.find(".dialog-user-avatar img").attr("src",this._user.avatar),this.find(".user-name").text(this._user.name),this.find(".user-breif").text(this._user.brief)},t.prototype.renderGroup=function(){var e='<option value="">选择分组</option>';this._groups.forEach(function(t){e+='<option value="'+t.id+'">'+t.name+"</option>"}),this.find("select").html(e)},t}(ChatBaseBox),ChatUserInfoBox=function(i){function t(t,e){var n=i.call(this)||this;return n.box=t,n.parent=e,n}return __extends(t,i),Object.defineProperty(t.prototype,"user",{set:function(t){this._user=t,this.refresh()},enumerable:!0,configurable:!0}),t.prototype.showWithUser=function(t){this.user=t,this.center().show()},t.prototype.refresh=function(){this.find(".dialog-user-avatar img").attr("src",this._user.avatar),this.find(".user-name").text(this._user.name),this.find(".user-breif").text(this._user.brief)},t}(ChatBaseBox),ChatSearchBox=function(i){function n(t,e){var n=i.call(this)||this;return n.box=t,n.parent=e,n._is_search_user=!0,n._users=[],n.bindEvent(),n}return __extends(n,i),Object.defineProperty(n.prototype,"users",{set:function(t){this._users=t,this.render()},enumerable:!0,configurable:!0}),n.prototype.render=function(){var e="";this._users.forEach(function(t){e+=n.format('<div class="dialog-info" data-id="{3}">\n        <div class="dialog-info-avatar">\n            <img src="{0}" alt="">\n        </div>\n        <div class="dialog-info-name">\n            <h3>{1}</h3>\n            <p>{2}</p>\n        </div>\n    </div>',t.avatar,t.name,t.brief,t.id)}),this.find(".dialog-search-list").html(e)},n.prototype.bindEvent=function(){var e=this;this.box.on("click",".dialog-search-list .dialog-info",function(){var t=e.getUser($(this).data("id"));e.parent.addBox.showWithUser(t)}).on("click",".dialog-tab-header .dialog-tab-item",function(){var t=$(this);t.addClass("active").siblings().removeClass("active"),e._is_search_user=t.index()<1}).on("keyup",".dialog-search input",function(){e.parent.trigger(e._is_search_user?EVENT_SEARCH_USERS:EVENT_SEARCH_GROUPS,$(this).val(),e)})},n.prototype.getUser=function(t){for(var e=0;e<this._users.length;e++)if(this._users[e].id==t)return this._users[e];return null},n}(ChatBaseBox),ChatEditor=function(){function t(t,e){this.box=t,this.parent=e}return t.prototype.html=function(){return this.box.html()},t.prototype.text=function(){return this.box.text()},t.prototype.insertHtmlAtCaret=function(t){var e,n,i=this.box;if(i.is(":focus")||(i.focus(),(n=document.createRange()).setStartAfter(i[0]),n.setEnd(i[0],i[0].childNodes.length)),window.getSelection&&(e=window.getSelection()).getRangeAt&&e.rangeCount){n||(n=e.getRangeAt(0)).deleteContents();var s=document.createElement("div");s.innerHTML=t;for(var r,o,a=document.createDocumentFragment();r=s.firstChild;)o=a.appendChild(r);n.insertNode(a),o&&((n=n.cloneRange()).setStartAfter(o),n.collapse(!0),e.removeAllRanges(),e.addRange(n))}},t}(),ChatMessageBox=function(r){function i(t,e,n,i){var s=r.call(this)||this;return s.box=t,s.parent=e,s.send=n,s.revice=i,s._messages=[],s.refresh(),s.bindEvent(),s}return __extends(i,r),Object.defineProperty(i.prototype,"messages",{set:function(t){this._messages=t,this.renderMessage()},enumerable:!0,configurable:!0}),i.prototype.refresh=function(){this.editor=new ChatEditor(this.find(".dialog-message-text"),this),this.renderTitle()},i.prototype.bindEvent=function(){var t=this;this.box.on("click",".fa-smile-o",function(){t.editor.insertHtmlAtCaret('<img src="./image/avatar.jpg" alt="">')}).on("click",".dailog-message-action button",function(){t.parent.trigger(EVENT_SEND_MESSAGE,t.editor.text(),t.revice,t)}),$(window).resize(function(){t.box.toggleClass("dialog-min",$(window).width()<500),t.center()})},i.prototype.renderTitle=function(){this.revice&&this.find(".dialog-title").html("与 "+this.revice.name+" 聊天中")},i.prototype.addMessage=function(t){this._messages.push(t),this.renderMessage()},i.prototype.prependMessage=function(t){this._messages=t.concat(this._messages),this.renderMessage()},i.prototype.renderMessage=function(){var e=this,n="";this.cleanMessage().forEach(function(t){n+=e.renderMessageItem(t)}),this.find(".dialog-message-box").html(n)},i.prototype.renderMessageItem=function(t){switch(t.type){case ChatType.MORE:return'<p class="message-more">加载更多</p>';case ChatType.TIME:return'<p class="message-line">'+t.content+"</p>";case ChatType.TIP:return'<p class="message-tip">'+t.content+"</p>";case ChatType.MESSAGE:}return t.user.id==this.send.id?i.format('<div class="message-right">\n            <img class="avatar" src="{0}">\n            <div class="content">\n                {1}\n            </div>\n        </div>',t.user.avatar,t.content):i.format('<div class="message-left">\n        <img class="avatar" src="{0}">\n        <div class="content">\n            {1}\n        </div>\n    </div>',t.user.avatar,t.content)},i.prototype.cleanMessage=function(){if(!this._messages||this._messages.length<1)return[];var e=[{type:ChatType.MORE}],n=0;return this._messages.forEach(function(t){200<t.time-n&&(n=t.time,e.push({content:i.date(n)+"",type:ChatType.TIME})),e.push(t)}),e},i.prototype.showWithUser=function(t){this.revice=t,this.renderTitle(),this.center().show(),this.messages=[],this.parent.trigger(EVENT_GET_MESSAGE,t,1,10,this)},i.date=function(t,e){void 0===e&&(e="y年m月d日"),"number"==typeof t&&(t=new Date(1e3*t));var n={"y+":t.getFullYear(),"m+":t.getMonth()+1,"d+":t.getDate(),"h+":t.getHours(),"i+":t.getMinutes(),"s+":t.getSeconds(),"q+":Math.floor((t.getMonth()+3)/3),S:t.getMilliseconds()};for(var i in n)new RegExp("("+i+")").test(e)&&(e=e.replace(RegExp.$1,1==RegExp.$1.length?n[i]:("00"+n[i]).substr((""+n[i]).length)));return e},i}(ChatBaseBox),ChatUserBox=function(i){function s(t,e){var n=i.call(this)||this;return n.box=t,n.parent=e,n._last_friends=[],n.menu=new ChatMenu(n.find(".dialog-menu"),USER_MENU),n.bindEvent(),n}return __extends(s,i),Object.defineProperty(s.prototype,"user",{set:function(t){this._user=t,this.renderUser(),this.refresh()},enumerable:!0,configurable:!0}),Object.defineProperty(s.prototype,"friends",{set:function(t){var e=this;this._friends=t,this.renderFriends(),t.forEach(function(t){t.users.forEach(function(t){t.last_message&&e._last_friends.push(t)})}),this.renderLastFriends(),this.refreshMenu()},enumerable:!0,configurable:!0}),Object.defineProperty(s.prototype,"groups",{set:function(t){var e=this;this._groups=t,this.renderGroup(),t.forEach(function(t){t.last_message&&e._last_friends.push(t)}),this.renderLastFriends()},enumerable:!0,configurable:!0}),s.prototype.refresh=function(){this.parent.trigger(EVENT_REFRESH_USERS,this),this.parent.trigger(EVENT_REFRESH_GROUPS,this)},s.prototype.renderGroup=function(){var e="";this._groups.forEach(function(t){e+=s.format('<div class="dialog-user">\n        <div class="dialog-user-avatar">\n            <img src="{0}" alt="">\n        </div>\n        <div class="dialog-user-info">\n            <p>\n                <span class="name">{1}</span>\n            </p>\n            <p>\n                <span class="content">{2}</span>\n            </p>\n        </div>\n    </div>',t.avatar,t.name,t.brief)}),this.find(".dialog-tab-box .dialog-tab-item").eq(2).html(e)},s.prototype.renderFriends=function(){var n="";this._friends.forEach(function(t){var e="";t.users.forEach(function(t){e+=s.format('<div class="dialog-user">\n            <div class="dialog-user-avatar">\n                <img src="{0}" alt="">\n            </div>\n            <div class="dialog-user-info">\n                <p>\n                    <span class="name">{1}</span>\n                </p>\n                <p>\n                    <span class="content">{2}</span>\n                </p>\n            </div>\n        </div>',t.avatar,t.name,t.brief)}),n+=s.format('\n        <div class="dialog-panel expanded">\n        <div class="dialog-panel-header">\n            <i class="dialog-panel-icon"></i>\n            <span>{0} ({1} / {2})</span>\n        </div>\n        <div class="dialog-panel-box">\n            {3}\n        </div>\n    </div>\n        ',t.name,t.online_count,t.count,e)}),this.find(".dialog-tab-box .dialog-tab-item").eq(1).html(n)},s.prototype.renderLastFriends=function(){var n=this,i="";this._user.new_count=0,this._last_friends.forEach(function(t){var e=t.new_count||0;n._user.new_count+=e,i+=s.format('<div class="dialog-user" data-id="{5}">\n        <div class="dialog-user-avatar">\n            <img src="{0}" alt="">\n        </div>\n        <div class="dialog-user-info">\n            <p>\n                <span class="name">{1}</span>\n                <span class="time">{2}</span>\n            </p>\n            <p>\n                <span class="content">{3}</span>\n                <span class="count">{4}</span>\n            </p>\n        </div>\n    </div>',t.avatar,t.name,ChatMessageBox.date(t.last_message.time),t.last_message.content,e,t.id)}),this.find(".dialog-tab-box .dialog-tab-item").eq(0).html(i),this.renderUser()},s.prototype.renderUser=function(){this.find(".dialog-info").html(s.format('<div class="dialog-info-avatar">\n        <img src="{0}" alt="">\n    </div>\n    <div class="dialog-info-name">\n        <h3>{1}</h3>\n        <p>{2}</p>\n    </div>\n    <div class="dialog-message-count">\n    {3}\n    </div>',this._user.avatar,this._user.name,this._user.brief,this._user.new_count))},s.prototype.bindEvent=function(){var i=this;$(document).click(function(){i.menu&&i.menu.hide()}),this.box.click(function(){$(this).hasClass("dialog-min")&&$(this).removeClass("dialog-min")}).on("click",".dialog-header .fa-minus",function(t){t.stopPropagation(),i.box.addClass("dialog-min")}).on("click",".dialog-header .fa-plus",function(){i.parent.searchBox.center().show()}).on("click",".dialog-tab .dialog-tab-header .dialog-tab-item",function(){var t=$(this);t.addClass("active").siblings().removeClass("active"),t.closest(".dialog-tab").find(".dialog-tab-box .dialog-tab-item").eq(t.index()).addClass("active").siblings().removeClass("active")}).on("click",".dialog-panel .dialog-panel-header",function(){$(this).closest(".dialog-panel").toggleClass("expanded")}).on("click",".dialog-tab .dialog-user",function(){i.parent.chatBox.showWithUser(i.getUser($(this).data("id")))}).on("contextmenu",".dialog-tab .dialog-user",function(t){return i.menu&&i.menu.showPosition(t.clientX,t.clientY,$(this)),!1}),this.menu.on("click",function(t,e,n){"view"==e.name&&i.parent.userBox.showWithUser(i.getUser(n.data("id")))}),this.parent.on(EVENT_USER_GROUPS,function(t){t.groups=i._friends})},s.prototype.refreshMenu=function(){var e=[];this._friends.forEach(function(t){e.push({name:"group-"+t.id,text:t.name})}),this.menu.setChildrenMenu("move",e)},s.prototype.getUser=function(t){for(var e=0;e<this._last_friends.length;e++)if(this._last_friends[e].id==t)return this._last_friends[e]},s}(ChatBaseBox),ChatRoom=function(){function t(t){this.target=t,this._events={}}return t.prototype.on=function(t,e){return this._events[t]=e,this},t.prototype.hasEvent=function(t){return this._events.hasOwnProperty(t)},t.prototype.trigger=function(t){for(var e,n=[],i=1;i<arguments.length;i++)n[i-1]=arguments[i];if(this.hasEvent(t))return(e=this._events[t]).call.apply(e,[this].concat(n))},t.prototype.init=function(t){this.mainBox=new ChatUserBox(this.target.find(".dialog-chat-box"),this),this.addBox=new ChatAddUserBox(this.target.find(".dialog-add-box"),this),this.userBox=new ChatUserInfoBox(this.target.find(".dialog-user-box"),this),this.searchBox=new ChatSearchBox(this.target.find(".dialog-search-box"),this),this.chatBox=new ChatMessageBox(this.target.find(".dialog-chat-room"),this,t),this.mainBox.user=t},t.prototype.toggleMode=function(){return this.target.hasClass("dialog-fixed")?this.page():this.fixed()},t.prototype.fixed=function(){return this.target.addClass("dialog-fixed").removeClass("dialog-chat-page"),this},t.prototype.page=function(){return this.target.removeClass("dialog-fixed").addClass("dialog-chat-page"),this},t}(),USER_MENU=[{name:"view",icon:"eye",text:"查看资料"},{name:"move",icon:"bookmark",text:"移动好友"},{name:"remove",icon:"trash",text:"删除好友"}],TEST_USER={id:2,name:"123123",brief:"12313",avatar:"/assets/images/avatar/14.png",new_count:1,last_message:{content:"123123",time:1510601234,type:ChatType.MESSAGE}},TEST_SEND={id:1,name:"admin",brief:"1111",avatar:"/assets/images/avatar/1.png",new_count:1},TEST_GROUP={id:1,name:"我的好友",count:2,online_count:1,users:[TEST_SEND,TEST_USER]},TEST_MESSAGE={content:"123123",time:1510601234,type:ChatType.MESSAGE,user:TEST_USER};function registerChat(s){var t=new ChatRoom($(".dialog-chat"));t.on(EVENT_REFRESH_USERS,function(e){postJson(s+"friend",function(t){200==t.code&&(e.friends=[TEST_GROUP])})}).on(EVENT_REFRESH_GROUPS,function(e){postJson(s+"group",function(t){200==t.code&&(e.groups=[TEST_USER])})}).on(EVENT_SEARCH_USERS,function(t,e){postJson(s+"friend/search",{keywords:t},function(t){200==t.code&&(e.users=[TEST_USER])})}).on(EVENT_GET_MESSAGE,function(t,e,n,i){postJson(s+"friend/message",{user:t.id,page:e,per_page:n},function(t){200==t.code&&(i.messages=[TEST_MESSAGE])})}).on(EVENT_SEND_MESSAGE,function(e,t,n){postJson(s+"friend/send_message",{user:t.id,content:e},function(t){200==t.code&&n.addMessage({content:e,type:ChatType.MESSAGE,user:TEST_SEND})})}).on(EVENT_ADD_USER,function(t,e,n){postJson(s+"friend/apply",{user:t.id,group:e},function(t){200==t.code&&n.hide()})}).init(TEST_SEND),$(".dialog-box").on("click",".dialog-header .fa-close",function(){$(this).closest(".dialog-box").hide()}),$("#toggle-btn").click(function(){t.toggleMode()})}