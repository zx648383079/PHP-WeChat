var ChatType,WsMessageType,__extends=this&&this.__extends||function(){var i=function(t,e){return(i=Object.setPrototypeOf||({__proto__:[]}instanceof Array?function(t,e){t.__proto__=e}:function(t,e){for(var n in e)Object.prototype.hasOwnProperty.call(e,n)&&(t[n]=e[n])}))(t,e)};return function(t,e){if("function"!=typeof e&&null!==e)throw new TypeError("Class extends value "+String(e)+" is not a constructor or null");function n(){this.constructor=t}i(t,e),t.prototype=null===e?Object.create(e):(n.prototype=e.prototype,new n)}}(),__spreadArray=this&&this.__spreadArray||function(t,e,n){if(n||2===arguments.length)for(var i,s=0,o=e.length;s<o;s++)!i&&s in e||((i=i||Array.prototype.slice.call(e,0,s))[s]=e[s]);return t.concat(i||Array.prototype.slice.call(e))},EVENT_REFRESH_USERS=(!function(t){t[t.MESSAGE=0]="MESSAGE",t[t.MORE=1]="MORE",t[t.TIP=2]="TIP",t[t.TIME=3]="TIME"}(ChatType=ChatType||{}),"refresh_users"),EVENT_REFRESH_GROUPS="refresh_groups",EVENT_GROUP_USERS="refresh_group_users",EVENT_USER_GROUPS="user_groups",EVENT_USER_INFO="user_info",EVENT_GROUP_INFO="group_info",EVENT_SEARCH_USERS="search_users",EVENT_SEARCH_GROUPS="search_groups",EVENT_APPLY_USERS="apply_users",EVENT_ADD_USER="add_user",EVENT_APPLY_USER="apply_user",EVENT_SEND_MESSAGE="send_message",EVENT_GET_MESSAGE="get_message",HTML_MAIN='<div class="dialog-box dialog-chat-box">\n    <div class="dialog-header">\n        <div class="dialog-action">\n            <i class="fa fa-plus"></i>\n            <i class="fa fa-minus"></i>\n            <i class="fa fa-close"></i>\n        </div>\n    </div>\n    <div class="dialog-info">\n        <div class="dialog-info-avatar">\n            <img src="" alt="">\n        </div>\n        <div class="dialog-info-name">\n            <h3></h3>\n            <p>......</p>\n        </div>\n        <div class="dialog-message-count">\n            99\n        </div>\n    </div>\n    <div class="dialog-tab">\n        <div class="dialog-tab-header">\n            <div class="dialog-tab-item active">\n                <i class="fa fa-comment"></i>\n            </div><div class="dialog-tab-item">\n                <i class="fa fa-user"></i>\n            </div><div class="dialog-tab-item">\n                <i class="fa fa-comments"></i>\n            </div>\n        </div>\n        <div class="dialog-tab-box">\n            <div class="dialog-tab-item active">\n            </div>\n            <div class="dialog-tab-item">\n            </div>\n            <div class="dialog-tab-item">\n            </div>\n        </div>\n    </div>\n    <div class="dialog-menu">\n        <ul>\n            <li>\n                <i class="fa fa-eye"></i>\n                查看资料</li>\n            <li>\n                <i class="fa fa-bookmark"></i>\n                移动好友</li>\n            <li>\n                <i class="fa fa-trash"></i>\n                删除好友</li>\n        </ul>\n    </div>\n</div>',HTML_ROOM='<div class="dialog-box dialog-chat-room">\n    <div class="dialog-header">\n        <div class="dialog-title">与 xx 聊天中</div>\n        <div class="dialog-action">\n            <i class="fa fa-minus"></i>\n            <i class="fa fa-close"></i>\n        </div>\n    </div>\n    <div class="dialog-message-box">\n        \n    </div>\n    <div class="dialog-message-tools">\n        <i class="fa fa-smile"></i>\n        <i class="fa fa-image"></i>\n        <i class="fa fa-camera"></i>\n        <i class="fa fa-video"></i>\n        <i class="fa fa-file"></i>\n        <i class="fa fa-gift"></i>\n    </div>\n    <div class="dialog-message-editor">\n        <div class="dialog-message-text" contenteditable="true">\n\n        </div>\n        <div class="dailog-message-action">\n            <button>发送</button>\n        </div>\n    </div>\n</div>',HTML_SEARCH_USER='<div class="dialog-box dialog-search-box">\n    <div class="dialog-header">\n        <div class="dialog-title dialog-tab-header">\n            <div class="dialog-tab-item active">找人</div>\n            <div class="dialog-tab-item">找群</div>\n        </div>\n        <div class="dialog-action">\n            <i class="fa fa-close"></i>\n        </div>\n    </div>\n    <div class="dialog-search">\n        <input type="text">\n        <i class="fa fa-search"></i>\n    </div>\n    <div class="dialog-search-list">\n    </div>\n</div>',HTML_USER_INFO='<div class="dialog-box dialog-user-box">\n    <div class="dialog-header">\n        <div class="dialog-action">\n            <i class="fa fa-close"></i>\n        </div>\n    </div>\n    <div class="dialog-user-avatar">\n        <img src="./image/avatar.jpg" alt="">\n    </div>\n    <h3 class="user-name">1231</h3>\n    <div class="dialog-user-info">\n        <p class="user-brief">123123</p>\n        <p>123123</p>\n        <p>123123</p>\n    </div>\n</div>',HTML_APPLY='<div class="dialog-box dialog-apply-box">\n    <div class="dialog-header">\n        <div class="dialog-action">\n            <i class="fa fa-close"></i>\n        </div>\n    </div>\n    <div class="dialog-user-avatar">\n        <img src="./image/avatar.jpg" alt="">\n    </div>\n    <h3 class="user-name">1231</h3>\n    <div class="dialog-add-action">\n        <textarea name="" placeholder="我是123123"></textarea>\n        <select name="" id="">\n            <option value="">选择分组</option>\n        </select>\n        <button class="dialog-yes">申请</button>\n    </div>\n</div>',HTML_AGREE_APPLY='<div class="dialog-box dialog-add-box">\n    <div class="dialog-header">\n        <div class="dialog-action">\n            <i class="fa fa-close"></i>\n        </div>\n    </div>\n    <div class="dialog-user-avatar">\n        <img src="./image/avatar.jpg" alt="">\n    </div>\n    <h3 class="user-name">1231</h3>\n    <p class="user-brief">留言</p>\n    <div class="dialog-add-action">\n        <select name="" id="">\n            <option value="">选择分组</option>\n        </select>\n        <button class="dialog-yes">同意</button>\n        <button>拒绝</button>\n    </div>\n</div>',HTML_APPLY_LOG='<div class="dialog-box dialog-apply-log-box">\n    <div class="dialog-header">\n        <div class="dialog-title">验证消息</div>\n        <div class="dialog-action">\n            <i class="fa fa-close"></i>\n        </div>\n    </div>\n    <div class="dialog-apply-list">\n        <div class="dialog-info" data-id="2">\n            <div class="dialog-info-avatar">\n                <img src="http://zodream.localhost/assets/images/avatar/18.png" alt="">\n            </div>\n            <div class="dialog-info-name">\n                <h3>1606282309</h3>\n                <p>附加消息：123</p>\n            </div>\n            <div class="dialog-action">\n                <button>同意</button>\n                <button>忽略</button>\n            </div>\n        </div>\n    </div>\n</div>',ChatBaseBox=function(){function t(){this.cache_element={}}return t.prototype.find=function(t){return this.cache_element.hasOwnProperty(t)?this.cache_element[t]:this.cache_element[t]=this.box.find(t)},t.prototype.show=function(){return this.box.show(),this},t.prototype.center=function(){return this.box.css({left:Math.max(0,($(window).width()-this.box.outerWidth())/2)+"px",top:Math.max(0,($(window).height()-this.box.outerHeight())/2)+"px"}),this},t.prototype.hide=function(){this.box.hide()},t.format=function(t){for(var n=[],e=1;e<arguments.length;e++)n[e-1]=arguments[e];return t.replace(/\{(\d+)\}/g,function(t,e){return n[e]})},t}(),ChatMenu=function(i){function t(t,e){var n=i.call(this)||this;return n.box=t,n._menus=[],n._events={},n.bindEvent(),n.menus=e,n}return __extends(t,i),Object.defineProperty(t.prototype,"menus",{set:function(t){this._menus=t,this.refresh()},enumerable:!1,configurable:!0}),t.prototype.on=function(t,e){return this._events[t]=e,this},t.prototype.hasEvent=function(t){return this._events.hasOwnProperty(t)},t.prototype.trigger=function(t){for(var e=[],n=1;n<arguments.length;n++)e[n-1]=arguments[n];if(this.hasEvent(t))return(t=this._events[t]).call.apply(t,__spreadArray([this],e,!1))},t.prototype.bindEvent=function(){var e=this;this.box.on("click","li",function(t){!1===e.clickLi($(this))&&t.stopPropagation()})},t.prototype.clickLi=function(t){var e,n=t.attr("data-name");if(!(n&&this._menuMap.hasOwnProperty(n)&&(e=this._menuMap[n])&&e.onclick&&!1===e.onclick(t,this.target,this)||n&&this.hasEvent(n)&&!1===this.trigger(n,t,e,this.target,this)))return this.trigger("click",t,e,this.target)},t.prototype.addMenu=function(t){return this._menus.push(t),this.refresh(),this},t.prototype.showPosition=function(t,e,n){this.refresh();var i=$(window).width(),s=this.box.outerWidth();return t=Math.max(0,Math.min(t,i-s)),e=Math.max(0,Math.min(e,$(window).height()-this.box.outerHeight())),this.box.css({left:t+"px",top:e+"px"}).toggleClass("menu-left",i-t+80<2*s).show(),this.target=n,this},t.prototype.hide=function(){this.box.hide(),this.target=null},t.prototype.refresh=function(){this._menuMap={};var t=this.cleanMenuList(this._menus),t=t?this.getMenuHtml(t):"";this.box.html(t)},t.prototype.setChildrenMenu=function(t,e){this._menuMap.hasOwnProperty(t)&&(this._menuMap[t].children=e,this.refresh())},t.prototype.getMenuHtml=function(t){var e=this,n="";return t.forEach(function(t){n+=e.getMenuItemHtml(t)}),"<ul>"+n+"</ul>"},t.prototype.getMenuItemHtml=function(t){var e=t.name||t.text,n='<li data-name="'+e+'"><span>'+(t.icon?'<i class="fa fa-'+t.icon+'"></i>':"")+(t.text||t.name),i=this.cleanMenuList(t.children);return this._menuMap[e]=t,i&&0<i.length?n+'<i class="fa fa-chevron-right"></i></span>'+this.getMenuHtml(i)+"</li>":n+"</span></li>"},t.prototype.cleanMenuList=function(t){var e,n=this;return t&&0!=t.length?(e=[],t.forEach(function(t){t.toggle&&!1===t.toggle(n.target,n)||e.push(t)}),e):null},t}(ChatBaseBox),ChatAddUserBox=function(n){function t(t){var e=n.call(this)||this;return e.parent=t,e}return __extends(t,n),Object.defineProperty(t.prototype,"groups",{set:function(t){this._groups=t,this.renderGroup()},enumerable:!1,configurable:!0}),t.prototype.bindEvent=function(){var t=this;this.box.on("click",".dialog-add-action .dialog-yes",function(){t.parent.trigger(EVENT_ADD_USER,t._user,t.find("select").val(),t)})},t.prototype.render=function(){this.box||(this.box=this.parent.append(HTML_AGREE_APPLY),this.bindEvent())},t.prototype.showWithUser=function(t){this.render(),this.parent.trigger(EVENT_USER_GROUPS,this),this._user=t.applier||t.user,this.refresh(),this.center().show()},t.prototype.refresh=function(){this.find(".dialog-user-avatar img").attr("src",this._user.avatar),this.find(".user-name").text(this._user.name),this.find(".user-breif").text(this._user.brief)},t.prototype.renderGroup=function(){var e='<option value="">选择分组</option>';this._groups.forEach(function(t){e+='<option value="'+t.id+'">'+t.name+"</option>"}),this.find("select").html(e)},t}(ChatBaseBox),ChatApplyBox=function(n){function t(t){var e=n.call(this,t)||this;return e.parent=t,e}return __extends(t,n),t.prototype.bindEvent=function(){var t=this;this.box.on("click",".dialog-add-action .dialog-yes",function(){t.parent.trigger(EVENT_APPLY_USER,t._user,t.find("select").val(),t.find("textarea").val(),t)})},t.prototype.render=function(){this.box||(this.box=this.parent.append(HTML_APPLY),this.bindEvent())},t}(ChatAddUserBox),ChatUserInfoBox=function(n){function t(t){var e=n.call(this)||this;return e.parent=t,e}return __extends(t,n),Object.defineProperty(t.prototype,"user",{get:function(){return this._user},set:function(t){this._user=t,this.refresh()},enumerable:!1,configurable:!0}),t.prototype.showWithUser=function(t){this.box||(this.box=this.parent.append(HTML_USER_INFO)),this.user=t,this.center().show()},t.prototype.refresh=function(){this.find(".dialog-user-avatar img").attr("src",this._user.user.avatar),this.find(".user-name").text(this._user.name),this.find(".user-breif").text(this._user.user.brief)},t}(ChatBaseBox),ChatApplyLogBox=function(n){function t(t){var e=n.call(this)||this;return e.parent=t,e._users=[],e}return __extends(t,n),Object.defineProperty(t.prototype,"users",{set:function(t){this._users=t,this.render()},enumerable:!1,configurable:!0}),t.prototype.showWithRefresh=function(){this.box||(this.box=this.parent.append(HTML_APPLY_LOG),this.bindEvent()),this.parent.trigger(EVENT_APPLY_USERS,this),this.show()},t.prototype.render=function(){var e="";this._users.forEach(function(t){e+=ChatSearchBox.format('<div class="dialog-info" data-id="{0}">\n        <div class="dialog-info-avatar">\n            <img src="{1}" alt="">\n        </div>\n        <div class="dialog-info-name">\n            <h3>{2}</h3>\n            <p>附加消息：{3}</p>\n        </div>\n        <div class="dialog-action">\n            <button>同意</button>\n            <button>忽略</button>\n        </div>\n    </div>',t.id,t.applier.avatar,t.applier.name,t.remark||"")}),this.find(".dialog-apply-list").html(e)},t.prototype.bindEvent=function(){var e=this;this.box.on("click",".dialog-apply-list .dialog-info",function(){var t=e.getUser($(this).data("id"));e.parent.addBox.showWithUser(t)})},t.prototype.getUser=function(t){for(var e=0;e<this._users.length;e++)if(this._users[e].id==t)return this._users[e];return null},t}(ChatBaseBox),ChatSearchBox=function(n){function i(t){var e=n.call(this)||this;return e.parent=t,e._is_search_user=!0,e._users=[],e}return __extends(i,n),Object.defineProperty(i.prototype,"users",{set:function(t){this._users=t,this.render()},enumerable:!1,configurable:!0}),i.prototype.render=function(){var e="";this._users.forEach(function(t){e+=i.format('<div class="dialog-info" data-id="{3}">\n        <div class="dialog-info-avatar">\n            <img src="{0}" alt="">\n        </div>\n        <div class="dialog-info-name">\n            <h3>{1}</h3>\n            <p>{2}</p>\n        </div>\n    </div>',t.avatar,t.name,t.brief||"",t.id)}),this.find(".dialog-search-list").html(e)},i.prototype.bindEvent=function(){var e=this;this.box.on("click",".dialog-search-list .dialog-info",function(){var t=e.getUser($(this).data("id"));e.parent.applyBox.showWithUser({user:t,id:0,remark:""})}).on("click",".dialog-tab-header .dialog-tab-item",function(){var t=$(this);t.addClass("active").siblings().removeClass("active"),e._is_search_user=t.index()<1}).on("keyup",".dialog-search input",function(){e.parent.trigger(e._is_search_user?EVENT_SEARCH_USERS:EVENT_SEARCH_GROUPS,$(this).val(),e)})},i.prototype.getUser=function(t){for(var e=0;e<this._users.length;e++)if(this._users[e].id==t)return this._users[e];return null},i.prototype.renderBox=function(){this.box||(this.box=this.parent.append(HTML_SEARCH_USER),this.bindEvent())},i.prototype.showCenter=function(){this.renderBox(),this.center().show()},i.prototype.show=function(){return this.renderBox(),this.box.show(),this},i}(ChatBaseBox),ChatEditor=function(){function t(t,e){this.box=t,this.parent=e}return t.prototype.html=function(){return this.box.html()},t.prototype.clear=function(){return this.box.html(""),this},t.prototype.text=function(){return this.box.text()},t.prototype.insertHtmlAtCaret=function(t){var e,n,i=this.box;if(i.is(":focus")||(i.focus(),(n=document.createRange()).setStartAfter(i[0]),n.setEnd(i[0],i[0].childNodes.length)),window.getSelection&&(e=window.getSelection()).getRangeAt&&e.rangeCount){n||(n=e.getRangeAt(0)).deleteContents();for(var s,o,a=document.createElement("div"),r=(a.innerHTML=t,document.createDocumentFragment());s=a.firstChild;)o=r.appendChild(s);n.insertNode(r),o&&((n=n.cloneRange()).setStartAfter(o),n.collapse(!0),e.removeAllRanges(),e.addRange(n))}},t}(),ChatMessageBox=function(s){function i(t,e,n){var i=s.call(this)||this;return i.parent=t,i.send=e,i.revice=n,i._messages=[],i.box=i.parent.append(HTML_ROOM),i.refresh(),i.bindEvent(),i}return __extends(i,s),Object.defineProperty(i.prototype,"messages",{set:function(t){this._messages=t,this.renderMessage()},enumerable:!1,configurable:!0}),i.prototype.refresh=function(){this.editor=new ChatEditor(this.find(".dialog-message-text"),this),this.renderTitle()},i.prototype.bindEvent=function(){var t=this;this.box.on("click",".fa-smile-o",function(){t.editor.insertHtmlAtCaret('<img src="./image/avatar.jpg" alt="">')}).on("click",".dailog-message-action button",function(){t.parent.trigger(EVENT_SEND_MESSAGE,t.editor.text(),t.revice.user,t)}),$(window).resize(function(){t.parent.isFixed()?(t.box.toggleClass("dialog-min",$(window).width()<500),t.center()):t.box.removeAttr("style")})},i.prototype.renderTitle=function(){this.revice&&this.find(".dialog-title").html("与 "+this.revice.name+" 聊天中")},i.prototype.addMessage=function(t){this._messages.push(t),this.renderMessage()},i.prototype.appendMessage=function(t){this._messages=this._messages.concat(t),this.renderMessage()},i.prototype.prependMessage=function(t){this._messages=t.concat(this._messages),this.renderMessage()},i.prototype.renderMessage=function(){var e=this,n="";this.cleanMessage().forEach(function(t){n+=e.renderMessageItem(t)}),this.find(".dialog-message-box").html(n)},i.prototype.renderMessageItem=function(t){switch(t.type){case ChatType.MORE:return'<p class="message-more">加载更多</p>';case ChatType.TIME:return'<p class="message-line">'+t.content+"</p>";case ChatType.TIP:return'<p class="message-tip">'+t.content+"</p>";case ChatType.MESSAGE:}return t.user.id==this.send.id?i.format('<div class="message-right">\n            <img class="avatar" src="{0}">\n            <div class="content">\n                {1}\n            </div>\n        </div>',t.user.avatar,t.content):i.format('<div class="message-left">\n        <img class="avatar" src="{0}">\n        <div class="content">\n            {1}\n        </div>\n    </div>',t.user.avatar,t.content)},i.prototype.cleanMessage=function(){var e,n;return!this._messages||this._messages.length<1?[]:(e=[{type:ChatType.MORE}],n=0,this._messages.forEach(function(t){200<t.time-n&&(n=t.time,e.push({content:i.date(n)+"",type:ChatType.TIME})),e.push(t)}),e)},i.prototype.showWithUser=function(t){this.revice=t,this.renderTitle(),this.parent.isFixed()&&this.center(),this.show(),this.messages=[],this.parent.trigger(EVENT_GET_MESSAGE,t.user,1,10,this)},i.date=function(t,e){void 0===e&&(e="y年m月d日");var n,i={"y+":(t="number"==typeof t?new Date(1e3*t):t).getFullYear(),"m+":t.getMonth()+1,"d+":t.getDate(),"h+":t.getHours(),"i+":t.getMinutes(),"s+":t.getSeconds(),"q+":Math.floor((t.getMonth()+3)/3),S:t.getMilliseconds()};for(n in i)new RegExp("("+n+")").test(e)&&(e=e.replace(RegExp.$1,1==RegExp.$1.length?i[n]:("00"+i[n]).substr((""+i[n]).length)));return e},i}(ChatBaseBox),ChatUserBox=function(n){function s(t){var e=n.call(this)||this;return e.parent=t,e._last_friends=[],e._friends=[],e.box=e.parent.append(HTML_MAIN),e.menu=new ChatMenu(e.find(".dialog-menu"),USER_MENU),e.bindEvent(),e}return __extends(s,n),Object.defineProperty(s.prototype,"user",{get:function(){return this._user},set:function(t){this._user=t,this.renderUser(),this.refresh()},enumerable:!1,configurable:!0}),Object.defineProperty(s.prototype,"friends",{set:function(t){var e=this;this._friends=t,this.renderFriends(),t.forEach(function(t){t.users.forEach(function(t){t.last_message&&e._last_friends.push(t)})}),this.renderLastFriends(),this.refreshMenu()},enumerable:!1,configurable:!0}),Object.defineProperty(s.prototype,"groups",{set:function(t){this._groups=t,this.renderGroup(),this.renderLastFriends()},enumerable:!1,configurable:!0}),s.prototype.refresh=function(){this.parent.trigger(EVENT_REFRESH_USERS,this),this.parent.trigger(EVENT_REFRESH_GROUPS,this)},s.prototype.renderGroup=function(){var e="";this._groups.forEach(function(t){e+=s.format('<div class="dialog-user">\n        <div class="dialog-user-avatar">\n            <img src="{0}" alt="">\n        </div>\n        <div class="dialog-user-info">\n            <p>\n                <span class="name">{1}</span>\n            </p>\n            <p>\n                <span class="content">{2}</span>\n            </p>\n        </div>\n    </div>',t.cover,t.name,t.brief)}),this.find(".dialog-tab-box .dialog-tab-item").eq(2).html(e)},s.prototype.renderFriends=function(){var n="";this._friends.forEach(function(t){var e="";t.users.forEach(function(t){e+=s.format('<div class="dialog-user" data-id="{3}">\n            <div class="dialog-user-avatar">\n                <img src="{0}" alt="">\n            </div>\n            <div class="dialog-user-info">\n                <p>\n                    <span class="name">{1}</span>\n                </p>\n                <p>\n                    <span class="content">{2}</span>\n                </p>\n            </div>\n        </div>',t.user.avatar,t.name,t.user.brief||"",t.id)}),n+=s.format('\n        <div class="dialog-panel expanded">\n        <div class="dialog-panel-header">\n            <i class="dialog-panel-icon"></i>\n            <span>{0} ({1} / {2})</span>\n        </div>\n        <div class="dialog-panel-box">\n            {3}\n        </div>\n    </div>\n        ',t.name,t.online_count,t.count,e)}),this.find(".dialog-tab-box .dialog-tab-item").eq(1).html(n)},s.prototype.renderLastFriends=function(){var n=this,i="";this._user.new_count=0,this._last_friends.forEach(function(t){var e=t.new_count||0;n._user.new_count+=e,i+=s.format('<div class="dialog-user" data-id="{5}">\n        <div class="dialog-user-avatar">\n            <img src="{0}" alt="">\n        </div>\n        <div class="dialog-user-info">\n            <p>\n                <span class="name">{1}</span>\n                <span class="time">{2}</span>\n            </p>\n            <p>\n                <span class="content">{3}</span>\n                <span class="count">{4}</span>\n            </p>\n        </div>\n    </div>',t.user.avatar,t.name,ChatMessageBox.date(t.last_message.time),t.last_message.content,e,t.id)}),this.find(".dialog-tab-box .dialog-tab-item").eq(0).html(i),this.renderUser()},s.prototype.renderUser=function(){this.find(".dialog-info").html(s.format('<div class="dialog-info-avatar">\n        <img src="{0}" alt="">\n    </div>\n    <div class="dialog-info-name">\n        <h3>{1}</h3>\n        <p>{2}</p>\n    </div>\n    <div class="dialog-message-count">\n    {3}\n    </div>',this._user.avatar,this._user.name,this._user.brief,this._user.new_count))},s.prototype.bindEvent=function(){var i=this;$(document).on("click",function(){i.menu&&i.menu.hide()}),this.box.click(function(){$(this).hasClass("dialog-min")&&$(this).removeClass("dialog-min")}).on("click",".dialog-header .fa-minus",function(t){t.stopPropagation(),i.box.addClass("dialog-min")}).on("click",".dialog-header .fa-plus",function(){i.parent.searchBox.showCenter()}).on("click",".dialog-tab .dialog-tab-header .dialog-tab-item",function(){var t=$(this);t.addClass("active").siblings().removeClass("active"),t.closest(".dialog-tab").find(".dialog-tab-box .dialog-tab-item").eq(t.index()).addClass("active").siblings().removeClass("active")}).on("click",".dialog-panel .dialog-panel-header",function(){$(this).closest(".dialog-panel").toggleClass("expanded")}).on("click",".dialog-tab .dialog-user",function(){var t=$(this).data("id");t&&i.parent.chatBox.showWithUser(i.getUser(t))}).on("contextmenu",".dialog-tab .dialog-user",function(t){return i.menu&&i.menu.showPosition(t.clientX,t.clientY,$(this)),!1}),this.menu.on("click",function(t,e,n){"view"==e.name&&i.parent.userBox.showWithUser(i.getUser(n.data("id")))}),this.parent.on(EVENT_USER_GROUPS,function(t){t.groups=i._friends})},s.prototype.refreshMenu=function(){var e=[];this._friends.forEach(function(t){e.push({name:"group-"+t.id,text:t.name})}),this.menu.setChildrenMenu("move",e)},s.prototype.getUser=function(t){for(var e=0,n=this._last_friends;e<n.length;e++)if((o=n[e]).id==t)return o;for(var i=0,s=this._friends;i<s.length;i++)for(var o,a=0,r=s[i].users;a<r.length;a++)if((o=r[a]).id==t)return o},s}(ChatBaseBox),ChatRoom=function(){function t(t){this.target=t,this._events={},this.target&&0<this.target.length||(this.target=$('<div class="dialog-chat dialog-fixed"></div>'),$(document.body).append(this.target))}return t.prototype.on=function(t,e){return this._events[t]=e,this},t.prototype.hasEvent=function(t){return this._events.hasOwnProperty(t)},t.prototype.trigger=function(t){for(var e=[],n=1;n<arguments.length;n++)e[n-1]=arguments[n];if(this.hasEvent(t))return(t=this._events[t]).call.apply(t,__spreadArray([this],e,!1))},t.prototype.init=function(t){this.mainBox=new ChatUserBox(this),this.addBox=new ChatAddUserBox(this),this.applyBox=new ChatApplyBox(this),this.userBox=new ChatUserInfoBox(this),this.applyLogBox=new ChatApplyLogBox(this),this.searchBox=new ChatSearchBox(this),this.chatBox=new ChatMessageBox(this,t),this.mainBox.user=t},t.prototype.find=function(t){return this.target.find(t)},t.prototype.append=function(t){t=$(t);return this.target.append(t),t},t.prototype.isFixed=function(){return this.target.hasClass("dialog-fixed")},t.prototype.toggleMode=function(){return this.isFixed()?this.page():this.fixed()},t.prototype.fixed=function(){return this.target.addClass("dialog-fixed").removeClass("dialog-chat-page"),this.chatBox.center(),this},t.prototype.page=function(){return this.target.removeClass("dialog-fixed").addClass("dialog-chat-page"),this.chatBox.box.removeAttr("style"),this},t}(),USER_MENU=[{name:"view",icon:"eye",text:"查看资料"},{name:"move",icon:"bookmark",text:"移动好友"},{name:"remove",icon:"trash",text:"删除好友"}];function registerChat(){var n,i=new ChatRoom($(".dialog-chat")),s=(i.on(EVENT_REFRESH_USERS,function(e){postJson(BASE_URI+"friend",function(t){200==t.code&&(e.friends=t.data)})}).on(EVENT_REFRESH_GROUPS,function(e){postJson(BASE_URI+"group",function(t){200==t.code&&(e.groups=t.data)})}).on(EVENT_SEARCH_USERS,function(t,e){postJson(BASE_URI+"friend/search",{keywords:t},function(t){200==t.code&&(e.users=t.data.data)})}).on(EVENT_GET_MESSAGE,function(t,e,n,i){postJson(BASE_URI+"friend/message",{user:t.id,page:e,per_page:n},function(t){200==t.code&&(i.messages=t.data.data)})}).on(EVENT_SEND_MESSAGE,function(e,t,n){postJson(BASE_URI+"friend/send_message",{user:t.id,content:e},function(t){200==t.code&&(n.addMessage({content:e,type:ChatType.MESSAGE,user:i.mainBox.user}),n.editor.clear())})}).on(EVENT_APPLY_USER,function(t,e,n,i){postJson(BASE_URI+"friend/apply",{user:t.id,group:e,remark:n},function(t){200==t.code&&i.hide()})}).on(EVENT_ADD_USER,function(t,e,n){postJson(BASE_URI+"friend/agree",{user:t.id,name:t.name,group:e},function(t){200==t.code&&n.hide()})}).on(EVENT_APPLY_USERS,function(e){postJson(BASE_URI+"friend/apply_log",function(t){200==t.code&&(e.users=t.data)})}),postJson(BASE_URI+"user",function(t){200===t.code&&(i.init(t.data),s())}),i.target.on("click",".dialog-header .fa-close",function(){$(this).closest(".dialog-box").hide()}),$("#toggle-btn").on("click",function(){i.toggleMode()}),function(){postJson(BASE_URI+"message/ping",{time:n||0,user:i.chatBox.revice?i.chatBox.revice.id:0},function(t){var e;200===t.code&&(e=t.data,o("message_count",e.message),0<e.apply&&o("apply"),e.messages&&0<e.messages.length&&o("message",e.messages),n=t.data.time),setTimeout(s,1e4)})}),o=function(t,e){"message_count"===t?i.mainBox.user.new_count=e:"apply"===t?i.applyLogBox.showWithRefresh():"message"===t&&i.chatBox.appendMessage(e)}}function registerWsChat(t){var e=new ChatRoom($(".dialog-chat")),s=new Ws(t);s.onConnect(function(){}).onDisconnect(function(){}).on("message",function(){}),e.on(EVENT_REFRESH_USERS,function(t){s.emit(EVENT_REFRESH_USERS,!0)}).on(EVENT_REFRESH_GROUPS,function(t){s.emit(EVENT_REFRESH_GROUPS,!0)}).on(EVENT_SEARCH_USERS,function(t,e){s.emit(EVENT_SEARCH_USERS,t)}).on(EVENT_GET_MESSAGE,function(t,e,n,i){s.emit(EVENT_GET_MESSAGE,{page:e,per_page:n,user:t.id})}).on(EVENT_SEND_MESSAGE,function(t,e,n){s.emit(EVENT_SEND_MESSAGE,{content:t,user:e.id})}).on(EVENT_APPLY_USER,function(t,e,n,i){postJson(BASE_URI+"friend/apply",{user:t.id,group:e,remark:n},function(t){200==t.code&&i.hide()})}).on(EVENT_ADD_USER,function(t,e,n){postJson(BASE_URI+"friend/agree",{user:t.id,group:e},function(t){200==t.code&&n.hide()})}),$(".dialog-box").on("click",".dialog-header .fa-close",function(){$(this).closest(".dialog-box").hide()}),$("#toggle-btn").on("click",function(){e.toggleMode()})}!function(t){t[t.STRING=0]="STRING",t[t.INT=1]="INT",t[t.BOOL=2]="BOOL",t[t.JSON=4]="JSON"}(WsMessageType=WsMessageType||{});var Ws=function(){function t(t,e){var n=this;if(this.option={prefix:"ws-message:",separator:";"},this.isReady=!1,this.connectListeners=[],this.disconnectListeners=[],this.nativeMessageListeners=[],this.messageListeners={},!window.WebSocket)throw"不支持ws";-1==t.indexOf("ws")&&(t="ws://"+t),e&&0<e.length?this.conn=new WebSocket(t,e):this.conn=new WebSocket(t),this.conn.onopen=function(){return n.fireConnect(),n.isReady=!0,null},this.conn.onclose=function(){return n.fireDisconnect(),null},this.conn.onmessage=function(t){n.messageReceivedFromConn(t)}}return t.prototype.isNumber=function(t){return!isNaN(+t)&&null!==t&&""!==t&&!1!==t},t.prototype.isString=function(t){return"[object String]"==Object.prototype.toString.call(t)},t.prototype.isBoolean=function(t){return"boolean"==typeof t||"object"==typeof t&&"boolean"==typeof t.valueOf()},t.prototype.isJSON=function(t){return"object"==typeof t},t.prototype.toMsg=function(t,e,n){return this.option.prefix+t+this.option.separator+String(e)+this.option.separator+n},t.prototype.encodeMessage=function(t,e){var n="",i=WsMessageType.STRING;return this.isNumber(e)?(i=WsMessageType.INT,n=e.toString()):this.isBoolean(e)?(i=WsMessageType.BOOL,n=e.toString()):this.isString(e)?(i=WsMessageType.STRING,n=e.toString()):this.isJSON(e)?(i=WsMessageType.JSON,n=JSON.stringify(e)):null!=e&&console.log("unsupported type of input argument passed, try to not include this argument to the 'Emit'"),this.toMsg(t,i,n)},t.prototype.decodeMessage=function(t,e){var n,t=this.option.prefix.length+this.option.separator.length+t.length+2;return e.length<t+1?null:(n=parseInt(e.charAt(t-2)),t=e.substring(t,e.length),n===WsMessageType.INT?parseInt(t):n==WsMessageType.BOOL?Boolean(t):n==WsMessageType.STRING?t:n==WsMessageType.JSON?JSON.parse(t):null)},t.prototype.getWebsocketCustomEvent=function(t){var e=this.option.prefix.length+this.option.separator.length-1;return t.length<e?"":(e=t.substring(e,t.length)).substring(0,e.indexOf(this.option.separator))},t.prototype.getCustomMessage=function(t,e){var n=e.indexOf(t+this.option.separator);return e.substring(n+t.length+this.option.separator.length+2,e.length)},t.prototype.messageReceivedFromConn=function(t){t=t.data;if(-1!=t.indexOf(this.option.prefix)){var e=this.getWebsocketCustomEvent(t);if(""!=e)return void this.fireMessage(e,this.getCustomMessage(e,t))}this.fireNativeMessage(t)},t.prototype.onConnect=function(t){return this.isReady&&t(),this.connectListeners.push(t),this},t.prototype.fireConnect=function(){this.connectListeners.forEach(function(t){t()})},t.prototype.onDisconnect=function(t){return this.disconnectListeners.push(t),this},t.prototype.fireDisconnect=function(){this.disconnectListeners.forEach(function(t){t()})},t.prototype.onMessage=function(t){return this.nativeMessageListeners.push(t),this},t.prototype.fireNativeMessage=function(e){return this.nativeMessageListeners.forEach(function(t){t(e)}),this},t.prototype.on=function(t,e){return null!=this.messageListeners[t]&&null!=this.messageListeners[t]||(this.messageListeners[t]=[]),this.messageListeners[t].push(e),this},t.prototype.fireMessage=function(t,e){t=this.messageListeners[t];t&&t.forEach(function(t){t(e)})},t.prototype.disconnect=function(){this.conn.close()},t.prototype.emitMessage=function(t){this.conn.send(t)},t.prototype.emit=function(t,e){this.emitMessage(this.encodeMessage(t,e))},t}();