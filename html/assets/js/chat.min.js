var ChatType,__extends=this&&this.__extends||function(){var s=function(t,e){return(s=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var n in e)e.hasOwnProperty(n)&&(t[n]=e[n])})(t,e)};return function(t,e){function n(){this.constructor=t}s(t,e),t.prototype=null===e?Object.create(e):(n.prototype=e.prototype,new n)}}();!function(t){t[t.MESSAGE=0]="MESSAGE",t[t.MORE=1]="MORE",t[t.TIP=2]="TIP",t[t.TIME=3]="TIME"}(ChatType||(ChatType={}));var EVENT_REFRESH_USERS="refresh_users",EVENT_REFRESH_GROUPS="refresh_groups",EVENT_GROUP_USERS="refresh_group_users",EVENT_USER_GROUPS="user_groups",EVENT_USER_INFO="user_info",EVENT_GROUP_INFO="group_info",EVENT_SEARCH_USERS="search_users",EVENT_SEARCH_GROUPS="search_groups",EVENT_ADD_USER="add_user",EVENT_SEND_MESSAGE="send_message",EVENT_GET_MESSAGE="get_message",ChatBaseBox=function(){function t(){this.cache_element={}}return t.prototype.find=function(t){return this.cache_element.hasOwnProperty(t)?this.cache_element[t]:this.cache_element[t]=this.box.find(t)},t.prototype.show=function(){return this.box.show(),this},t.prototype.center=function(){return this.box.css({left:Math.max(0,($(window).width()-this.box.outerWidth())/2)+"px",top:Math.max(0,($(window).height()-this.box.outerHeight())/2)+"px"}),this},t.prototype.hide=function(){this.box.hide()},t.format=function(t){for(var n=[],e=1;e<arguments.length;e++)n[e-1]=arguments[e];return t.replace(/\{(\d+)\}/g,function(t,e){return n[e]})},t}(),ChatMenu=function(s){function t(t,e){void 0===e&&(e=[]);var n=s.call(this)||this;return n.box=t,n.menus=e,n._events={},n.bindEvent(),n}return __extends(t,s),t.prototype.on=function(t,e){return this._events[t]=e,this},t.prototype.hasEvent=function(t){return this._events.hasOwnProperty(t)},t.prototype.trigger=function(t){for(var e,n=[],s=1;s<arguments.length;s++)n[s-1]=arguments[s];if(this.hasEvent(t))return(e=this._events[t]).call.apply(e,[this].concat(n))},t.prototype.bindEvent=function(){var t=this;this.box.on("click","li",function(){t.clickLi($(this))})},t.prototype.clickLi=function(t){var e,n=t.attr("data-name");n&&this.menuMap.hasOwnProperty(n)&&(e=this.menuMap[n])&&e.onclick&&!1===e.onclick(t,this.target,this)||n&&this.hasEvent(n)&&!1===this.trigger(n,t,e,this.target,this)||this.trigger("click",t,e,this.target)},t.prototype.addMenu=function(t){return this.menus.push(t),this},t.prototype.showPosition=function(t,e,n){return this.refresh(),this.box.css({left:t+"px",top:e+"px"}).show(),this.target=n,this},t.prototype.hide=function(){this.box.hide(),this.target=null},t.prototype.refresh=function(){this.menuMap={};var t=this.cleanMenuList(this.menus),e=t?this.getMenuHtml(t):"";this.box.html(e)},t.prototype.getMenuHtml=function(t){var e=this,n="";return t.forEach(function(t){n+=e.getMenuItemHtml(t)}),"<ul>"+n+"</ul>"},t.prototype.getMenuItemHtml=function(t){var e=t.text||t.name,n='<li data-name="'+e+'"><span><i class="fa fa-'+t.icon+'"></i>'+(t.text||t.name),s=this.cleanMenuList(t.children);return this.menuMap[e]=t,s&&0<s.length?n+'<i class="fa fa-chevron-right"></i></span>'+this.getMenuHtml(s)+"</li>":n+"</span></li>"},t.prototype.cleanMenuList=function(t){var e=this;if(!t||0==t.length)return null;var n=[];return t.forEach(function(t){t.toggle&&!1===t.toggle(e.target,e)||n.push(t)}),n},t}(ChatBaseBox),ChatAddUserBox=function(s){function t(t,e){var n=s.call(this)||this;return n.box=t,n.parent=e,n.bindEvent(),n}return __extends(t,s),t.prototype.bindEvent=function(){var t=this;this.box.on("click",".dialog-add-action .dialog-yes",function(){t.parent.trigger(EVENT_ADD_USER,t._user,t.box.find("select").val(),t)})},t.prototype.showWithUser=function(t){this.parent.trigger(EVENT_USER_GROUPS,this),this._user=t,this.refresh(),this.center().show()},t.prototype.refresh=function(){},t}(ChatBaseBox),ChatUserInfoBox=function(s){function t(t,e){var n=s.call(this)||this;return n.box=t,n.parent=e,n}return __extends(t,s),t}(ChatBaseBox),ChatSearchBox=function(s){function n(t,e){var n=s.call(this)||this;return n.box=t,n.parent=e,n._is_search_user=!0,n._users=[],n.bindEvent(),n}return __extends(n,s),Object.defineProperty(n.prototype,"users",{set:function(t){this._users=t,this.render()},enumerable:!0,configurable:!0}),n.prototype.render=function(){var e="";this._users.forEach(function(t){e+=n.format('<div class="dialog-info" data-id="{3}">\n        <div class="dialog-info-avatar">\n            <img src="{0}" alt="">\n        </div>\n        <div class="dialog-info-name">\n            <h3>{1}</h3>\n            <p>{2}</p>\n        </div>\n    </div>',t.avatar,t.name,t.brief,t.id)}),this.find(".dialog-search-list").html(e)},n.prototype.bindEvent=function(){var e=this;this.box.on("click",".dialog-search-list .dialog-info",function(){var t=e.getUser($(this).data("id"));e.parent.addBox.showWithUser(t)}).on("click",".dialog-tab-header .dialog-tab-item",function(){var t=$(this);t.addClass("active").siblings().removeClass("active"),e._is_search_user=t.index()<1}).on("keyup",".dialog-search input",function(){e.parent.trigger(e._is_search_user?EVENT_SEARCH_USERS:EVENT_SEARCH_GROUPS,$(this).val(),e)})},n.prototype.getUser=function(t){for(var e=0;e<this._users.length;e++)if(this._users[e].id==t)return this._users[e];return null},n}(ChatBaseBox),ChatEditor=function(){function t(t,e){this.box=t,this.parent=e}return t.prototype.html=function(){return this.box.html()},t.prototype.text=function(){return this.box.text()},t.prototype.insertHtmlAtCaret=function(t){var e,n,s=this.box;if(s.is(":focus")||(s.focus(),(n=document.createRange()).setStartAfter(s[0]),n.setEnd(s[0],s[0].childNodes.length)),window.getSelection&&(e=window.getSelection()).getRangeAt&&e.rangeCount){n||(n=e.getRangeAt(0)).deleteContents();var i=document.createElement("div");i.innerHTML=t;for(var a,o,r=document.createDocumentFragment();a=i.firstChild;)o=r.appendChild(a);n.insertNode(r),o&&((n=n.cloneRange()).setStartAfter(o),n.collapse(!0),e.removeAllRanges(),e.addRange(n))}},t}(),ChatMessageBox=function(a){function s(t,e,n,s){var i=a.call(this)||this;return i.box=t,i.parent=e,i.send=n,i.revice=s,i._messages=[],i.refresh(),i.bindEvent(),i}return __extends(s,a),Object.defineProperty(s.prototype,"messages",{set:function(t){this._messages=t,this.renderMessage()},enumerable:!0,configurable:!0}),s.prototype.refresh=function(){this.editor=new ChatEditor(this.find(".dialog-message-text"),this),this.renderTitle()},s.prototype.bindEvent=function(){var t=this;this.box.on("click",".fa-smile-o",function(){t.editor.insertHtmlAtCaret('<img src="./image/avatar.jpg" alt="">')}).on("click",".dailog-message-action button",function(){t.parent.trigger(EVENT_SEND_MESSAGE,t.editor.text(),t.revice,t)}),$(window).resize(function(){t.center()})},s.prototype.renderTitle=function(){this.revice&&this.find(".dialog-title").html("与 "+this.revice.name+" 聊天中")},s.prototype.addMessage=function(t){this._messages.push(t),this.renderMessage()},s.prototype.prependMessage=function(t){this._messages=t.concat(this._messages),this.renderMessage()},s.prototype.renderMessage=function(){var e=this,n="";this.cleanMessage().forEach(function(t){n+=e.renderMessageItem(t)}),this.find(".dialog-message-box").html(n)},s.prototype.renderMessageItem=function(t){switch(t.type){case ChatType.MORE:return'<p class="message-more">加载更多</p>';case ChatType.TIME:return'<p class="message-line">'+t.content+"</p>";case ChatType.TIP:return'<p class="message-tip">'+t.content+"</p>";case ChatType.MESSAGE:}return t.user.id==this.send.id?s.format('<div class="message-right">\n            <img class="avatar" src="{0}">\n            <div class="content">\n                {1}\n            </div>\n        </div>',t.user.avatar,t.content):s.format('<div class="message-left">\n        <img class="avatar" src="{0}">\n        <div class="content">\n            {1}\n        </div>\n    </div>',t.user.avatar,t.content)},s.prototype.cleanMessage=function(){if(!this._messages||this._messages.length<1)return[];var e=[{type:ChatType.MORE}],n=0;return this._messages.forEach(function(t){200<t.time-n&&(n=t.time,e.push({content:s.date(n)+"",type:ChatType.TIME})),e.push(t)}),e},s.prototype.showWithUser=function(t){this.revice=t,this.renderTitle(),this.center().show(),this.messages=[],this.parent.trigger(EVENT_GET_MESSAGE,t,1,10,this)},s.date=function(t,e){void 0===e&&(e="y年m月d日"),"number"==typeof t&&(t=new Date(1e3*t));var n={"y+":t.getFullYear(),"m+":t.getMonth()+1,"d+":t.getDate(),"h+":t.getHours(),"i+":t.getMinutes(),"s+":t.getSeconds(),"q+":Math.floor((t.getMonth()+3)/3),S:t.getMilliseconds()};for(var s in n)new RegExp("("+s+")").test(e)&&(e=e.replace(RegExp.$1,1==RegExp.$1.length?n[s]:("00"+n[s]).substr((""+n[s]).length)));return e},s}(ChatBaseBox),ChatUserBox=function(s){function i(t,e){var n=s.call(this)||this;return n.box=t,n.parent=e,n._last_friends=[],n.menu=new ChatMenu(n.find(".dialog-menu"),USER_MENU),n.bindEvent(),n}return __extends(i,s),Object.defineProperty(i.prototype,"user",{set:function(t){this._user=t,this.renderUser(),this.refresh()},enumerable:!0,configurable:!0}),Object.defineProperty(i.prototype,"friends",{set:function(t){var e=this;this._friends=t,this.renderFriends(),t.forEach(function(t){t.users.forEach(function(t){t.last_message&&e._last_friends.push(t)})}),this.renderLastFriends()},enumerable:!0,configurable:!0}),Object.defineProperty(i.prototype,"groups",{set:function(t){var e=this;this._groups=t,this.renderGroup(),t.forEach(function(t){t.last_message&&e._last_friends.push(t)}),this.renderLastFriends()},enumerable:!0,configurable:!0}),i.prototype.refresh=function(){this.parent.trigger(EVENT_REFRESH_USERS,this),this.parent.trigger(EVENT_REFRESH_GROUPS,this)},i.prototype.renderGroup=function(){var e="";this._groups.forEach(function(t){e+=i.format('<div class="dialog-user">\n        <div class="dialog-user-avatar">\n            <img src="{0}" alt="">\n        </div>\n        <div class="dialog-user-info">\n            <p>\n                <span class="name">{1}</span>\n            </p>\n            <p>\n                <span class="content">{2}</span>\n            </p>\n        </div>\n    </div>',t.avatar,t.name,t.brief)}),this.find(".dialog-tab-box .dialog-tab-item").eq(2).html(e)},i.prototype.renderFriends=function(){var n="";this._friends.forEach(function(t){var e="";t.users.forEach(function(t){e+=i.format('<div class="dialog-user">\n            <div class="dialog-user-avatar">\n                <img src="{0}" alt="">\n            </div>\n            <div class="dialog-user-info">\n                <p>\n                    <span class="name">{1}</span>\n                </p>\n                <p>\n                    <span class="content">{2}</span>\n                </p>\n            </div>\n        </div>',t.avatar,t.name,t.brief)}),n+=i.format('\n        <div class="dialog-panel expanded">\n        <div class="dialog-panel-header">\n            <i class="dialog-panel-icon"></i>\n            <span>{0} ({1} / {2})</span>\n        </div>\n        <div class="dialog-panel-box">\n            {3}\n        </div>\n    </div>\n        ',t.name,t.online_count,t.count,e)}),this.find(".dialog-tab-box .dialog-tab-item").eq(1).html(n)},i.prototype.renderLastFriends=function(){var e="";this._last_friends.forEach(function(t){e+=i.format('<div class="dialog-user" data-id="{5}">\n        <div class="dialog-user-avatar">\n            <img src="{0}" alt="">\n        </div>\n        <div class="dialog-user-info">\n            <p>\n                <span class="name">{1}</span>\n                <span class="time">{2}</span>\n            </p>\n            <p>\n                <span class="content">{3}</span>\n                <span class="count">{4}</span>\n            </p>\n        </div>\n    </div>',t.avatar,t.name,ChatMessageBox.date(t.last_message.time),t.last_message.content,t.new_count||0,t.id)}),this.find(".dialog-tab-box .dialog-tab-item").eq(0).html(e)},i.prototype.renderUser=function(){this.find(".dialog-info").html(i.format('<div class="dialog-info-avatar">\n        <img src="{0}" alt="">\n    </div>\n    <div class="dialog-info-name">\n        <h3>{1}</h3>\n        <p>{2}</p>\n    </div>\n    <div class="dialog-message-count">\n    {3}\n    </div>',this._user.avatar,this._user.name,this._user.brief,this._user.new_count))},i.prototype.bindEvent=function(){var s=this;$(document).click(function(){s.menu&&s.menu.hide()}),this.box.click(function(){$(this).hasClass("dialog-min")&&$(this).removeClass("dialog-min")}).on("click",".dialog-header .fa-minus",function(t){t.stopPropagation(),s.box.addClass("dialog-min")}).on("click",".dialog-header .fa-plus",function(){s.parent.searchBox.center().show()}).on("click",".dialog-tab .dialog-tab-header .dialog-tab-item",function(){var t=$(this);t.addClass("active").siblings().removeClass("active"),t.closest(".dialog-tab").find(".dialog-tab-box .dialog-tab-item").eq(t.index()).addClass("active").siblings().removeClass("active")}).on("click",".dialog-panel .dialog-panel-header",function(){$(this).closest(".dialog-panel").toggleClass("expanded")}).on("click",".dialog-tab .dialog-user",function(){s.parent.chatBox.showWithUser(s.getUser($(this).data("id")))}).on("contextmenu",".dialog-tab .dialog-user",function(t){return s.menu&&s.menu.showPosition(t.clientX,t.clientY,$(this)),!1}),this.menu.on("click",function(t,e,n){s.parent.userBox.show()}),this.parent.on(EVENT_USER_GROUPS,function(t){})},i.prototype.getUser=function(t){for(var e=0;e<this._last_friends.length;e++)if(this._last_friends[e].id==t)return this._last_friends[e]},i}(ChatBaseBox),ChatRoom=function(){function t(t){this.target=t,this._events={}}return t.prototype.on=function(t,e){return this._events[t]=e,this},t.prototype.hasEvent=function(t){return this._events.hasOwnProperty(t)},t.prototype.trigger=function(t){for(var e,n=[],s=1;s<arguments.length;s++)n[s-1]=arguments[s];if(this.hasEvent(t))return(e=this._events[t]).call.apply(e,[this].concat(n))},t.prototype.init=function(t){this.mainBox=new ChatUserBox(this.target.find(".dialog-chat-box"),this),this.addBox=new ChatAddUserBox(this.target.find(".dialog-add-box"),this),this.userBox=new ChatUserInfoBox(this.target.find(".dialog-user-box"),this),this.searchBox=new ChatSearchBox(this.target.find(".dialog-search-box"),this),this.chatBox=new ChatMessageBox(this.target.find(".dialog-chat-room"),this,t),this.mainBox.user=t},t.prototype.toggleMode=function(){return this.target.hasClass("dialog-fixed")?this.page():this.fixed()},t.prototype.fixed=function(){return this.target.addClass("dialog-fixed").removeClass("dialog-chat-page"),this},t.prototype.page=function(){return this.target.removeClass("dialog-fixed").addClass("dialog-chat-page"),this},t}(),USER_MENU=[{icon:"eye",text:"查看资料"},{icon:"bookmark",text:"移动好友"},{icon:"trash",text:"删除好友"}],TEST_USER={id:2,name:"123123",brief:"12313",avatar:"/assets/images/avatar/14.png",new_count:1,last_message:{content:"123123",time:1510601234,type:ChatType.MESSAGE}},TEST_SEND={id:1,name:"admin",brief:"1111",avatar:"/assets/images/avatar/1.png",new_count:1},TEST_GROUP={name:"我的好友",count:2,online_count:1,users:[TEST_SEND,TEST_USER]},TEST_MESSAGE={content:"123123",time:1510601234,type:ChatType.MESSAGE,user:TEST_USER};function registerChat(i){var t=new ChatRoom($(".dialog-chat"));t.on(EVENT_REFRESH_USERS,function(e){postJson(i+"friend",function(t){200==t.code&&(e.friends=[TEST_GROUP])})}).on(EVENT_REFRESH_GROUPS,function(e){postJson(i+"group",function(t){200==t.code&&(e.groups=[TEST_USER])})}).on(EVENT_SEARCH_USERS,function(t,e){postJson(i+"friend/search",{keywords:t},function(t){200==t.code&&(e.users=[TEST_USER])})}).on(EVENT_GET_MESSAGE,function(t,e,n,s){postJson(i+"friend/message",{user:t.id,page:e,per_page:n},function(t){200==t.code&&(s.messages=[TEST_MESSAGE])})}).on(EVENT_SEND_MESSAGE,function(e,t,n){postJson(i+"friend/send_message",{user:t.id,content:e},function(t){200==t.code&&n.addMessage({content:e,type:ChatType.MESSAGE,user:TEST_SEND})})}).init(TEST_SEND),$(".dialog-box").on("click",".dialog-header .fa-close",function(){$(this).closest(".dialog-box").hide()}),$("#toggle-btn").click(function(){t.toggleMode()})}