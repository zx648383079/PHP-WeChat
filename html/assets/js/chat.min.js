var ChatType,__extends=this&&this.__extends||function(){var i=function(t,n){return(i=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,n){t.__proto__=n}||function(t,n){for(var e in n)n.hasOwnProperty(e)&&(t[e]=n[e])})(t,n)};return function(t,n){function e(){this.constructor=t}i(t,n),t.prototype=null===n?Object.create(n):(e.prototype=n.prototype,new e)}}();!function(t){t[t.MESSAGE=0]="MESSAGE",t[t.MORE=1]="MORE",t[t.TIP=2]="TIP",t[t.TIME=3]="TIME"}(ChatType||(ChatType={}));var ChatBaseBox=function(){function t(){this.cache_element={},this.events={}}return t.prototype.on=function(t,n){return this.events[t]=n,this},t.prototype.hasEvent=function(t){return this.events.hasOwnProperty(t)},t.prototype.trigger=function(t){for(var n,e=[],i=1;i<arguments.length;i++)e[i-1]=arguments[i];if(this.hasEvent(t))return(n=this.events[t]).call.apply(n,[this].concat(e))},t.prototype.find=function(t){return this.cache_element.hasOwnProperty(t)?this.cache_element[t]:this.cache_element[t]=this.box.find(t)},t.prototype.show=function(){return this.box.show(),this},t.prototype.hide=function(){this.box.hide()},t}(),ChatMenu=function(i){function t(t,n){void 0===n&&(n=[]);var e=i.call(this)||this;return e.box=t,e.menus=n,e.bindEvent(),e}return __extends(t,i),t.prototype.bindEvent=function(){var t=this;this.box.on("click","li",function(){t.clickLi($(this))})},t.prototype.clickLi=function(t){var n,e=t.attr("data-name");e&&this.menuMap.hasOwnProperty(e)&&(n=this.menuMap[e])&&n.onclick&&!1===n.onclick(t,this.target,this)||e&&this.hasEvent(e)&&!1===this.trigger(e,t,n,this.target,this)||this.trigger("click",t,n,this.target)},t.prototype.addMenu=function(t){return this.menus.push(t),this},t.prototype.showPosition=function(t,n,e){return this.refresh(),this.box.css({left:t+"px",top:n+"px"}).show(),this.target=e,this},t.prototype.hide=function(){this.box.hide(),this.target=null},t.prototype.refresh=function(){this.menuMap={};var t=this.cleanMenuList(this.menus),n=t?this.getMenuHtml(t):"";this.box.html(n)},t.prototype.getMenuHtml=function(t){var n=this,e="";return t.forEach(function(t){e+=n.getMenuItemHtml(t)}),"<ul>"+e+"</ul>"},t.prototype.getMenuItemHtml=function(t){var n=t.text||t.name,e='<li data-name="'+n+'"><span><i class="fa fa-'+t.icon+'"></i>'+(t.text||t.name),i=this.cleanMenuList(t.children);return this.menuMap[n]=t,i&&0<i.length?e+'<i class="fa fa-chevron-right"></i></span>'+this.getMenuHtml(i)+"</li>":e+"</span></li>"},t.prototype.cleanMenuList=function(t){var n=this;if(!t||0==t.length)return null;var e=[];return t.forEach(function(t){t.toggle&&!1===t.toggle(n.target,n)||e.push(t)}),e},t}(ChatBaseBox),ChatAddUserBox=function(i){function t(t,n){var e=i.call(this)||this;return e.box=t,e.parent=n,e}return __extends(t,i),t}(ChatBaseBox),ChatUserInfoBox=function(i){function t(t,n){var e=i.call(this)||this;return e.box=t,e.parent=n,e}return __extends(t,i),t}(ChatBaseBox),ChatSearchBox=function(i){function t(t,n){var e=i.call(this)||this;return e.box=t,e.parent=n,e.users=[],e.bindEvent(),e}return __extends(t,i),t.prototype.render=function(){var n="";this.users.forEach(function(t){n+=ZUtils.str.format('<div class="dialog-info">\n        <div class="dialog-info-avatar">\n            <img src="{0}" alt="">\n        </div>\n        <div class="dialog-info-name">\n            <h3>{1}</h3>\n            <p>{2}</p>\n        </div>\n    </div>',t.avatar,t.name,t.brief)}),this.find(".dialog-search-list").html(n)},t.prototype.bindEvent=function(){var t=this;this.box.on("click",".dialog-search-list .dialog-info",function(){t.parent.addBox.show()}),this.box.on("click",".dialog-tab-header .dialog-tab-item",function(){$(this).addClass("active").siblings().removeClass("active")})},t}(ChatBaseBox),ChatEditor=function(){function t(t,n){this.box=t,this.parent=n}return t.prototype.html=function(){return this.box.html()},t.prototype.text=function(){return this.box.text()},t.prototype.insertHtmlAtCaret=function(t){var n,e,i=this.box;if(i.is(":focus")||(i.focus(),(e=document.createRange()).setStartAfter(i[0]),e.setEnd(i[0],i[0].childNodes.length)),window.getSelection&&(n=window.getSelection()).getRangeAt&&n.rangeCount){e||(e=n.getRangeAt(0)).deleteContents();var s=document.createElement("div");s.innerHTML=t;for(var a,o,r=document.createDocumentFragment();a=s.firstChild;)o=r.appendChild(a);e.insertNode(r),o&&((e=e.cloneRange()).setStartAfter(o),e.collapse(!0),n.removeAllRanges(),n.addRange(e))}},t}(),ChatMessageBox=function(a){function t(t,n,e,i){var s=a.call(this)||this;return s.box=t,s.parent=n,s.send=e,s.revice=i,s.messages=[],s.refresh(),s.bindEvent(),s}return __extends(t,a),t.prototype.refresh=function(){this.editor=new ChatEditor(this.find(".dialog-message-text"),this),this.renderTitle()},t.prototype.bindEvent=function(){var t=this;this.box.on("click",".fa-smile-o",function(){t.editor.insertHtmlAtCaret('<img src="./image/avatar.jpg" alt="">')})},t.prototype.renderTitle=function(){this.revice&&this.find(".dialog-title").html("与 "+this.revice.name+" 聊天中")},t.prototype.addMessage=function(t){this.messages.push(t),this.renderMessage()},t.prototype.prependMessage=function(t){this.messages=t.concat(this.messages),this.renderMessage()},t.prototype.renderMessage=function(){var n=this,e="";this.cleanMessage().forEach(function(t){e+=n.renderMessageItem(t)}),this.find(".dialog-message-box").html(e)},t.prototype.renderMessageItem=function(t){switch(t.type){case ChatType.MORE:return'<p class="message-more">加载更多</p>';case ChatType.TIME:return'<p class="message-line">'+t.content+"</p>";case ChatType.TIP:return'<p class="message-tip">'+t.content+"</p>";case ChatType.MESSAGE:}return t.user.id==this.send.id?ZUtils.str.format('<div class="message-right">\n            <img class="avatar" src="{0}">\n            <div class="content">\n                {1}\n            </div>\n        </div>',t.user.avatar,t.content):ZUtils.str.format('<div class="message-left">\n        <img class="avatar" src="{0}">\n        <div class="content">\n            {1}\n        </div>\n    </div>',t.user.avatar,t.content)},t.prototype.cleanMessage=function(){var n=this,t=[{type:ChatType.MORE}],e=0;return this.messages.forEach(function(t){200<t.time-e&&(e=t.time,n.messages.push({content:ZUtils.time+"",type:ChatType.TIME}))}),t},t}(ChatBaseBox),ChatUserBox=function(i){function t(t,n){var e=i.call(this)||this;return e.box=t,e.parent=n,e.refresh(),e.bindEvent(),e}return __extends(t,i),t.prototype.refresh=function(){this.menu=new ChatMenu(this.find(".dialog-menu"),USER_MENU)},t.prototype.renderGroup=function(){var n="";this.groups.forEach(function(t){n+=ZUtils.str.format('<div class="dialog-user">\n        <div class="dialog-user-avatar">\n            <img src="{0}" alt="">\n        </div>\n        <div class="dialog-user-info">\n            <p>\n                <span class="name">{1}</span>\n            </p>\n            <p>\n                <span class="content">{2}</span>\n            </p>\n        </div>\n    </div>',t.avatar,t.name,t.brief)}),this.find(".dialog-tab-box .dialog-tab-item").eq(2).html(n)},t.prototype.renderFriends=function(){var e="";this.friends.forEach(function(t){var n="";t.users.forEach(function(t){n+=ZUtils.str.format('<div class="dialog-user">\n            <div class="dialog-user-avatar">\n                <img src="{0}" alt="">\n            </div>\n            <div class="dialog-user-info">\n                <p>\n                    <span class="name">{1}</span>\n                </p>\n                <p>\n                    <span class="content">{2}</span>\n                </p>\n            </div>\n        </div>',t.avatar,t.name,t.brief)}),e+=ZUtils.str.format('\n        <div class="dialog-panel expanded">\n        <div class="dialog-panel-header">\n            <i class="dialog-panel-icon"></i>\n            <span>{0} ({1} / {2})</span>\n        </div>\n        <div class="dialog-panel-box">\n            {3}\n        </div>\n    </div>\n        ',t.name,t.online_count,t.count,n)}),this.find(".dialog-tab-box .dialog-tab-item").eq(1).html(e)},t.prototype.renderLastFriends=function(){var n="";this.last_friends.forEach(function(t){n+=ZUtils.str.format('<div class="dialog-user">\n        <div class="dialog-user-avatar">\n            <img src="{0}" alt="">\n        </div>\n        <div class="dialog-user-info">\n            <p>\n                <span class="name">{1}</span>\n                <span class="time">{2}</span>\n            </p>\n            <p>\n                <span class="content">{3}</span>\n                <span class="count">{4}</span>\n            </p>\n        </div>\n    </div>',t.avatar,t.name,t.last_message.time,t.last_message.content,t.new_count)}),this.find(".dialog-tab-box .dialog-tab-item").eq(0).html(n)},t.prototype.renderUser=function(){this.find(".dialog-info").html(ZUtils.str.format('<div class="dialog-info-avatar">\n        <img src="{0}" alt="">\n    </div>\n    <div class="dialog-info-name">\n        <h3>{1}</h3>\n        <p>{2}</p>\n    </div>\n    <div class="dialog-message-count">\n    {3}\n    </div>',this.user.avatar,this.user.name,this.user.brief,this.user.new_count))},t.prototype.bindEvent=function(){var n=this;$(document).click(function(){n.menu.hide()}),this.box.click(function(){$(this).hasClass("dialog-min")&&$(this).removeClass("dialog-min")}),this.box.on("click",".dialog-header .fa-minus",function(t){t.stopPropagation(),n.box.addClass("dialog-min")}),this.box.on("click",".dialog-header .fa-plus",function(){n.parent.searchBox.show()}),this.box.on("click",".dialog-tab .dialog-tab-header .dialog-tab-item",function(){var t=$(this);t.addClass("active").siblings().removeClass("active"),t.closest(".dialog-tab").find(".dialog-tab-box .dialog-tab-item").eq(t.index()).addClass("active").siblings().removeClass("active")}),this.box.on("click",".dialog-panel .dialog-panel-header",function(){$(this).closest(".dialog-panel").toggleClass("expanded")}),this.box.on("click",".dialog-tab .dialog-user",function(){$(this).closest(".dialog-chat").find(".dialog-chat-room").show()}),this.box.on("contextmenu",".dialog-tab .dialog-user",function(t){return n.menu.showPosition(t.clientX,t.clientY,$(this)),!1}),this.menu.on("click",function(){console.log(arguments),n.parent.userBox.show()})},t}(ChatBaseBox),ChatRoom=function(){function t(t){this.target=t,this.refresh()}return t.prototype.refresh=function(){this.mainBox=new ChatUserBox(this.target.find(".dialog-chat-box"),this),this.addBox=new ChatAddUserBox(this.target.find(".dialog-add-box"),this),this.userBox=new ChatUserInfoBox(this.target.find(".dialog-user-box"),this),this.searchBox=new ChatSearchBox(this.target.find(".dialog-search-box"),this),this.chatBox=new ChatMessageBox(this.target.find(".dialog-chat-room"),this)},t}(),USER_MENU=[{icon:"eye",text:"查看资料"},{icon:"bookmark",text:"移动好友"},{icon:"trash",text:"删除好友"}],room=new ChatRoom($(".dialog-chat-page")),fixed_room=new ChatRoom($(".dialog-fixed"));$(function(){$(".dialog-box").on("click",".dialog-header .fa-close",function(){$(this).closest(".dialog-box").hide()})});