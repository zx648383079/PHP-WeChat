var ChatType,__extends=this&&this.__extends||function(){var i=function(t,e){return(i=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var n in e)e.hasOwnProperty(n)&&(t[n]=e[n])})(t,e)};return function(t,e){function n(){this.constructor=t}i(t,e),t.prototype=null===e?Object.create(e):(n.prototype=e.prototype,new n)}}();!function(t){t[t.MESSAGE=0]="MESSAGE",t[t.MORE=1]="MORE",t[t.TIP=2]="TIP",t[t.TIME=3]="TIME"}(ChatType||(ChatType={}));var EVENT_REFRESH_USERS="refresh_users",EVENT_REFRESH_GROUPS="refresh_groups",EVENT_GROUP_USERS="refresh_group_users",EVENT_USER_GROUPS="user_groups",EVENT_USER_INFO="user_info",EVENT_GROUP_INFO="group_info",EVENT_SEARCH_USERS="search_users",EVENT_SEARCH_GROUPS="search_groups",EVENT_ADD_USER="add_user",EVENT_SEND_MESSAGE="send_message",EVENT_GET_MESSAGE="get_message",ChatBaseBox=function(){function t(){this.cache_element={},this.events={}}return t.prototype.on=function(t,e){return this.events[t]=e,this},t.prototype.hasEvent=function(t){return this.events.hasOwnProperty(t)},t.prototype.trigger=function(t){for(var e,n=[],i=1;i<arguments.length;i++)n[i-1]=arguments[i];if(this.hasEvent(t))return(e=this.events[t]).call.apply(e,[this].concat(n))},t.prototype.find=function(t){return this.cache_element.hasOwnProperty(t)?this.cache_element[t]:this.cache_element[t]=this.box.find(t)},t.prototype.show=function(){return this.box.show(),this},t.prototype.center=function(){return this.box.css({left:Math.max(0,($(window).width()-this.box.outerWidth())/2)+"px",top:Math.max(0,($(window).height()-this.box.outerHeight())/2)+"px"}),this},t.prototype.hide=function(){this.box.hide()},t}(),ChatMenu=function(i){function t(t,e){void 0===e&&(e=[]);var n=i.call(this)||this;return n.box=t,n.menus=e,n.bindEvent(),n}return __extends(t,i),t.prototype.bindEvent=function(){var t=this;this.box.on("click","li",function(){t.clickLi($(this))})},t.prototype.clickLi=function(t){var e,n=t.attr("data-name");n&&this.menuMap.hasOwnProperty(n)&&(e=this.menuMap[n])&&e.onclick&&!1===e.onclick(t,this.target,this)||n&&this.hasEvent(n)&&!1===this.trigger(n,t,e,this.target,this)||this.trigger("click",t,e,this.target)},t.prototype.addMenu=function(t){return this.menus.push(t),this},t.prototype.showPosition=function(t,e,n){return this.refresh(),this.box.css({left:t+"px",top:e+"px"}).show(),this.target=n,this},t.prototype.hide=function(){this.box.hide(),this.target=null},t.prototype.refresh=function(){this.menuMap={};var t=this.cleanMenuList(this.menus),e=t?this.getMenuHtml(t):"";this.box.html(e)},t.prototype.getMenuHtml=function(t){var e=this,n="";return t.forEach(function(t){n+=e.getMenuItemHtml(t)}),"<ul>"+n+"</ul>"},t.prototype.getMenuItemHtml=function(t){var e=t.text||t.name,n='<li data-name="'+e+'"><span><i class="fa fa-'+t.icon+'"></i>'+(t.text||t.name),i=this.cleanMenuList(t.children);return this.menuMap[e]=t,i&&0<i.length?n+'<i class="fa fa-chevron-right"></i></span>'+this.getMenuHtml(i)+"</li>":n+"</span></li>"},t.prototype.cleanMenuList=function(t){var e=this;if(!t||0==t.length)return null;var n=[];return t.forEach(function(t){t.toggle&&!1===t.toggle(e.target,e)||n.push(t)}),n},t}(ChatBaseBox),ChatAddUserBox=function(i){function t(t,e){var n=i.call(this)||this;return n.box=t,n.parent=e,n.bindEvent(),n}return __extends(t,i),t.prototype.bindEvent=function(){var t=this;this.box.on("click",".dialog-add-action .dialog-yes",function(){t.parent.trigger(EVENT_ADD_USER,t._user,t.box.find("select").val(),t)})},t.prototype.showWithUser=function(t){this.parent.trigger(EVENT_USER_GROUPS,this),this._user=t,this.refresh(),this.show()},t.prototype.refresh=function(){},t}(ChatBaseBox),ChatUserInfoBox=function(i){function t(t,e){var n=i.call(this)||this;return n.box=t,n.parent=e,n}return __extends(t,i),t}(ChatBaseBox),ChatSearchBox=function(i){function t(t,e){var n=i.call(this)||this;return n.box=t,n.parent=e,n._is_search_user=!0,n._users=[],n.bindEvent(),n}return __extends(t,i),Object.defineProperty(t.prototype,"users",{set:function(t){this._users=t,this.render()},enumerable:!0,configurable:!0}),t.prototype.render=function(){var e="";this._users.forEach(function(t){e+=ZUtils.str.format('<div class="dialog-info" data-id="{3}">\n        <div class="dialog-info-avatar">\n            <img src="{0}" alt="">\n        </div>\n        <div class="dialog-info-name">\n            <h3>{1}</h3>\n            <p>{2}</p>\n        </div>\n    </div>',t.avatar,t.name,t.brief,t.id)}),this.find(".dialog-search-list").html(e)},t.prototype.bindEvent=function(){var e=this;this.box.on("click",".dialog-search-list .dialog-info",function(){var t=e.getUser($(this).data("id"));e.parent.addBox.showWithUser(t)}).on("click",".dialog-tab-header .dialog-tab-item",function(){var t=$(this);t.addClass("active").siblings().removeClass("active"),e._is_search_user=t.index()<1}).on("keyup",".dialog-search input",function(){e.parent.trigger(e._is_search_user?EVENT_SEARCH_USERS:EVENT_SEARCH_GROUPS,$(this).val(),e)})},t.prototype.getUser=function(t){for(var e=0;e<this._users.length;e++)if(this._users[e].id==t)return this._users[e];return null},t}(ChatBaseBox),ChatEditor=function(){function t(t,e){this.box=t,this.parent=e}return t.prototype.html=function(){return this.box.html()},t.prototype.text=function(){return this.box.text()},t.prototype.insertHtmlAtCaret=function(t){var e,n,i=this.box;if(i.is(":focus")||(i.focus(),(n=document.createRange()).setStartAfter(i[0]),n.setEnd(i[0],i[0].childNodes.length)),window.getSelection&&(e=window.getSelection()).getRangeAt&&e.rangeCount){n||(n=e.getRangeAt(0)).deleteContents();var s=document.createElement("div");s.innerHTML=t;for(var o,a,r=document.createDocumentFragment();o=s.firstChild;)a=r.appendChild(o);n.insertNode(r),a&&((n=n.cloneRange()).setStartAfter(a),n.collapse(!0),e.removeAllRanges(),e.addRange(n))}},t}(),ChatMessageBox=function(o){function t(t,e,n,i){var s=o.call(this)||this;return s.box=t,s.parent=e,s.send=n,s.revice=i,s.messages=[],s.refresh(),s.bindEvent(),s}return __extends(t,o),t.prototype.refresh=function(){this.editor=new ChatEditor(this.find(".dialog-message-text"),this),this.renderTitle()},t.prototype.bindEvent=function(){var t=this;this.box.on("click",".fa-smile-o",function(){t.editor.insertHtmlAtCaret('<img src="./image/avatar.jpg" alt="">')})},t.prototype.renderTitle=function(){this.revice&&this.find(".dialog-title").html("与 "+this.revice.name+" 聊天中")},t.prototype.addMessage=function(t){this.messages.push(t),this.renderMessage()},t.prototype.prependMessage=function(t){this.messages=t.concat(this.messages),this.renderMessage()},t.prototype.renderMessage=function(){var e=this,n="";this.cleanMessage().forEach(function(t){n+=e.renderMessageItem(t)}),this.find(".dialog-message-box").html(n)},t.prototype.renderMessageItem=function(t){switch(t.type){case ChatType.MORE:return'<p class="message-more">加载更多</p>';case ChatType.TIME:return'<p class="message-line">'+t.content+"</p>";case ChatType.TIP:return'<p class="message-tip">'+t.content+"</p>";case ChatType.MESSAGE:}return t.user.id==this.send.id?ZUtils.str.format('<div class="message-right">\n            <img class="avatar" src="{0}">\n            <div class="content">\n                {1}\n            </div>\n        </div>',t.user.avatar,t.content):ZUtils.str.format('<div class="message-left">\n        <img class="avatar" src="{0}">\n        <div class="content">\n            {1}\n        </div>\n    </div>',t.user.avatar,t.content)},t.prototype.cleanMessage=function(){var e=this,t=[{type:ChatType.MORE}],n=0;return this.messages.forEach(function(t){200<t.time-n&&(n=t.time,e.messages.push({content:ZUtils.time+"",type:ChatType.TIME}))}),t},t}(ChatBaseBox),ChatUserBox=function(i){function t(t,e){var n=i.call(this)||this;return n.box=t,n.parent=e,n.refresh(),n.bindEvent(),n}return __extends(t,i),Object.defineProperty(t.prototype,"friends",{set:function(t){this._friends=t,this.renderFriends()},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"groups",{set:function(t){this._groups=t,this.renderGroup()},enumerable:!0,configurable:!0}),t.prototype.refresh=function(){this.menu=new ChatMenu(this.find(".dialog-menu"),USER_MENU),this.parent.trigger(EVENT_REFRESH_USERS,this),this.parent.trigger(EVENT_REFRESH_GROUPS,this)},t.prototype.renderGroup=function(){var e="";this._groups.forEach(function(t){e+=ZUtils.str.format('<div class="dialog-user">\n        <div class="dialog-user-avatar">\n            <img src="{0}" alt="">\n        </div>\n        <div class="dialog-user-info">\n            <p>\n                <span class="name">{1}</span>\n            </p>\n            <p>\n                <span class="content">{2}</span>\n            </p>\n        </div>\n    </div>',t.avatar,t.name,t.brief)}),this.find(".dialog-tab-box .dialog-tab-item").eq(2).html(e)},t.prototype.renderFriends=function(){var n="";this._friends.forEach(function(t){var e="";t.users.forEach(function(t){e+=ZUtils.str.format('<div class="dialog-user">\n            <div class="dialog-user-avatar">\n                <img src="{0}" alt="">\n            </div>\n            <div class="dialog-user-info">\n                <p>\n                    <span class="name">{1}</span>\n                </p>\n                <p>\n                    <span class="content">{2}</span>\n                </p>\n            </div>\n        </div>',t.avatar,t.name,t.brief)}),n+=ZUtils.str.format('\n        <div class="dialog-panel expanded">\n        <div class="dialog-panel-header">\n            <i class="dialog-panel-icon"></i>\n            <span>{0} ({1} / {2})</span>\n        </div>\n        <div class="dialog-panel-box">\n            {3}\n        </div>\n    </div>\n        ',t.name,t.online_count,t.count,e)}),this.find(".dialog-tab-box .dialog-tab-item").eq(1).html(n)},t.prototype.renderLastFriends=function(){var e="";this._last_friends.forEach(function(t){e+=ZUtils.str.format('<div class="dialog-user">\n        <div class="dialog-user-avatar">\n            <img src="{0}" alt="">\n        </div>\n        <div class="dialog-user-info">\n            <p>\n                <span class="name">{1}</span>\n                <span class="time">{2}</span>\n            </p>\n            <p>\n                <span class="content">{3}</span>\n                <span class="count">{4}</span>\n            </p>\n        </div>\n    </div>',t.avatar,t.name,t.last_message.time,t.last_message.content,t.new_count)}),this.find(".dialog-tab-box .dialog-tab-item").eq(0).html(e)},t.prototype.renderUser=function(){this.find(".dialog-info").html(ZUtils.str.format('<div class="dialog-info-avatar">\n        <img src="{0}" alt="">\n    </div>\n    <div class="dialog-info-name">\n        <h3>{1}</h3>\n        <p>{2}</p>\n    </div>\n    <div class="dialog-message-count">\n    {3}\n    </div>',this.user.avatar,this.user.name,this.user.brief,this.user.new_count))},t.prototype.bindEvent=function(){var e=this;$(document).click(function(){e.menu.hide()}),this.box.click(function(){$(this).hasClass("dialog-min")&&$(this).removeClass("dialog-min")}).on("click",".dialog-header .fa-minus",function(t){t.stopPropagation(),e.box.addClass("dialog-min")}).on("click",".dialog-header .fa-plus",function(){e.parent.searchBox.center().show()}).on("click",".dialog-tab .dialog-tab-header .dialog-tab-item",function(){var t=$(this);t.addClass("active").siblings().removeClass("active"),t.closest(".dialog-tab").find(".dialog-tab-box .dialog-tab-item").eq(t.index()).addClass("active").siblings().removeClass("active")}).on("click",".dialog-panel .dialog-panel-header",function(){$(this).closest(".dialog-panel").toggleClass("expanded")}).on("click",".dialog-tab .dialog-user",function(){$(this).closest(".dialog-chat").find(".dialog-chat-room").show()}).on("contextmenu",".dialog-tab .dialog-user",function(t){return e.menu.showPosition(t.clientX,t.clientY,$(this)),!1}),this.menu.on("click",function(){console.log(arguments),e.parent.userBox.show()}),this.parent.on(EVENT_USER_GROUPS,function(t){})},t}(ChatBaseBox),ChatRoom=function(){function t(t){this.target=t,this._events={}}return t.prototype.on=function(t,e){return this._events[t]=e,this},t.prototype.hasEvent=function(t){return this._events.hasOwnProperty(t)},t.prototype.trigger=function(t){for(var e,n=[],i=1;i<arguments.length;i++)n[i-1]=arguments[i];if(this.hasEvent(t))return(e=this._events[t]).call.apply(e,[this].concat(n))},t.prototype.init=function(){this.mainBox=new ChatUserBox(this.target.find(".dialog-chat-box"),this),this.addBox=new ChatAddUserBox(this.target.find(".dialog-add-box"),this),this.userBox=new ChatUserInfoBox(this.target.find(".dialog-user-box"),this),this.searchBox=new ChatSearchBox(this.target.find(".dialog-search-box"),this),this.chatBox=new ChatMessageBox(this.target.find(".dialog-chat-room"),this)},t.prototype.toggleMode=function(){return this.target.hasClass("dialog-fixed")?this.page():this.fixed()},t.prototype.fixed=function(){return this.target.addClass("dialog-fixed").removeClass("dialog-chat-page"),this},t.prototype.page=function(){return this.target.removeClass("dialog-fixed").addClass("dialog-chat-page"),this},t}(),USER_MENU=[{icon:"eye",text:"查看资料"},{icon:"bookmark",text:"移动好友"},{icon:"trash",text:"删除好友"}];function registerChat(n){var t=new ChatRoom($(".dialog-chat"));t.on(EVENT_REFRESH_USERS,function(e){postJson(n+"friend",function(t){200==t.code&&(e.friends=t.data)})}).on(EVENT_REFRESH_GROUPS,function(e){postJson(n+"group",function(t){200==t.code&&(e.groups=t.data)})}).on(EVENT_SEARCH_USERS,function(t,e){postJson(n+"friend/search",{keywords:t},function(t){200==t.code&&(e.users=t.data)})}).init(),$(".dialog-box").on("click",".dialog-header .fa-close",function(){$(this).closest(".dialog-box").hide()}),$("#toggle-btn").click(function(){t.toggleMode()})}