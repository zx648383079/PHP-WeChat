var ChatMenu=function(){function t(t,i){void 0===i&&(i=[]),this.box=t,this.menus=i,this.events={},this.bindEvent()}return t.prototype.bindEvent=function(){var t=this;this.box.on("click","li",function(){t.clickLi($(this))})},t.prototype.clickLi=function(t){var i,n=t.attr("data-name");n&&this.menuMap.hasOwnProperty(n)&&(i=this.menuMap[n])&&i.onclick&&i.onclick(t),n&&this.hasEvent(n)&&this.trigger(n,t,i),this.trigger("click",t,i)},t.prototype.addMenu=function(t){return this.menus.push(t),this},t.prototype.show=function(t,i){return this.refresh(),this.box.css({left:t+"px",top:i+"px"}).show(),this},t.prototype.hide=function(){this.box.hide()},t.prototype.refresh=function(){this.menuMap={};var t=this.cleanMenuList(this.menus),i=t?this.getMenuHtml(t):"";this.box.html(i)},t.prototype.getMenuHtml=function(t){var i=this,n="";return t.forEach(function(t){n+=i.getMenuItemHtml(t)}),"<ul>"+n+"</ul>"},t.prototype.getMenuItemHtml=function(t){var i=t.text||t.name,n='<li data-name="'+i+'"><span><i class="fa fa-'+t.icon+'"></i>'+(t.text||t.name),e=this.cleanMenuList(t.children);return this.menuMap[i]=t,e&&e.length>0?n+'<i class="fa fa-chevron-right"></i></span>'+this.getMenuHtml(e)+"</li>":n+"</span></li>"},t.prototype.cleanMenuList=function(t){if(!t||0==t.length)return null;var i=[];return t.forEach(function(t){t.toggle&&!1===t.toggle()||i.push(t)}),i},t.prototype.on=function(t,i){return this.events[t]=i,this},t.prototype.hasEvent=function(t){return this.events.hasOwnProperty(t)},t.prototype.trigger=function(t){for(var i,n=[],e=1;e<arguments.length;e++)n[e-1]=arguments[e];if(this.hasEvent(t))return(i=this.events[t]).call.apply(i,[this].concat(n))},t}(),ChatAddUserBox=function(){function t(t,i){this.box=t,this.parent=i}return t.prototype.show=function(){this.box.show()},t}(),ChatUserInfoBox=function(){function t(t,i){this.box=t,this.parent=i}return t.prototype.show=function(){this.box.show()},t}(),ChatSearchBox=function(){function t(t,i){this.box=t,this.parent=i,this.bindEvent()}return t.prototype.bindEvent=function(){var t=this;this.box.on("click",".dialog-search-list .dialog-info",function(){t.parent.addBox.show()}),this.box.on("click",".dialog-tab-header .dialog-tab-item",function(){$(this).addClass("active").siblings().removeClass("active")})},t.prototype.show=function(){this.box.show()},t}(),ChatEditor=function(){function t(t,i){this.box=t,this.parent=i}return t.prototype.insertHtmlAtCaret=function(t){var i,n,e=this.box;if(e.is(":focus")||(e.focus(),(n=document.createRange()).setStartAfter(e[0]),n.setEnd(e[0],e[0].childNodes.length)),window.getSelection&&(i=window.getSelection()).getRangeAt&&i.rangeCount){n||(n=i.getRangeAt(0)).deleteContents();var o=document.createElement("div");o.innerHTML=t;for(var s,a,h=document.createDocumentFragment();s=o.firstChild;)a=h.appendChild(s);n.insertNode(h),a&&((n=n.cloneRange()).setStartAfter(a),n.collapse(!0),i.removeAllRanges(),i.addRange(n))}},t}(),ChatMessageBox=function(){function t(t,i){this.box=t,this.parent=i,this.refresh(),this.bindEvent()}return t.prototype.refresh=function(){this.editor=new ChatEditor(this.box.find(".dialog-message-text"),this)},t.prototype.bindEvent=function(){var t=this;this.box.on("click",".fa-smile-o",function(){t.editor.insertHtmlAtCaret('<img src="./image/avatar.jpg" alt="">')})},t}(),ChatUserBox=function(){function t(t,i){this.box=t,this.parent=i,this.refresh(),this.bindEvent()}return t.prototype.refresh=function(){this.menu=new ChatMenu(this.box.find(".dialog-menu"),USER_MENU)},t.prototype.bindEvent=function(){var t=this;$(document).click(function(){t.menu.hide()}),this.box.click(function(){$(this).hasClass("dialog-min")&&$(this).removeClass("dialog-min")}),this.box.on("click",".dialog-header .fa-minus",function(i){i.stopPropagation(),t.box.addClass("dialog-min")}),this.box.on("click",".dialog-header .fa-plus",function(){t.parent.searchBox.show()}),this.box.on("click",".dialog-tab .dialog-tab-header .dialog-tab-item",function(){var t=$(this);t.addClass("active").siblings().removeClass("active"),t.closest(".dialog-tab").find(".dialog-tab-box .dialog-tab-item").eq(t.index()).addClass("active").siblings().removeClass("active")}),this.box.on("click",".dialog-panel .dialog-panel-header",function(){$(this).closest(".dialog-panel").toggleClass("expanded")}),this.box.on("click",".dialog-tab .dialog-user",function(){$(this).closest(".dialog-chat").find(".dialog-chat-room").show()}),this.box.on("contextmenu",".dialog-tab .dialog-user",function(i){return t.menu.show(i.clientX,i.clientY),!1}),this.menu.on("click",function(){console.log(arguments),t.parent.userBox.show()})},t}(),ChatRoom=function(){function t(t){this.target=t,this.refresh()}return t.prototype.refresh=function(){this.mainBox=new ChatUserBox(this.target.find(".dialog-chat-box"),this),this.addBox=new ChatAddUserBox(this.target.find(".dialog-add-box"),this),this.userBox=new ChatUserInfoBox(this.target.find(".dialog-user-box"),this),this.searchBox=new ChatSearchBox(this.target.find(".dialog-search-box"),this),this.chatBox=new ChatMessageBox(this.target.find(".dialog-chat-room"),this)},t}(),USER_MENU=[{icon:"eye",text:"查看资料"},{icon:"bookmark",text:"移动好友"},{icon:"trash",text:"删除好友"}];new ChatRoom($(".dialog-chat-page")),$(function(){$(".dialog-box").on("click",".dialog-header .fa-close",function(){$(this).closest(".dialog-box").hide()})});