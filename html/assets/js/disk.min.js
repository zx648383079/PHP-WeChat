function sortBy(i,s){return void 0===s&&(s=1),function(e,t){return(e=e[i])<(t=t[i])?-1*s:t<e?+s:0}}function require_disk(r,c){var s=new Vue({el:"#shareModal",data:{modeType:0,users:[],selectUsers:[],role:null,name:null,result:null},methods:{share:function(){var i;n.length<1||(i=[],2==this.modeType&&$(this.selectUsers).each(function(e,t){i.push(t.id)}),postJson(r+"disk/share",{id:n,mode:this.modeType,user:i,role:this.role},function(e){200==e.code&&(this.modeType=0,s.result=e.data.url,1==e.data.mode&&(s.result+=" 密码："+e.data.password))}))},getUser:function(){this.name&&$.getJSON(r+"disk/users?name="+this.name,function(e){200==e.code&&$(e.data).each(function(e,t){t.select=!1,s.selectUsers.push(t)})})},getUsers:function(){$.getJSON(r+"disk/users",function(e){200==e.code&&$(e.data).each(function(e,t){t.select=!1,s.users.push(t)})})},select:function(){for(var e=this.users.length-1;0<=e;e--){var t=this.users[e];t.select&&(this.selectUsers.push(t),this.users.splice(e,1))}},remove:function(){for(var e=this.selectUsers.length-1;0<=e;e--){var t=this.selectUsers[e];t.select&&(this.users.push(t),this.selectUsers.splice(e,1))}},create:function(e){1!=e&&(e=0),this.modeType=e,this.share()},show:function(){this.result=0,e.show()}}});s.getUsers(),$(".zd_role_tree li").click(function(e){$(".zd_role_tree li").removeClass("active"),$(this).addClass("active"),s.role=$(this).attr("data-id"),e.stopPropagation()});var o={},e=$("#shareModal").dialog(),t=$("#folderModal").dialog(),i=null,u=new Vue({el:"#content",data:{files:[],checkCount:0,isAllChecked:!1,isList:!0,orderKey:null,order:null,category:null,page:1,perPage:20,hasMore:!0,isLoading:!1,crumb:[{id:0,name:"全部文件"}]},computed:{sortFiles:function(){return this.orderKey?this.files.sort(sortBy(this.orderKey,this.order)):this.files}},methods:{goPage:function(t){var i=this;this.checkCount=0,this.isAllChecked=!1;var s,e=this.getParent(),n=this.getTag(e);!o.hasOwnProperty(n)||this.hasMore?(s=Dialog.loading(),$.getJSON(r+"disk/list",{id:e,type:this.category,page:t,per_page:this.perPage},function(e){200==e.code&&(1<t&&o.hasOwnProperty(n)?Array.prototype.push.apply(o[n],e.data):o[n]=e.data,i.hasMore=e.paging.more,i.page=t,i.isLoading=!1,u.addData(e.data,t<2),s.close())})):this.addData(o[n])},tapMore:function(){this.hasMore&&this.goPage(this.page+1)},tapRefresh:function(){this.goPage(1)},getTag:function(e){return void 0===e&&(e=this.getParent()),"c"+this.category+e},addData:function(e,t){for(var i in void 0===t&&(t=!0),t&&this.files.splice(0),e){var s=e[i];s.checked=!1,this.files.push(s)}},setOrder:function(e){if(e!=this.orderKey)return this.orderKey=e,void(this.order=1);this.order*=-1},setList:function(e){this.isList=e},checkAll:function(){var e=this.files.length;this.isAllChecked?(this.isAllChecked=!1,this.checkCount=0):(this.isAllChecked=!0,this.checkCount=e);for(var t=0;t<e;t++)this.files[t].checked=this.isAllChecked},enter:function(e){return 0!=e.file_id&&e.file?3!=e.file.type&&7!=e.file.type?5==e.file.type?((i=i||new APlayer({container:document.getElementById("player"),fixed:!0,audio:[]})).list.add({name:e.name,artist:"未知",url:e.file.url,cover:e.file.thumb||"/assets/images/favicon.png"}),i.skipBack(),void i.play()):void this.check(e):void window.open(e.file.url,"_blank"):(this.crumb.push(e),void this.tapRefresh())},top:function(){this.crumb.pop(),this.tapRefresh()},level:function(e){if(0==e.id)this.crumb.splice(1);else for(var t=1,i=this.crumb.length;t<i;t++)if(e.id==this.crumb[t].id){this.crumb.splice(t+1);break}this.tapRefresh()},refresh:function(){this.deleteCache(),this.tapRefresh()},check:function(e){if(e.checked=!e.checked,!e.checked)return this.isAllChecked=!1,void this.checkCount--;this.checkCount++;for(var t=0,i=this.files.length;t<i;t++)if(!this.files[t].checked)return;this.isAllChecked=!0},deleteItem:function(s){postJson(r+"disk/delete",{id:s.id},function(e){if(200==e.code){u.deleteCache(s);for(var t=0,i=u.files.length;t<i;t++)if(u.files[t].id==s.id)return void u.files.splice(t,1)}})},deleteCache:function(e,t){"object"==typeof e&&(t=e,e=-1),(e<0||void 0===e)&&(e=this.getParent());var i=this.getTag(e);if(o.hasOwnProperty(i))if(void 0!==t)for(var s=o[i].length-1;0<=s;s--){var n=o[i][s];if(t instanceof Array)for(var a=t.length-1;0<=a;a--)n.id==t[a]&&(o[i].splice(s,1),t.splice(a,s));else if("object"==typeof t){if(t.id==n.id)return void o[i].splice(s,1)}else if(n.id==t)return void o[i].splice(s,1)}else delete o[i]},getParent:function(){return this.crumb[this.crumb.length-1].id},getParentItem:function(){return this.crumb[this.crumb.length-1]},addItem:function(e){"object"==typeof e&&(this.files.push(e),o[this.getTag()].push(e))},deleteAll:function(){for(var t=[],e=this.files.length-1;0<=e;e--)this.files[e].checked&&(t.push(this.files[e].id),this.files.splice(e,1));this.checkCount=0,this.isAllChecked&&(this.isAllChecked=!1),postJson(r+"disk/delete",{id:t},function(e){200==e.code&&this.deleteCache(this.getParent(),t)})},share:function(e){n=[e.id],s.show()},shareAll:function(){n=[];for(var e=this.files.length-1;0<=e;e--)this.files[e].checked&&n.push(this.files[e].id);n.length<1?alert("请选择文件"):s.show()},download:function(e){var t;0!=e.file_id?(t=r+"download?id="+e.id,(e=$(".downloadFrame")).length<1&&((e=document.createElement("iframe")).className="downloadFrame",document.body.appendChild(e),e=$(e)),e.attr("src",t),e.hide()):alert("暂不支持文件夹下载！")},downloadAll:function(){},move:function(e){t.show(),n=[e.id],a=0},moveAll:function(){t.show(),n=[],a=0;for(var e=this.files.length-1;0<=e;e--)this.files[e].checked&&n.push(this.files[e].id)},copy:function(e){t.show(),n=[e.id],a=1},copyAll:function(){t.show(),n=[],a=1;for(var e=this.files.length-1;0<=e;e--)this.files[e].checked&&n.push(this.files[e].id)},rename:function(e){if(e)return e.is_edit=!0,void(e.new_name=e.name);for(var t=this.files.length-1;0<=t;t--){var i=this.files[t];i.checked&&(i.is_edit=!0,i.new_name=e.name)}},closeEdit:function(e){e.is_edit=!1},saveEdit:function(s){s.new_name?postJson(r+"disk/rename",{name:s.name,id:s.id},function(i){200==i.code?(s.name=s.new_name,$(o[u.getTag()]).each(function(e,t){t.id==s.id&&(t.name=s.name,t.updated_at=i.updated_at)})):parseAjax(i)}):Dialog.tip("文件名不能为空！")},load:function(e){e=1<(e=e.split("#")).length?parseInt(e[1].substr(5)):null,this.category=e,this.offset=0,this.crumb.splice(1),this.tapRefresh()}}});u.load(window.location.hash),$(u.$el).show(),$(".navbar a").click(function(){u.load($(this).attr("href"))}),$("[data-type=create]").click(function(){var t=!1,i=Dialog.form({name:"名称"},"新建文件夹").on("done",function(){t||(t=!0,postJson(r+"disk/create",{name:this.data.name,parent_id:u.getParent()},function(e){return 200!=e.code?(parseAjax(e),void(t=!1)):(i.close(),u.files.push(e.data),void o[u.getTag()].push(e.data))}))})});var n=[],a=0,h=0;$(".tree-box").on("click",".tree-item",function(e){e.stopPropagation(),$(".tree-box li").removeClass("active");var t=$(this),n=t.parent();h=n.attr("data-id"),n.addClass("active"),t.hasClass("empty")||(n.hasClass("open")?n.removeClass("open"):(n.addClass("open"),0<n.find("ul").length||$.getJSON(r+"disk/folder?id="+h,function(e){var i,s;200==e.code&&(e.data.length<1?t.addClass("empty"):(i="",s=parseInt(t.css("padding-left"))+16+"px",$(e.data).each(function(e,t){i+='<li data-id="'+t.id+'"><div class="tree-item" style="padding-left: '+s+'"><span></span><span></span><span>'+t.name+"</span></div></li>"}),n.append("<ul>"+i+"</ul>")))})))}),t.on("done",function(){this.hide(),n.length<1||postJson(r+"disk/move",{id:n,parent:h,mode:a},function(e){200==e.code&&(0==a?u.refresh():u.deleteCache(h))})});"undefined"==typeof File||File.prototype.slice||(File.prototype.webkitSlice&&(File.prototype.slice=File.prototype.webkitSlice),File.prototype.mozSlice&&(File.prototype.slice=File.prototype.mozSlice)),window.File&&window.FileReader&&window.FileList&&window.Blob&&File.prototype.slice||alert("File APIs are not fully supported in this browser. Please use latest Mozilla Firefox or Google Chrome.");function d(s){var n=g.files[s],a=new XMLHttpRequest;a.upload&&(a.upload.addEventListener("progress",function(e){n.process=parseInt(100*e.loaded/e.total)},!1),a.onreadystatechange=function(e){var t,i;4==a.readyState&&(200==a.status&&200==(t=$.parseJSON(a.responseText)).code?(n.status=3,n.type=t.data.type,t=s,i=g.files[t],postJson(r+"disk/add",{md5:i.md5,name:i.name,parent_id:u.getParent(),type:i.type,size:i.size,temp:i.temp},function(e){return 200==e.code?(u.addItem(e.data),void(i.status=3)):void(i.status=7)})):n.status=7)},n.status=2,n.process=0,a.open("POST",r+"upload",!0),a.setRequestHeader("X-FILENAME",n.md5),a.send(n.file))}function f(s){return function(e){var t,i;e.data.result?(g.files[s].status=1,g.files[s].process=0,g.files[s].md5=e.data.result,t=s,i=g.files[t],postJson(r+"disk/check",{md5:i.md5,name:i.name,parent_id:u.getParent()},function(e){return 200==e.code?(i.status=4,void u.addItem(e.data)):void(2==e.code&&d(t))})):g.files[s].process=Math.floor(100*e.data.block.end/e.data.block.file_size)}}function l(e){e.stopPropagation(),e.preventDefault(),g.mode=2;for(var t=(e.dataTransfer||e.target).files,i=0;i<t.length;i++)g.addItem(t[i])}var p=[],g=new Vue({el:"#upload",data:{title:"上传",files:[],mode:0},methods:{deleteItem:function(e){p[e]instanceof Worker&&p[e].terminate(),p.splice(e,1),this.files.splice(e,1)},addItem:function(e){var t=new Object;t.name=e.name,t.type=e.type,t.size=e.size,t.status=0,t.process=0,t.md5=null;var i=u.getParentItem();if(t.parent_id=i.id,t.parent_name=i.name,t.file=e,this.files.push(t),734003200<e.size)return t.status=9,void p.push("");var s,n,a,r,o,h,d,l,i=this.files.length-1,t=new Worker(c);t.addEventListener("message",f(i)),p.push(t),n=i,h=function(e){a+=1,p[n].postMessage({message:e.target.result,block:l})},i=function(e){0===--a&&l.end!==s.size&&(l.start+=d,l.end+=d,l.end>s.size&&(l.end=s.size),(r=new FileReader).onload=h,o=s.slice(l.start,l.end),r.readAsArrayBuffer(o))},d=1048576,(l={file_size:(s=e).size,start:0}).end=d>s.size?s.size:d,a=0,p[n].addEventListener("message",i),(r=new FileReader).onload=h,o=s.slice(l.start,l.end),r.readAsArrayBuffer(o)}}});$(".uploadFile").click(function(){var e=$(".uploadFiles");e.length<1?((e=document.createElement("input")).type="file",e.className="uploadFiles",e.multiple="true",document.body.appendChild(e),$(e).bind("change",l).hide()):(e.val(""),e.attr("multiple","true")),e.click(),g.mode=2}),$(".uploadFolder").click(function(){var e=$(".uploadFolders");e.length<1?((e=document.createElement("input")).type="file",e.className="uploadFolders",e.webkitdirectory="true",document.body.appendChild(e),$(e).bind("change",l).hide()):(e.val(""),e.attr("webkitdirectory","true")),e.click(),g.mode=2});var m=document.getElementById("upload");m.addEventListener("dragover",function(e){e.stopPropagation(),e.preventDefault()},!1),m.addEventListener("drop",l,!1)}function require_my_share(n){var a=new Vue({el:"#content",data:{files:[],checkCount:0,isAllChecked:!1,orderKey:null,order:null,page:1,perPage:20,hasMore:!0,isLoading:!1},computed:{sortFiles:function(){return this.files.sort(sortBy(this.orderKey,this.order))}},methods:{goPage:function(t){var i=this;this.checkCount=0,this.isAllChecked=!1;var s=Dialog.loading();$.getJSON(n+"share/mylist",{page:t,per_page:this.perPage},function(e){200==e.code&&(a.addData(e.data),i.hasMore=e.paging.more,i.page=t,i.isLoading=!1,s.close())})},tapMore:function(){this.hasMore&&this.goPage(this.page+1)},tapRefresh:function(){this.goPage(1)},addData:function(e){for(var t in e){var i=e[t];i.checked=!1,this.files.push(i)}this.offset=this.files.length},setOrder:function(e){if(e!=this.orderKey)return this.orderKey=e,void(this.order=1);this.order*=-1},checkAll:function(){var e=this.files.length;this.isAllChecked?(this.isAllChecked=!1,this.checkCount=0):(this.isAllChecked=!0,this.checkCount=e);for(var t=0;t<e;t++)this.files[t].checked=this.isAllChecked},check:function(e){if(e.checked=!e.checked,!e.checked)return this.isAllChecked=!1,void this.checkCount--;this.checkCount++;for(var t=0,i=this.files.length;t<i;t++)if(!this.files[t].checked)return;this.isAllChecked=!0},deleteItem:function(e){var i=[];0==e?$(this.files).each(function(e,t){t.checked&&i.push(t.id)}):i=[e.id],postJson(n+"share/cancel",{id:i},function(e){200==e.code&&a.removeItem(i)})},removeItem:function(e){for(var t=this.files.length-1;0<=t;t--)for(var i=e.length-1;0<=i;i--)this.files[t].id==e[i]&&(this.files[t].checked&&this.checkCount--,this.files.splice(t,1),e.splice(i,1))}}});a.tapRefresh()}function require_trash(s){var n=new Vue({el:"#content",data:{files:[],checkCount:0,isAllChecked:!1,orderKey:null,order:null,page:1,perPage:20,hasMore:!0},computed:{sortFiles:function(){return this.files.sort(sortBy(this.orderKey,this.order))}},methods:{goPage:function(t){this.checkCount=0,this.isAllChecked=!1;var i=Dialog.loading();$.getJSON(s+"trash/list",{page:t,per_page:this.perPage},function(e){200==e.code&&(this.hasMore=e.paging.more,this.page=t,this.isLoading=!1,n.addData(e.data),i.close())})},tapMore:function(){this.hasMore&&this.goPage(this.page+1)},tapRefresh:function(){this.goPage(1)},addData:function(e){for(var t in e){var i=e[t];i.checked=!1,this.files.push(i)}this.offset=this.files.length},setOrder:function(e){if(e!=this.orderKey)return this.orderKey=e,void(this.order=1);this.order*=-1},checkAll:function(){var e=this.files.length;this.isAllChecked?(this.isAllChecked=!1,this.checkCount=0):(this.isAllChecked=!0,this.checkCount=e);for(var t=0;t<e;t++)this.files[t].checked=this.isAllChecked},check:function(e){if(e.checked=!e.checked,!e.checked)return this.isAllChecked=!1,void this.checkCount--;this.checkCount++;for(var t=0,i=this.files.length;t<i;t++)if(!this.files[t].checked)return;this.isAllChecked=!0},reset:function(e){var i=[];0==e?$(this.files).each(function(e,t){t.checked&&i.push(t.id)}):i=[e.id],postJson(s+"trash/reset",{id:i},function(e){200==e.code&&n.removeItem(i)})},deleteItem:function(e){var i=[];0==e?$(this.files).each(function(e,t){t.checked&&i.push(t.id)}):i=[e.id],postJson(s+"trash/delete",{id:i},function(e){200==e.code&&n.removeItem(i)})},clear:function(){$.getJSON(s+"trash/clear",function(e){200==e.code&&n.files.splice(0)})},removeItem:function(e){for(var t=this.files.length-1;0<=t;t--)for(var i=e.length-1;0<=i;i--)this.files[t].id==e[i]&&(this.files[t].checked&&this.checkCount--,this.files.splice(t,1),e.splice(i,1))}}});n.tapRefresh()}function require_share(a,r){var o={},t=$("#folderModal").dialog(),h=new Vue({el:"#content",data:{files:[],checkCount:0,isAllChecked:!1,isList:!0,orderKey:null,order:null,page:1,perPage:20,hasMore:!0,crumb:[{id:0,name:"全部文件"}]},computed:{sortFiles:function(){return this.orderKey?this.files.sort(sortBy(this.orderKey,this.order)):this.files}},methods:{goPage:function(t){var i=this;this.checkCount=0,this.isAllChecked=!1;var s,e=this.getParent(),n=this.getTag(e);!o.hasOwnProperty(n)||this.hasMore?(s=Dialog.loading(),$.getJSON(a+"share/list",{id:e,share:r,page:t,per_page:this.perPage},function(e){200==e.code&&(1<t?Array.prototype.push.apply(o[n],e.data):o[n]=e.data,i.hasMore=e.paging.more,i.page=t,i.isLoading=!1,h.addData(e.data,t<2),s.hide())})):this.addData(o[n])},tapMore:function(){this.hasMore&&this.goPage(this.page+1)},tapRefresh:function(){this.goPage(1)},getTag:function(e){return void 0===e&&(e=this.getParent()),e},addData:function(e,t){for(var i in void 0===t&&(t=!0),t&&this.files.splice(0),e){var s=e[i];s.checked=!1,this.files.push(s)}this.offset=this.files.length},setOrder:function(e){if(e!=this.orderKey)return this.orderKey=e,void(this.order=1);this.order*=-1},setList:function(e){this.isList=e},checkAll:function(){var e=this.files.length;this.isAllChecked?(this.isAllChecked=!1,this.checkCount=0):(this.isAllChecked=!0,this.checkCount=e);for(var t=0;t<e;t++)this.files[t].checked=this.isAllChecked},enter:function(e){1==e.is_dir?(this.crumb.push(e),this.offset=0,this.tapRefresh()):this.check(e)},top:function(){this.crumb.pop(),this.offset=0,this.tapRefresh()},level:function(e){if(0==e.id)this.crumb.splice(1);else for(var t=1,i=this.crumb.length;t<i;t++)if(e.id==this.crumb[t].id){this.crumb.splice(t+1);break}this.offset=0,this.tapRefresh()},refresh:function(){this.deleteCache(),this.tapRefresh()},check:function(e){if(e.checked=!e.checked,!e.checked)return this.isAllChecked=!1,void this.checkCount--;this.checkCount++;for(var t=0,i=this.files.length;t<i;t++)if(!this.files[t].checked)return;this.isAllChecked=!0},deleteCache:function(e,t){"object"==typeof e&&(t=e,e=-1),(e<0||void 0===e)&&(e=this.getParent());var i=this.getTag(e);if(o.hasOwnProperty(i))if(void 0!==t)for(var s=o[i].length-1;0<=s;s--){var n=o[i][s];if(t instanceof Array)for(var a=t.length-1;0<=a;a--)n.id==t[a]&&(o[i].splice(s,1),t.splice(a,s));else if("object"==typeof t){if(t.id==n.id)return void o[i].splice(s,1)}else if(n.id==t)return void o[i].splice(s,1)}else delete o[i]},getParent:function(){return this.crumb[this.crumb.length-1].id},getParentItem:function(){return this.crumb[this.crumb.length-1]},cancel:function(){postJson(a+"share/cancel",{id:[r]},function(e){200==e.code&&(window.location.href=a)})},download:function(e){var t;1!=e.is_dir?(t=a+"download?id="+e.id,(e=$(".downloadFrame")).length<1&&((e=document.createElement("iframe")).className="downloadFrame",document.body.appendChild(e),e=$(e)),e.attr("src",t),e.hide()):alert("暂不支持文件夹下载！")},downloadAll:function(){alert("暂不支持多文件下载!")},save:function(e){t.show(),i=[e.id],0},saveAll:function(){t.show(),i=[],0;for(var e=this.files.length-1;0<=e;e--)this.files[e].checked&&i.push(this.files[e].id)}}});h.tapRefresh();var i=[],s=0;$(".zd_tree").on("click",".zd_tree_item",function(e){e.stopPropagation(),$(".zd_tree li").removeClass("active");var t=$(this),n=t.parent();s=n.attr("data-id"),n.addClass("active"),t.hasClass("empty")||(n.hasClass("open")?n.removeClass("open"):(n.addClass("open"),0<n.find("ul").length||$.getJSON(a+"disk/folder?id="+s,function(e){var i,s;200==e.code&&(e.data.length<1?t.addClass("empty"):(i="",s=parseInt(t.css("padding-left"))+30+"px",$(e.data).each(function(e,t){i+='<li data-id="'+t.id+'"><div class="zd_tree_item" style="padding-left: '+s+'"><span></span><span></span><span>'+t.name+"</span></div></li>"}),n.append("<ul>"+i+"</ul>")))})))}),t.on("done",function(){t.hide(),i.length<1||postJson(a+"share/save",{id:r,file:i,parent:s},function(e){parseAjax(e)})})}Vue.filter("time",function(e){if(e){if(!/^\d+$/.test(e))return e;var t=new Date;return t.setTime(1e3*parseInt(e)),t.getFullYear()+"-"+(t.getMonth()+1)+"-"+t.getDate()+" "+t.getHours()+":"+t.getMinutes()}}),Vue.filter("size",function(e){if(!e)return"--";if(0==(e=parseFloat(e)))return"0 B";var t=Math.floor(Math.log(e)/Math.log(1e3));return(e/Math.pow(1e3,t)).toPrecision(3)+" "+["B","KB","MB","GB","TB","PB","EB","ZB","YB"][t]}),Vue.filter("status",function(e){switch(e){case 0:return"文件校验中";case 1:return"校验完成";case 2:return"文件上传中";case 3:return"上传成功！";case 4:return"秒传！";case 9:return"文件太大了！";case 7:default:return"上传失败！"}});