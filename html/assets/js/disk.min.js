Vue.filter("time",function(e){if(e){var t=new Date;return t.setTime(1e3*parseInt(e)),t.toLocaleString()}}),Vue.filter("size",function(e){if(!e)return"--";e=parseFloat(e);var t=Math.floor(Math.log(e)/Math.log(1e3));return(e/Math.pow(1e3,t)).toPrecision(3)+" "+["B","KB","MB","GB","TB","PB","EB","ZB","YB"][t]}),Vue.filter("status",function(e){switch(e){case 0:return"文件校验中";case 1:return"校验完成";case 2:return"文件上传中";case 3:return"上传成功！";case 4:return"秒传！";case 9:return"文件太大了！";case 7:default:return"上传失败！"}});function sortBy(e,t){return void 0===t&&(t=1),function(i,s){return(i=i[e])<(s=s[e])?-1*t:i>s?1*t:0}}function require_disk(e,t){var i=new Vue({el:"#shareModal",data:{modeType:"public",users:[],selectUsers:[],role:null,name:null},methods:{share:function(){if(!(r.length<1)){var t=[];"private"==this.modeType&&$(this.selectUsers).each(function(e,i){t.push(i.id)}),postJson(e+"disk/share",{id:r,mode:this.modeType,user:t,role:this.role},function(e){200==e.code&&($("#result input").val(e.data.url),"protected"==e.data.mode&&$("#result .row").append('密码：<input type="text" value="'+e.data.password+'" class="form-control" readonly>'),$("#shareModal .nav-tabs li").removeClass("active"),$("#shareModal #result").addClass("active").siblings().removeClass("active"))})}},getUser:function(){this.name&&$.getJSON(e+"disk/users?name="+this.name,function(e){200==e.code&&$(e.data).each(function(e,t){t.select=!1,i.selectUsers.push(t)})})},getUsers:function(){$.getJSON(e+"disk/users",function(e){200==e.code&&$(e.data).each(function(e,t){t.select=!1,i.users.push(t)})})},select:function(){for(var e=this.users.length-1;e>=0;e--){var t=this.users[e];t.select&&(this.selectUsers.push(t),this.users.splice(e,1))}},remove:function(){for(var e=this.selectUsers.length-1;e>=0;e--){var t=this.selectUsers[e];t.select&&(this.users.push(t),this.selectUsers.splice(e,1))}},create:function(e){"protected"!=e&&(e="public"),this.modeType=e,this.share()}}});$(".zd_role_tree li").click(function(e){$(".zd_role_tree li").removeClass("active"),$(this).addClass("active"),i.role=$(this).attr("data-id"),e.stopPropagation()});var s={},n=$("#shareModal").dialog();folderBox=$("#folderModal").dialog(),downloadFile=function(e){var t=$(".downloadFrame");t.length<1&&((t=document.createElement("iframe")).className="downloadFrame",document.body.appendChild(t),t=$(t)),t.attr("src",e),t.hide()};var o=new Vue({el:"#content",data:{files:[],checkCount:0,isAllChecked:!1,isList:!0,orderKey:null,order:null,category:null,offset:0,num:20,crumb:[{id:0,name:"全部文件"}]},computed:{sortFiles:function(){return this.files.sort(sortBy(this.orderKey,this.order))}},methods:{getList:function(){this.checkCount=0,this.isAllChecked=!1;var t=this.getParent(),i=this.getTag(t),n=this.offset>0&&this.offset+this.num>this.files.length;if(!s.hasOwnProperty(i)||n){var r=Dialog.loading();$.getJSON(e+"disk/list?id="+t+"&type="+this.category+"&offset="+this.offset+"&length="+this.num,function(e){200==e.code&&(n&&s.hasOwnProperty(i)?Array.prototype.push.apply(s[i],e.data):s[i]=e.data,o.addData(e.data,!n),r.close())})}else this.addData(s[i])},getMore:function(e){void 0===e&&(e=20),this.num=e,this.getList()},getTag:function(e){return void 0===e&&(e=this.getParent()),"c"+this.category+e},addData:function(e,t){void 0===t&&(t=!0),t&&this.files.splice(0);for(var i in e){var s=e[i];s.checked=!1,this.files.push(s)}this.offset=this.files.length},setOrder:function(e){if(e!=this.orderKey)return this.orderKey=e,void(this.order=1);this.order*=-1},setList:function(e){this.isList=e},checkAll:function(){var e=this.files.length;this.isAllChecked?(this.isAllChecked=!1,this.checkCount=0):(this.isAllChecked=!0,this.checkCount=e);for(var t=0;t<e;t++)this.files[t].checked=this.isAllChecked},enter:function(e){e.file_id>0?this.check(e):(this.crumb.push(e),this.offset=0,this.getList())},top:function(){this.crumb.pop(),this.offset=0,this.getList()},level:function(e){if(0==e.id)this.crumb.splice(1);else for(var t=1,i=this.crumb.length;t<i;t++)if(e.id==this.crumb[t].id){this.crumb.splice(t+1);break}this.offset=0,this.getList()},refresh:function(){this.deleteCache(),this.offset=0,this.getList()},check:function(e){if(e.checked=!e.checked,!e.checked)return this.isAllChecked=!1,void this.checkCount--;this.checkCount++;for(var t=0,i=this.files.length;t<i;t++)if(!this.files[t].checked)return;this.isAllChecked=!0},deleteItem:function(t){postJson(e+"disk/delete",{id:t.id},function(e){if(200==e.code){o.deleteCache(t);for(var i=0,s=o.files.length;i<s;i++)if(o.files[i].id==t.id)return void o.files.splice(i,1)}})},deleteCache:function(e,t){"object"==typeof e&&(t=e,e=-1),(e<0||void 0===e)&&(e=this.getParent());var i=this.getTag(e);if(s.hasOwnProperty(i))if(void 0!==t)for(var n=s[i].length-1;n>=0;n--){var o=s[i][n];if(t instanceof Array)for(var r=t.length-1;r>=0;r--)o.id==t[r]&&(s[i].splice(n,1),t.splice(r,n));else if("object"==typeof t){if(t.id==o.id)return void s[i].splice(n,1)}else if(o.id==t)return void s[i].splice(n,1)}else delete s[i]},getParent:function(){return this.crumb[this.crumb.length-1].id},getParentItem:function(){return this.crumb[this.crumb.length-1]},addItem:function(e){"object"==typeof e&&(this.files.push(e),s[this.getTag()].push(e))},deleteAll:function(){for(var t=[],i=this.files.length-1;i>=0;i--)this.files[i].checked&&(t.push(this.files[i].id),this.files.splice(i,1));this.checkCount=0,this.isAllChecked&&(this.isAllChecked=!1),postJson(e+"disk/delete",{id:t},function(e){200==e.code&&this.deleteCache(this.getParent(),t)})},share:function(e){r=[e.id],n.show()},shareAll:function(){r=[];for(var e=this.files.length-1;e>=0;e--)this.files[e].checked&&r.push(this.files[e].id);r.length<1?alert("请选择文件"):n.show()},download:function(t){1!=t.is_dir?downloadFile(e+"disk/download?id="+t.id):alert("暂不支持文件夹下载！")},downloadAll:function(){},move:function(e){folderBox.show(),r=[e.id],a=0},moveAll:function(){folderBox.show(),r=[],a=0;for(var e=this.files.length-1;e>=0;e--)this.files[e].checked&&r.push(this.files[e].id)},copy:function(e){folderBox.show(),r=[e.id],a=1},copyAll:function(){folderBox.show(),r=[],a=1;for(var e=this.files.length-1;e>=0;e--)this.files[e].checked&&r.push(this.files[e].id)},rename:function(e){if(console.log(e),e)return e.is_edit=!0,void(e.new_name=e.name);for(var t=this.files.length-1;t>=0;t--){var i=this.files[t];i.checked&&(i.is_edit=!0,i.new_name=e.name)}},closeEdit:function(e){e.is_edit=!1},saveEdit:function(t){t.new_name?postJson(e+"disk/rename",{name:t.name,id:t.id},function(e){200==e.code?(t.name=t.new_name,$(s[o.getTag()]).each(function(i,s){s.id==t.id&&(s.name=t.name,s.updated_at=e.updated_at)})):parseAjax(e)}):Dialog.tip("文件名不能为空！")},load:function(e){e=(e=e.split("#")).length>1?parseInt(e[1].substr(5)):null,this.category=e,this.offset=0,this.crumb.splice(1),this.getList()}}});o.load(window.location.hash),$(".disk-menu a").click(function(){o.load($(this).attr("href"))}),$("[data-type=create]").click(function(){var t=Dialog.form({name:"名称"},"新建文件夹").on("done",function(){postJson(e+"disk/create",{name:this.data.name,parent_id:o.getParent()},function(e){200==e.code?(t.close(),o.files.push(e.data),s[o.getTag()].push(e.data)):parseAjax(e)})})});var r=[],a=0,l=0;$(".tree-box").on("click",".tree-item",function(t){t.stopPropagation(),$(".tree-box li").removeClass("active");var i=$(this),s=i.parent();l=s.attr("data-id"),s.addClass("active"),i.hasClass("empty")||(s.hasClass("open")?s.removeClass("open"):(s.addClass("open"),s.find("ul").length>0||$.getJSON(e+"disk/folder?id="+l,function(e){if(200==e.code)if(e.data.length<1)i.addClass("empty");else{var t="",n=parseInt(i.css("padding-left"))+16+"px";$(e.data).each(function(e,i){t+='<li data-id="'+i.id+'"><div class="tree-item" style="padding-left: '+n+'"><span></span><span></span><span>'+i.name+"</span></div></li>"}),s.append("<ul>"+t+"</ul>")}})))}),folderBox.on("done",function(){this.hide(),r.length<1||postJson(e+"disk/move",{id:r,parent:l,mode:a},function(e){200==e.code&&(0==a?o.refresh():o.deleteCache(l))})});"undefined"==typeof File||File.prototype.slice||(File.prototype.webkitSlice&&(File.prototype.slice=File.prototype.webkitSlice),File.prototype.mozSlice&&(File.prototype.slice=File.prototype.mozSlice)),window.File&&window.FileReader&&window.FileList&&window.Blob&&File.prototype.slice||alert("File APIs are not fully supported in this browser. Please use latest Mozilla Firefox or Google Chrome.");var c=[],d=function(t){var i=u.files[t],s=new XMLHttpRequest;s.upload&&(s.upload.addEventListener("progress",function(e){i.process=parseInt(100*e.loaded/e.total)},!1),s.onreadystatechange=function(n){if(4==s.readyState)if(200==s.status){var r=$.parseJSON(s.responseText);200==r.code?(i.status=3,i.type=r.type,function(t){var i=u.files[t];postJson(e+"disk/add",{md5:i.md5,name:i.name,parent_id:o.getParent(),type:i.type,size:i.size,temp:i.temp},function(e){if(200==e.code)return o.addItem(e.data),void(i.status=3);i.status=7})}(t)):i.status=7}else i.status=7},i.status=2,i.process=0,s.open("POST",e+"upload",!0),i.temp=Math.random()+i.name.replace(/[\u4E00-\u9FA5]/g,""),s.setRequestHeader("X-FILENAME",i.temp),s.send(i.file))},h=function(t){return function(i){i.data.result?(u.files[t].status=1,u.files[t].process=0,u.files[t].md5=i.data.result,function(t){var i=u.files[t];postJson(e+"disk/check",{md5:i.md5,name:i.name,parent_id:o.getParent()},function(e){if(200==e.code)return i.status=4,void o.addItem(e.data);2==e.code&&d(t)})}(t)):u.files[t].process=Math.floor(100*i.data.block.end/i.data.block.file_size)}},f=function(e){e.stopPropagation(),e.preventDefault();for(var t=e.dataTransfer?e.dataTransfer.files:e.target.files,i=0;i<t.length;i++)u.addItem(t[i])},u=new Vue({el:"#upload",data:{title:"上传",files:[],mode:0},methods:{deleteItem:function(e){c[e]instanceof Worker&&c[e].terminate(),c.splice(e,1),this.files.splice(e,1)},addItem:function(e){var i=new Object;i.name=e.name,i.type=e.type,i.size=e.size,i.status=0,i.process=0,i.md5=null;var s=o.getParentItem();if(i.parent_id=s.id,i.parent_name=s.name,i.file=e,this.files.push(i),e.size>734003200)return i.status=9,void c.push("");var n=this.files.length-1,r=new Worker(t);r.addEventListener("message",h(n)),c.push(r),function(e,t){var i,s,n,o,r,a,l;l=function(e){n+=1,c[t].postMessage({message:e.target.result,block:s})},a=function(t){0==(n-=1)&&s.end!==e.size&&(s.start+=i,s.end+=i,s.end>e.size&&(s.end=e.size),(o=new FileReader).onload=l,r=e.slice(s.start,s.end),o.readAsArrayBuffer(r))},i=1048576,(s={file_size:e.size,start:0}).end=i>e.size?e.size:i,n=0,c[t].addEventListener("message",a),(o=new FileReader).onload=l,r=e.slice(s.start,s.end),o.readAsArrayBuffer(r)}(e,n)}}});$(".uploadFile").click(function(){var e=$(".uploadFiles");e.length<1?((e=document.createElement("input")).type="file",e.className="uploadFiles",e.multiple="true",document.body.appendChild(e),$(e).bind("change",f).hide()):(e.val(""),e.attr("multiple","true")),e.click(),u.mode=2}),$(".uploadFolder").click(function(){var e=$(".uploadFolders");e.length<1?((e=document.createElement("input")).type="file",e.className="uploadFolders",e.webkitdirectory="true",document.body.appendChild(e),$(e).bind("change",f).hide()):(e.val(""),e.attr("webkitdirectory","true")),e.click(),u.mode=2});var p=document.getElementById("upload");p.addEventListener("dragover",function(e){e.stopPropagation(),e.preventDefault()},!1),p.addEventListener("drop",f,!1)}function require_my_share(e){var t=new Vue({el:"#content",data:{files:[],checkCount:0,isAllChecked:!1,orderKey:null,order:null,offset:0,num:20},computed:{sortFiles:function(){return this.files.sort(sortBy(this.orderKey,this.order))}},methods:{getList:function(){this.checkCount=0,this.isAllChecked=!1;var i=Dialog.loading();$.getJSON(e+"share/mylist?offset="+this.offset+"&length="+this.num,function(e){200==e.code&&(t.addData(e.data),i.close())})},getMore:function(e){void 0===e&&(e=20),this.num=e,this.getList()},addData:function(e){for(var t in e){var i=e[t];i.checked=!1,this.files.push(i)}this.offset=this.files.length},setOrder:function(e){if(e!=this.orderKey)return this.orderKey=e,void(this.order=1);this.order*=-1},checkAll:function(){var e=this.files.length;this.isAllChecked?(this.isAllChecked=!1,this.checkCount=0):(this.isAllChecked=!0,this.checkCount=e);for(var t=0;t<e;t++)this.files[t].checked=this.isAllChecked},check:function(e){if(e.checked=!e.checked,!e.checked)return this.isAllChecked=!1,void this.checkCount--;this.checkCount++;for(var t=0,i=this.files.length;t<i;t++)if(!this.files[t].checked)return;this.isAllChecked=!0},deleteItem:function(i){var s=[];0==i?$(this.files).each(function(e,t){t.checked&&s.push(t.id)}):s=[i.id],postJson(e+"share/cancel",{id:s},function(e){200==e.code&&t.removeItem(s)})},removeItem:function(e){for(var t=this.files.length-1;t>=0;t--)for(var i=e.length-1;i>=0;i--)this.files[t].id==e[i]&&(this.files[t].checked&&this.checkCount--,this.files.splice(t,1),e.splice(i,1))}}});t.getList()}function require_trash(e){var t=new Vue({el:"#content",data:{files:[],checkCount:0,isAllChecked:!1,orderKey:null,order:null,offset:0,num:20},computed:{sortFiles:function(){return this.files.sort(sortBy(this.orderKey,this.order))}},methods:{getList:function(){this.checkCount=0,this.isAllChecked=!1;var i=Dialog.loading();$.getJSON(e+"trash/list?offset="+this.offset+"&length="+this.num,function(e){200==e.code&&(t.addData(e.data),i.close())})},getMore:function(e){void 0===e&&(e=20),this.num=e,this.getList()},addData:function(e){for(var t in e){var i=e[t];i.checked=!1,this.files.push(i)}this.offset=this.files.length},setOrder:function(e){if(e!=this.orderKey)return this.orderKey=e,void(this.order=1);this.order*=-1},checkAll:function(){var e=this.files.length;this.isAllChecked?(this.isAllChecked=!1,this.checkCount=0):(this.isAllChecked=!0,this.checkCount=e);for(var t=0;t<e;t++)this.files[t].checked=this.isAllChecked},check:function(e){if(e.checked=!e.checked,!e.checked)return this.isAllChecked=!1,void this.checkCount--;this.checkCount++;for(var t=0,i=this.files.length;t<i;t++)if(!this.files[t].checked)return;this.isAllChecked=!0},reset:function(i){var s=[];0==i?$(this.files).each(function(e,t){t.checked&&s.push(t.id)}):s=[i.id],postJson(e+"trash/reset",{id:s},function(e){200==e.code&&t.removeItem(s)})},deleteItem:function(i){var s=[];0==i?$(this.files).each(function(e,t){t.checked&&s.push(t.id)}):s=[i.id],postJson(e+"trash/delete",{id:s},function(e){200==e.code&&t.removeItem(s)})},clear:function(){$.getJSON(e+"trash/clear",function(e){200==e.code&&t.files.splice(0)})},removeItem:function(e){for(var t=this.files.length-1;t>=0;t--)for(var i=e.length-1;i>=0;i--)this.files[t].id==e[i]&&(this.files[t].checked&&this.checkCount--,this.files.splice(t,1),e.splice(i,1))}}});t.getList()}