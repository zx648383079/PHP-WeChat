function sortBy(i,s){return void 0===s&&(s=1),function(e,t){return(e=e[i])<(t=t[i])?-1*s:t<e?1*s:0}}function require_disk(a,p){var s=new Vue({el:"#shareModal",data:{modeType:0,users:[],selectUsers:[],role:null,name:null,result:null},methods:{share:function(){if(!(n.length<1)){var i=[];2==this.modeType&&$(this.selectUsers).each(function(e,t){i.push(t.id)}),postJson(a+"disk/share",{id:n,mode:this.modeType,user:i,role:this.role},function(e){200==e.code&&(this.modeType,s.result=e.data.url,1==e.data.mode&&(s.result+=" 密码："+e.data.password))})}},getUser:function(){this.name&&$.getJSON(a+"disk/users?name="+this.name,function(e){200==e.code&&$(e.data).each(function(e,t){t.select=!1,s.selectUsers.push(t)})})},getUsers:function(){$.getJSON(a+"disk/users",function(e){200==e.code&&$(e.data).each(function(e,t){t.select=!1,s.users.push(t)})})},select:function(){for(var e=this.users.length-1;0<=e;e--){var t=this.users[e];t.select&&(this.selectUsers.push(t),this.users.splice(e,1))}},remove:function(){for(var e=this.selectUsers.length-1;0<=e;e--){var t=this.selectUsers[e];t.select&&(this.users.push(t),this.selectUsers.splice(e,1))}},create:function(e){1!=e&&(e=0),this.modeType=e,this.share()},show:function(){this.result=0,e.show()}}});s.getUsers(),$(".zd_role_tree li").click(function(e){$(".zd_role_tree li").removeClass("active"),$(this).addClass("active"),s.role=$(this).attr("data-id"),e.stopPropagation()});var r={},e=$("#shareModal").dialog(),t=$("#folderModal").dialog(),i=null,m=new Vue({el:"#content",data:{files:[],checkCount:0,isAllChecked:!1,isList:!0,orderKey:null,order:null,category:null,offset:0,num:20,crumb:[{id:0,name:"全部文件"}]},computed:{sortFiles:function(){return this.orderKey?this.files.sort(sortBy(this.orderKey,this.order)):this.files}},methods:{getList:function(){this.checkCount=0,this.isAllChecked=!1;var e=this.getParent(),t=this.getTag(e),i=0<this.offset&&this.offset+this.num>this.files.length;if(!r.hasOwnProperty(t)||i){var s=Dialog.loading();$.getJSON(a+"disk/list?id="+e+"&type="+this.category+"&offset="+this.offset+"&length="+this.num,function(e){200==e.code&&(i&&r.hasOwnProperty(t)?Array.prototype.push.apply(r[t],e.data):r[t]=e.data,m.addData(e.data,!i),s.close())})}else this.addData(r[t])},getMore:function(e){void 0===e&&(e=20),this.num=e,this.getList()},getTag:function(e){return void 0===e&&(e=this.getParent()),"c"+this.category+e},addData:function(e,t){for(var i in void 0===t&&(t=!0),t&&this.files.splice(0),e){var s=e[i];s.checked=!1,this.files.push(s)}this.offset=this.files.length},setOrder:function(e){if(e!=this.orderKey)return this.orderKey=e,void(this.order=1);this.order*=-1},setList:function(e){this.isList=e},checkAll:function(){var e=this.files.length;this.isAllChecked?(this.isAllChecked=!1,this.checkCount=0):(this.isAllChecked=!0,this.checkCount=e);for(var t=0;t<e;t++)this.files[t].checked=this.isAllChecked},enter:function(e){return 0==e.file_id?(this.crumb.push(e),this.offset=0,void this.getList()):3!=e.type&&7!=e.type?5==e.type?((i||(i=new APlayer({container:document.getElementById("player"),fixed:!0,audio:[]}))).list.add({name:e.name,artist:"未知",url:e.url,cover:"/assets/images/favicon.png"}),i.skipBack(),void i.play()):void this.check(e):void window.open(e.url,"_blank")},top:function(){this.crumb.pop(),this.offset=0,this.getList()},level:function(e){if(0==e.id)this.crumb.splice(1);else for(var t=1,i=this.crumb.length;t<i;t++)if(e.id==this.crumb[t].id){this.crumb.splice(t+1);break}this.offset=0,this.getList()},refresh:function(){this.deleteCache(),this.offset=0,this.getList()},check:function(e){if(e.checked=!e.checked,!e.checked)return this.isAllChecked=!1,void this.checkCount--;this.checkCount++;for(var t=0,i=this.files.length;t<i;t++)if(!this.files[t].checked)return;this.isAllChecked=!0},deleteItem:function(s){postJson(a+"disk/delete",{id:s.id},function(e){if(200==e.code){m.deleteCache(s);for(var t=0,i=m.files.length;t<i;t++)if(m.files[t].id==s.id)return void m.files.splice(t,1)}})},deleteCache:function(e,t){"object"==typeof e&&(t=e,e=-1),(e<0||void 0===e)&&(e=this.getParent());var i=this.getTag(e);if(r.hasOwnProperty(i))if(void 0!==t)for(var s=r[i].length-1;0<=s;s--){var n=r[i][s];if(t instanceof Array)for(var o=t.length-1;0<=o;o--)n.id==t[o]&&(r[i].splice(s,1),t.splice(o,s));else if("object"==typeof t){if(t.id==n.id)return void r[i].splice(s,1)}else if(n.id==t)return void r[i].splice(s,1)}else delete r[i]},getParent:function(){return this.crumb[this.crumb.length-1].id},getParentItem:function(){return this.crumb[this.crumb.length-1]},addItem:function(e){"object"==typeof e&&(this.files.push(e),r[this.getTag()].push(e))},deleteAll:function(){for(var t=[],e=this.files.length-1;0<=e;e--)this.files[e].checked&&(t.push(this.files[e].id),this.files.splice(e,1));this.checkCount=0,this.isAllChecked&&(this.isAllChecked=!1),postJson(a+"disk/delete",{id:t},function(e){200==e.code&&this.deleteCache(this.getParent(),t)})},share:function(e){n=[e.id],s.show()},shareAll:function(){n=[];for(var e=this.files.length-1;0<=e;e--)this.files[e].checked&&n.push(this.files[e].id);n.length<1?alert("请选择文件"):s.show()},download:function(e){var t,i;0!=e.file_id?(t=a+"download?id="+e.id,(i=$(".downloadFrame")).length<1&&((i=document.createElement("iframe")).className="downloadFrame",document.body.appendChild(i),i=$(i)),i.attr("src",t),i.hide()):alert("暂不支持文件夹下载！")},downloadAll:function(){},move:function(e){t.show(),n=[e.id],o=0},moveAll:function(){t.show(),n=[],o=0;for(var e=this.files.length-1;0<=e;e--)this.files[e].checked&&n.push(this.files[e].id)},copy:function(e){t.show(),n=[e.id],o=1},copyAll:function(){t.show(),n=[],o=1;for(var e=this.files.length-1;0<=e;e--)this.files[e].checked&&n.push(this.files[e].id)},rename:function(e){if(e)return e.is_edit=!0,void(e.new_name=e.name);for(var t=this.files.length-1;0<=t;t--){var i=this.files[t];i.checked&&(i.is_edit=!0,i.new_name=e.name)}},closeEdit:function(e){e.is_edit=!1},saveEdit:function(s){s.new_name?postJson(a+"disk/rename",{name:s.name,id:s.id},function(i){200==i.code?(s.name=s.new_name,$(r[m.getTag()]).each(function(e,t){t.id==s.id&&(t.name=s.name,t.updated_at=i.updated_at)})):parseAjax(i)}):Dialog.tip("文件名不能为空！")},load:function(e){e=1<(e=e.split("#")).length?parseInt(e[1].substr(5)):null,this.category=e,this.offset=0,this.crumb.splice(1),this.getList()}}});m.load(window.location.hash),$(m.$el).show(),$(".navbar a").click(function(){m.load($(this).attr("href"))}),$("[data-type=create]").click(function(){var t=Dialog.form({name:"名称"},"新建文件夹").on("done",function(){postJson(a+"disk/create",{name:this.data.name,parent_id:m.getParent()},function(e){200==e.code?(t.close(),m.files.push(e.data),r[m.getTag()].push(e.data)):parseAjax(e)})})});var n=[],o=0,l=0;$(".tree-box").on("click",".tree-item",function(e){e.stopPropagation(),$(".tree-box li").removeClass("active");var t=$(this),n=t.parent();l=n.attr("data-id"),n.addClass("active"),t.hasClass("empty")||(n.hasClass("open")?n.removeClass("open"):(n.addClass("open"),0<n.find("ul").length||$.getJSON(a+"disk/folder?id="+l,function(e){if(200==e.code)if(e.data.length<1)t.addClass("empty");else{var i="",s=parseInt(t.css("padding-left"))+16+"px";$(e.data).each(function(e,t){i+='<li data-id="'+t.id+'"><div class="tree-item" style="padding-left: '+s+'"><span></span><span></span><span>'+t.name+"</span></div></li>"}),n.append("<ul>"+i+"</ul>")}})))}),t.on("done",function(){this.hide(),n.length<1||postJson(a+"disk/move",{id:n,parent:l,mode:o},function(e){200==e.code&&(0==o?m.refresh():m.deleteCache(l))})});"undefined"==typeof File||File.prototype.slice||(File.prototype.webkitSlice&&(File.prototype.slice=File.prototype.webkitSlice),File.prototype.mozSlice&&(File.prototype.slice=File.prototype.mozSlice)),window.File&&window.FileReader&&window.FileList&&window.Blob&&File.prototype.slice||alert("File APIs are not fully supported in this browser. Please use latest Mozilla Firefox or Google Chrome.");var g=[],d=function(n){var o=h.files[n],r=new XMLHttpRequest;r.upload&&(r.upload.addEventListener("progress",function(e){o.process=parseInt(100*e.loaded/e.total)},!1),r.onreadystatechange=function(e){if(4==r.readyState)if(200==r.status){var t,i,s=$.parseJSON(r.responseText);if(200==s.code)o.status=3,o.type=s.data.type,t=n,i=h.files[t],postJson(a+"disk/add",{md5:i.md5,name:i.name,parent_id:m.getParent(),type:i.type,size:i.size,temp:i.temp},function(e){if(200==e.code)return m.addItem(e.data),void(i.status=3);i.status=7});else o.status=7}else o.status=7},o.status=2,o.process=0,r.open("POST",a+"upload",!0),r.setRequestHeader("X-FILENAME",o.md5),r.send(o.file))},v=function(s){return function(e){var t,i;e.data.result?(h.files[s].status=1,h.files[s].process=0,h.files[s].md5=e.data.result,t=s,i=h.files[t],postJson(a+"disk/check",{md5:i.md5,name:i.name,parent_id:m.getParent()},function(e){if(200==e.code)return i.status=4,void m.addItem(e.data);2==e.code&&d(t)})):h.files[s].process=Math.floor(100*e.data.block.end/e.data.block.file_size)}},c=function(e){e.stopPropagation(),e.preventDefault(),h.mode=2;for(var t=e.dataTransfer?e.dataTransfer.files:e.target.files,i=0;i<t.length;i++)h.addItem(t[i])},h=new Vue({el:"#upload",data:{title:"上传",files:[],mode:0},methods:{deleteItem:function(e){g[e]instanceof Worker&&g[e].terminate(),g.splice(e,1),this.files.splice(e,1)},addItem:function(e){var t=new Object;t.name=e.name,t.type=e.type,t.size=e.size,t.status=0,t.process=0,t.md5=null;var i=m.getParentItem();if(t.parent_id=i.id,t.parent_name=i.name,t.file=e,this.files.push(t),734003200<e.size)return t.status=9,void g.push("");var s,n,o,r,a,l,d,c,h,f=this.files.length-1,u=new Worker(p);u.addEventListener("message",v(f)),g.push(u),n=f,h=function(e){a+=1,g[n].postMessage({message:e.target.result,block:r})},c=function(e){0==(a-=1)&&r.end!==s.size&&(r.start+=o,r.end+=o,r.end>s.size&&(r.end=s.size),(l=new FileReader).onload=h,d=s.slice(r.start,r.end),l.readAsArrayBuffer(d))},o=1048576,(r={file_size:(s=e).size,start:0}).end=o>s.size?s.size:o,a=0,g[n].addEventListener("message",c),(l=new FileReader).onload=h,d=s.slice(r.start,r.end),l.readAsArrayBuffer(d)}}});$(".uploadFile").click(function(){var e=$(".uploadFiles");e.length<1?((e=document.createElement("input")).type="file",e.className="uploadFiles",e.multiple="true",document.body.appendChild(e),$(e).bind("change",c).hide()):(e.val(""),e.attr("multiple","true")),e.click(),h.mode=2}),$(".uploadFolder").click(function(){var e=$(".uploadFolders");e.length<1?((e=document.createElement("input")).type="file",e.className="uploadFolders",e.webkitdirectory="true",document.body.appendChild(e),$(e).bind("change",c).hide()):(e.val(""),e.attr("webkitdirectory","true")),e.click(),h.mode=2});var f=document.getElementById("upload");f.addEventListener("dragover",function(e){e.stopPropagation(),e.preventDefault()},!1),f.addEventListener("drop",c,!1)}function require_my_share(s){var n=new Vue({el:"#content",data:{files:[],checkCount:0,isAllChecked:!1,orderKey:null,order:null,offset:0,num:20},computed:{sortFiles:function(){return this.files.sort(sortBy(this.orderKey,this.order))}},methods:{getList:function(){this.checkCount=0,this.isAllChecked=!1;var t=Dialog.loading();$.getJSON(s+"share/mylist?offset="+this.offset+"&length="+this.num,function(e){200==e.code&&(n.addData(e.data),t.close())})},getMore:function(e){void 0===e&&(e=20),this.num=e,this.getList()},addData:function(e){for(var t in e){var i=e[t];i.checked=!1,this.files.push(i)}this.offset=this.files.length},setOrder:function(e){if(e!=this.orderKey)return this.orderKey=e,void(this.order=1);this.order*=-1},checkAll:function(){var e=this.files.length;this.isAllChecked?(this.isAllChecked=!1,this.checkCount=0):(this.isAllChecked=!0,this.checkCount=e);for(var t=0;t<e;t++)this.files[t].checked=this.isAllChecked},check:function(e){if(e.checked=!e.checked,!e.checked)return this.isAllChecked=!1,void this.checkCount--;this.checkCount++;for(var t=0,i=this.files.length;t<i;t++)if(!this.files[t].checked)return;this.isAllChecked=!0},deleteItem:function(e){var i=[];0==e?$(this.files).each(function(e,t){t.checked&&i.push(t.id)}):i=[e.id],postJson(s+"share/cancel",{id:i},function(e){200==e.code&&n.removeItem(i)})},removeItem:function(e){for(var t=this.files.length-1;0<=t;t--)for(var i=e.length-1;0<=i;i--)this.files[t].id==e[i]&&(this.files[t].checked&&this.checkCount--,this.files.splice(t,1),e.splice(i,1))}}});n.getList()}function require_trash(s){var n=new Vue({el:"#content",data:{files:[],checkCount:0,isAllChecked:!1,orderKey:null,order:null,offset:0,num:20},computed:{sortFiles:function(){return this.files.sort(sortBy(this.orderKey,this.order))}},methods:{getList:function(){this.checkCount=0,this.isAllChecked=!1;var t=Dialog.loading();$.getJSON(s+"trash/list?offset="+this.offset+"&length="+this.num,function(e){200==e.code&&(n.addData(e.data),t.close())})},getMore:function(e){void 0===e&&(e=20),this.num=e,this.getList()},addData:function(e){for(var t in e){var i=e[t];i.checked=!1,this.files.push(i)}this.offset=this.files.length},setOrder:function(e){if(e!=this.orderKey)return this.orderKey=e,void(this.order=1);this.order*=-1},checkAll:function(){var e=this.files.length;this.isAllChecked?(this.isAllChecked=!1,this.checkCount=0):(this.isAllChecked=!0,this.checkCount=e);for(var t=0;t<e;t++)this.files[t].checked=this.isAllChecked},check:function(e){if(e.checked=!e.checked,!e.checked)return this.isAllChecked=!1,void this.checkCount--;this.checkCount++;for(var t=0,i=this.files.length;t<i;t++)if(!this.files[t].checked)return;this.isAllChecked=!0},reset:function(e){var i=[];0==e?$(this.files).each(function(e,t){t.checked&&i.push(t.id)}):i=[e.id],postJson(s+"trash/reset",{id:i},function(e){200==e.code&&n.removeItem(i)})},deleteItem:function(e){var i=[];0==e?$(this.files).each(function(e,t){t.checked&&i.push(t.id)}):i=[e.id],postJson(s+"trash/delete",{id:i},function(e){200==e.code&&n.removeItem(i)})},clear:function(){$.getJSON(s+"trash/clear",function(e){200==e.code&&n.files.splice(0)})},removeItem:function(e){for(var t=this.files.length-1;0<=t;t--)for(var i=e.length-1;0<=i;i--)this.files[t].id==e[i]&&(this.files[t].checked&&this.checkCount--,this.files.splice(t,1),e.splice(i,1))}}});n.getList()}Vue.filter("time",function(e){if(e){if(!/^\d+$/.test(e))return e;var t=new Date;return t.setTime(1e3*parseInt(e)),t.toLocaleString()}}),Vue.filter("size",function(e){if(!e)return"--";if(0==(e=parseFloat(e)))return"0 B";var t=Math.floor(Math.log(e)/Math.log(1e3));return(e/Math.pow(1e3,t)).toPrecision(3)+" "+["B","KB","MB","GB","TB","PB","EB","ZB","YB"][t]}),Vue.filter("status",function(e){switch(e){case 0:return"文件校验中";case 1:return"校验完成";case 2:return"文件上传中";case 3:return"上传成功！";case 4:return"秒传！";case 9:return"文件太大了！";case 7:default:return"上传失败！"}});