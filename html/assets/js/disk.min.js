function sortBy(i,s){return void 0===s&&(s=1),function(e,t){return(e=e[i])<(t=t[i])?-1*s:t<e?+s:0}}function require_disk(o,d){function f(s){return function(e){var t,i;e.data.result?(g.files[s].status=1,g.files[s].process=0,g.files[s].md5=e.data.result,t=s,i=g.files[t],postJson(o+"disk/check",{md5:i.md5,name:i.name,parent_id:u.getParent()},function(e){200==e.code?(i.status=4,u.addItem(e.data)):2==e.code&&c(t)})):g.files[s].process=Math.floor(100*e.data.block.end/e.data.block.file_size)}}function t(e){e.stopPropagation(),e.preventDefault(),g.mode=2;for(var t=(e.dataTransfer||e.target).files,i=0;i<t.length;i++)g.addItem(t[i])}var s=new Vue({el:"#shareModal",data:{modeType:0,users:[],selectUsers:[],role:null,name:null,result:null},methods:{share:function(){var i;a.length<1||(i=[],2==this.modeType&&$(this.selectUsers).each(function(e,t){i.push(t.id)}),postJson(o+"disk/share",{id:a,mode:this.modeType,user:i,role:this.role},function(e){200==e.code&&(this.modeType=0,s.result=e.data.url,1==e.data.mode)&&(s.result+=" 密码："+e.data.password)}))},getUser:function(){this.name&&$.getJSON(o+"disk/users?name="+this.name,function(e){200==e.code&&$(e.data).each(function(e,t){t.select=!1,s.selectUsers.push(t)})})},getUsers:function(){$.getJSON(o+"disk/users",function(e){200==e.code&&$(e.data).each(function(e,t){t.select=!1,s.users.push(t)})})},select:function(){for(var e=this.users.length-1;0<=e;e--){var t=this.users[e];t.select&&(this.selectUsers.push(t),this.users.splice(e,1))}},remove:function(){for(var e=this.selectUsers.length-1;0<=e;e--){var t=this.selectUsers[e];t.select&&(this.users.push(t),this.selectUsers.splice(e,1))}},create:function(e){this.modeType=e=1!=e?0:e,this.share()},show:function(){this.result=0,e.show()}}}),r=(s.getUsers(),$(".zd_role_tree li").on("click",function(e){$(".zd_role_tree li").removeClass("active"),$(this).addClass("active"),s.role=$(this).attr("data-id"),e.stopPropagation()}),{}),e=$("#shareModal").dialog(),i=$("#folderModal").dialog(),n=null,u=new Vue({el:"#content",data:{files:[],checkCount:0,isAllChecked:!1,isList:!0,orderKey:null,order:null,category:null,page:1,perPage:20,hasMore:!0,isLoading:!1,crumb:[{id:0,name:"全部文件"}]},computed:{sortFiles:function(){return this.orderKey?this.files.sort(sortBy(this.orderKey,this.order)):this.files}},methods:{goPage:function(t){var i,s=this,e=(this.checkCount=0,this.isAllChecked=!1,this.getParent()),n=this.getTag(e);r.hasOwnProperty(n)&&!this.hasMore?this.addData(r[n]):(i=Dialog.loading(),$.getJSON(o+"disk/list",{id:e,type:this.category,page:t,per_page:this.perPage},function(e){200==e.code&&(1<t&&r.hasOwnProperty(n)?Array.prototype.push.apply(r[n],e.data):r[n]=e.data,s.hasMore=e.paging.more,s.page=t,s.isLoading=!1,u.addData(e.data,t<2),i.close())}))},tapMore:function(){this.hasMore&&this.goPage(this.page+1)},tapRefresh:function(){this.goPage(1)},getTag:function(e){return void 0===e&&(e=this.getParent()),"c"+this.category+e},addData:function(e,t){for(var i in(t=void 0===t?!0:t)&&this.files.splice(0),e){i=e[i];i.checked=!1,this.files.push(i)}},setOrder:function(e){e!=this.orderKey?(this.orderKey=e,this.order=1):this.order*=-1},setList:function(e){this.isList=e},checkAll:function(){var e=this.files.length;this.isAllChecked?(this.isAllChecked=!1,this.checkCount=0):(this.isAllChecked=!0,this.checkCount=e);for(var t=0;t<e;t++)this.files[t].checked=this.isAllChecked},enter:function(e){0!=e.file_id&&e.file?3==e.file.type||7==e.file.type?window.open(e.file.url,"_blank"):5==e.file.type?((n=n||new APlayer({container:document.getElementById("player"),fixed:!0,audio:[]})).list.add({name:e.name,artist:"未知",url:e.file.url,cover:e.file.thumb||"/assets/images/favicon.png"}),n.skipBack(),n.play()):this.check(e):(this.crumb.push(e),this.tapRefresh())},top:function(){this.crumb.pop(),this.tapRefresh()},level:function(e){if(0==e.id)this.crumb.splice(1);else for(var t=1,i=this.crumb.length;t<i;t++)if(e.id==this.crumb[t].id){this.crumb.splice(t+1);break}this.tapRefresh()},refresh:function(){this.deleteCache(),this.tapRefresh()},check:function(e){if(e.checked=!e.checked,e.checked){this.checkCount++;for(var t=0,i=this.files.length;t<i;t++)if(!this.files[t].checked)return;this.isAllChecked=!0}else this.isAllChecked=!1,this.checkCount--},deleteItem:function(s){postJson(o+"disk/delete",{id:s.id},function(e){if(200==e.code){u.deleteCache(s);for(var t=0,i=u.files.length;t<i;t++)if(u.files[t].id==s.id)return void u.files.splice(t,1)}})},deleteCache:function(e,t){"object"==typeof e&&(t=e,e=-1),(e<0||void 0===e)&&(e=this.getParent());var i=this.getTag(e);if(r.hasOwnProperty(i))if(void 0===t)delete r[i];else for(var s=r[i].length-1;0<=s;s--){var n=r[i][s];if(t instanceof Array)for(var a=t.length-1;0<=a;a--)n.id==t[a]&&(r[i].splice(s,1),t.splice(a,s));else if("object"==typeof t){if(t.id==n.id)return void r[i].splice(s,1)}else if(n.id==t)return void r[i].splice(s,1)}},getParent:function(){return this.crumb[this.crumb.length-1].id},getParentItem:function(){return this.crumb[this.crumb.length-1]},addItem:function(e){"object"==typeof e&&(this.files.push(e),r[this.getTag()].push(e))},deleteAll:function(){for(var t=[],e=this.files.length-1;0<=e;e--)this.files[e].checked&&(t.push(this.files[e].id),this.files.splice(e,1));this.checkCount=0,this.isAllChecked&&(this.isAllChecked=!1),postJson(o+"disk/delete",{id:t},function(e){200==e.code&&this.deleteCache(this.getParent(),t)})},share:function(e){a=[e.id],s.show()},shareAll:function(){a=[];for(var e=this.files.length-1;0<=e;e--)this.files[e].checked&&a.push(this.files[e].id);a.length<1?alert("请选择文件"):s.show()},download:function(e){var t;0==e.file_id?alert("暂不支持文件夹下载！"):(e=o+"download?id="+e.id,(t=$(".downloadFrame")).length<1&&((t=document.createElement("iframe")).className="downloadFrame",document.body.appendChild(t),t=$(t)),t.attr("src",e),t.hide())},downloadAll:function(){},move:function(e){i.show(),a=[e.id],l=0},moveAll:function(){i.show(),a=[],l=0;for(var e=this.files.length-1;0<=e;e--)this.files[e].checked&&a.push(this.files[e].id)},copy:function(e){i.show(),a=[e.id],l=1},copyAll:function(){i.show(),a=[],l=1;for(var e=this.files.length-1;0<=e;e--)this.files[e].checked&&a.push(this.files[e].id)},rename:function(e){if(e)e.is_edit=!0,e.new_name=e.name;else for(var t=this.files.length-1;0<=t;t--){var i=this.files[t];i.checked&&(i.is_edit=!0,i.new_name=e.name)}},closeEdit:function(e){e.is_edit=!1},saveEdit:function(s){s.new_name?postJson(o+"disk/rename",{name:s.name,id:s.id},function(i){200!=i.code?parseAjax(i):(s.name=s.new_name,$(r[u.getTag()]).each(function(e,t){t.id==s.id&&(t.name=s.name,t.updated_at=i.updated_at)}))}):Dialog.tip("文件名不能为空！")},load:function(e){e=1<(e=e.split("#")).length?parseInt(e[1].substr(5)):null,this.category=e,this.offset=0,this.crumb.splice(1),this.tapRefresh()}}}),a=(u.load(window.location.hash),$(u.$el).show(),$(".navbar a").on("click",function(){u.load($(this).attr("href"))}),$("[data-type=create]").on("click",function(){var t=!1,i=Dialog.form({name:"名称"},"新建文件夹").on("done",function(){t||(t=!0,postJson(o+"disk/create",{name:this.data.name,parent_id:u.getParent()},function(e){200!=e.code?(parseAjax(e),t=!1):(i.close(),u.files.push(e.data),r[u.getTag()].push(e.data))}))})}),[]),l=0,h=0,p=($(".tree-box").on("click",".tree-item",function(e){e.stopPropagation(),$(".tree-box li").removeClass("active");var t=$(this),n=t.parent();h=n.attr("data-id"),n.addClass("active"),t.hasClass("empty")||(n.hasClass("open")?n.removeClass("open"):(n.addClass("open"),0<n.find("ul").length||$.getJSON(o+"disk/folder?id="+h,function(e){var i,s;200==e.code&&(e.data.length<1?t.addClass("empty"):(i="",s=parseInt(t.css("padding-left"))+16+"px",$(e.data).each(function(e,t){i+='<li data-id="'+t.id+'"><div class="tree-item" style="padding-left: '+s+'"><span></span><span></span><span>'+t.name+"</span></div></li>"}),n.append("<ul>"+i+"</ul>")))})))}),i.on("done",function(){this.hide(),a.length<1||postJson(o+"disk/move",{id:a,parent:h,mode:l},function(e){200==e.code&&(0!=l?u.deleteCache(h):u.refresh())})}),"undefined"==typeof File||File.prototype.slice||(File.prototype.webkitSlice&&(File.prototype.slice=File.prototype.webkitSlice),File.prototype.mozSlice&&(File.prototype.slice=File.prototype.mozSlice)),window.File&&window.FileReader&&window.FileList&&window.Blob&&File.prototype.slice||alert("File APIs are not fully supported in this browser. Please use latest Mozilla Firefox or Google Chrome."),[]),c=function(s){var n=g.files[s],a=new XMLHttpRequest;a.upload&&(a.upload.addEventListener("progress",function(e){n.process=parseInt(100*e.loaded/e.total)},!1),a.onreadystatechange=function(e){var t,i;4==a.readyState&&(200!=a.status||200!=(t=$.parseJSON(a.responseText)).code?n.status=7:(n.status=3,n.type=t.data.type,i=g.files[s],postJson(o+"disk/add",{md5:i.md5,name:i.name,parent_id:u.getParent(),type:i.type,size:i.size,temp:i.temp},function(e){200==e.code?(u.addItem(e.data),i.status=3):i.status=7})))},n.status=2,n.process=0,a.open("POST",o+"upload",!0),a.setRequestHeader("X-FILENAME",n.md5),a.send(n.file))},g=new Vue({el:"#upload",data:{title:"上传",files:[],mode:0},methods:{deleteItem:function(e){p[e]instanceof Worker&&p[e].terminate(),p.splice(e,1),this.files.splice(e,1)},addItem:function(e){var t,i,s,n,a,o,r,l,h=new Object,c=(h.name=e.name,h.type=e.type,h.size=e.size,h.status=0,h.process=0,h.md5=null,u.getParentItem());h.parent_id=c.id,h.parent_name=c.name,h.file=e,this.files.push(h),734003200<e.size?(h.status=9,p.push("")):(c=this.files.length-1,(h=new Worker(d)).addEventListener("message",f(c)),p.push(h),i=c,o=function(e){s+=1,p[i].postMessage({message:e.target.result,block:l})},h=function(e){0===--s&&l.end!==t.size&&(l.start+=r,l.end+=r,l.end>t.size&&(l.end=t.size),(n=new FileReader).onload=o,a=t.slice(l.start,l.end),n.readAsArrayBuffer(a))},r=1048576,(l={file_size:(t=e).size,start:0}).end=r>t.size?t.size:r,s=0,p[i].addEventListener("message",h),(n=new FileReader).onload=o,a=t.slice(l.start,l.end),n.readAsArrayBuffer(a))}}}),m=($(".uploadFile").on("click",function(){var e=$(".uploadFiles");e.length<1?((e=document.createElement("input")).type="file",e.className="uploadFiles",e.multiple="true",document.body.appendChild(e),$(e).bind("change",t).hide()):(e.val(""),e.attr("multiple","true")),e.click(),g.mode=2}),$(".uploadFolder").on("click",function(){var e=$(".uploadFolders");e.length<1?((e=document.createElement("input")).type="file",e.className="uploadFolders",e.webkitdirectory="true",document.body.appendChild(e),$(e).bind("change",t).hide()):(e.val(""),e.attr("webkitdirectory","true")),e.click(),g.mode=2}),document.getElementById("upload"));m.addEventListener("dragover",function(e){e.stopPropagation(),e.preventDefault()},!1),m.addEventListener("drop",t,!1)}function require_my_share(n){var a=new Vue({el:"#content",data:{files:[],checkCount:0,isAllChecked:!1,orderKey:null,order:null,page:1,perPage:20,hasMore:!0,isLoading:!1},computed:{sortFiles:function(){return this.files.sort(sortBy(this.orderKey,this.order))}},methods:{goPage:function(t){var i=this,s=(this.checkCount=0,this.isAllChecked=!1,Dialog.loading());$.getJSON(n+"share/mylist",{page:t,per_page:this.perPage},function(e){200==e.code&&(a.addData(e.data),i.hasMore=e.paging.more,i.page=t,i.isLoading=!1,s.close())})},tapMore:function(){this.hasMore&&this.goPage(this.page+1)},tapRefresh:function(){this.goPage(1)},addData:function(e){for(var t in e){t=e[t];t.checked=!1,this.files.push(t)}this.offset=this.files.length},setOrder:function(e){e!=this.orderKey?(this.orderKey=e,this.order=1):this.order*=-1},checkAll:function(){var e=this.files.length;this.isAllChecked?(this.isAllChecked=!1,this.checkCount=0):(this.isAllChecked=!0,this.checkCount=e);for(var t=0;t<e;t++)this.files[t].checked=this.isAllChecked},check:function(e){if(e.checked=!e.checked,e.checked){this.checkCount++;for(var t=0,i=this.files.length;t<i;t++)if(!this.files[t].checked)return;this.isAllChecked=!0}else this.isAllChecked=!1,this.checkCount--},deleteItem:function(e){var i=[];0==e?$(this.files).each(function(e,t){t.checked&&i.push(t.id)}):i=[e.id],postJson(n+"share/cancel",{id:i},function(e){200==e.code&&a.removeItem(i)})},removeItem:function(e){for(var t=this.files.length-1;0<=t;t--)for(var i=e.length-1;0<=i;i--)this.files[t].id==e[i]&&(this.files[t].checked&&this.checkCount--,this.files.splice(t,1),e.splice(i,1))}}});a.tapRefresh()}function require_trash(s){var n=new Vue({el:"#content",data:{files:[],checkCount:0,isAllChecked:!1,orderKey:null,order:null,page:1,perPage:20,hasMore:!0},computed:{sortFiles:function(){return this.files.sort(sortBy(this.orderKey,this.order))}},methods:{goPage:function(t){this.checkCount=0,this.isAllChecked=!1;var i=Dialog.loading();$.getJSON(s+"trash/list",{page:t,per_page:this.perPage},function(e){200==e.code&&(this.hasMore=e.paging.more,this.page=t,this.isLoading=!1,n.addData(e.data),i.close())})},tapMore:function(){this.hasMore&&this.goPage(this.page+1)},tapRefresh:function(){this.goPage(1)},addData:function(e){for(var t in e){t=e[t];t.checked=!1,this.files.push(t)}this.offset=this.files.length},setOrder:function(e){e!=this.orderKey?(this.orderKey=e,this.order=1):this.order*=-1},checkAll:function(){var e=this.files.length;this.isAllChecked?(this.isAllChecked=!1,this.checkCount=0):(this.isAllChecked=!0,this.checkCount=e);for(var t=0;t<e;t++)this.files[t].checked=this.isAllChecked},check:function(e){if(e.checked=!e.checked,e.checked){this.checkCount++;for(var t=0,i=this.files.length;t<i;t++)if(!this.files[t].checked)return;this.isAllChecked=!0}else this.isAllChecked=!1,this.checkCount--},reset:function(e){var i=[];0==e?$(this.files).each(function(e,t){t.checked&&i.push(t.id)}):i=[e.id],postJson(s+"trash/reset",{id:i},function(e){200==e.code&&n.removeItem(i)})},deleteItem:function(e){var i=[];0==e?$(this.files).each(function(e,t){t.checked&&i.push(t.id)}):i=[e.id],postJson(s+"trash/delete",{id:i},function(e){200==e.code&&n.removeItem(i)})},clear:function(){$.getJSON(s+"trash/clear",function(e){200==e.code&&n.files.splice(0)})},removeItem:function(e){for(var t=this.files.length-1;0<=t;t--)for(var i=e.length-1;0<=i;i--)this.files[t].id==e[i]&&(this.files[t].checked&&this.checkCount--,this.files.splice(t,1),e.splice(i,1))}}});n.tapRefresh()}function require_share(a,o){var r={},t=$("#folderModal").dialog(),l=new Vue({el:"#content",data:{files:[],checkCount:0,isAllChecked:!1,isList:!0,orderKey:null,order:null,page:1,perPage:20,hasMore:!0,crumb:[{id:0,name:"全部文件"}]},computed:{sortFiles:function(){return this.orderKey?this.files.sort(sortBy(this.orderKey,this.order)):this.files}},methods:{goPage:function(t){var i,s=this,e=(this.checkCount=0,this.isAllChecked=!1,this.getParent()),n=this.getTag(e);r.hasOwnProperty(n)&&!this.hasMore?this.addData(r[n]):(i=Dialog.loading(),$.getJSON(a+"share/list",{id:e,share:o,page:t,per_page:this.perPage},function(e){200==e.code&&(1<t?Array.prototype.push.apply(r[n],e.data):r[n]=e.data,s.hasMore=e.paging.more,s.page=t,s.isLoading=!1,l.addData(e.data,t<2),i.hide())}))},tapMore:function(){this.hasMore&&this.goPage(this.page+1)},tapRefresh:function(){this.goPage(1)},getTag:function(e){return e=void 0===e?this.getParent():e},addData:function(e,t){for(var i in(t=void 0===t?!0:t)&&this.files.splice(0),e){i=e[i];i.checked=!1,this.files.push(i)}this.offset=this.files.length},setOrder:function(e){e!=this.orderKey?(this.orderKey=e,this.order=1):this.order*=-1},setList:function(e){this.isList=e},checkAll:function(){var e=this.files.length;this.isAllChecked?(this.isAllChecked=!1,this.checkCount=0):(this.isAllChecked=!0,this.checkCount=e);for(var t=0;t<e;t++)this.files[t].checked=this.isAllChecked},enter:function(e){1!=e.is_dir?this.check(e):(this.crumb.push(e),this.offset=0,this.tapRefresh())},top:function(){this.crumb.pop(),this.offset=0,this.tapRefresh()},level:function(e){if(0==e.id)this.crumb.splice(1);else for(var t=1,i=this.crumb.length;t<i;t++)if(e.id==this.crumb[t].id){this.crumb.splice(t+1);break}this.offset=0,this.tapRefresh()},refresh:function(){this.deleteCache(),this.tapRefresh()},check:function(e){if(e.checked=!e.checked,e.checked){this.checkCount++;for(var t=0,i=this.files.length;t<i;t++)if(!this.files[t].checked)return;this.isAllChecked=!0}else this.isAllChecked=!1,this.checkCount--},deleteCache:function(e,t){"object"==typeof e&&(t=e,e=-1),(e<0||void 0===e)&&(e=this.getParent());var i=this.getTag(e);if(r.hasOwnProperty(i))if(void 0===t)delete r[i];else for(var s=r[i].length-1;0<=s;s--){var n=r[i][s];if(t instanceof Array)for(var a=t.length-1;0<=a;a--)n.id==t[a]&&(r[i].splice(s,1),t.splice(a,s));else if("object"==typeof t){if(t.id==n.id)return void r[i].splice(s,1)}else if(n.id==t)return void r[i].splice(s,1)}},getParent:function(){return this.crumb[this.crumb.length-1].id},getParentItem:function(){return this.crumb[this.crumb.length-1]},cancel:function(){postJson(a+"share/cancel",{id:[o]},function(e){200==e.code&&(window.location.href=a)})},download:function(e){var t;1==e.is_dir?alert("暂不支持文件夹下载！"):(e=a+"download?id="+e.id,(t=$(".downloadFrame")).length<1&&((t=document.createElement("iframe")).className="downloadFrame",document.body.appendChild(t),t=$(t)),t.attr("src",e),t.hide())},downloadAll:function(){alert("暂不支持多文件下载!")},save:function(e){t.show(),i=[e.id],0},saveAll:function(){t.show(),i=[],0;for(var e=this.files.length-1;0<=e;e--)this.files[e].checked&&i.push(this.files[e].id)}}}),i=(l.tapRefresh(),[]),s=0;$(".zd_tree").on("click",".zd_tree_item",function(e){e.stopPropagation(),$(".zd_tree li").removeClass("active");var t=$(this),n=t.parent();s=n.attr("data-id"),n.addClass("active"),t.hasClass("empty")||(n.hasClass("open")?n.removeClass("open"):(n.addClass("open"),0<n.find("ul").length||$.getJSON(a+"disk/folder?id="+s,function(e){var i,s;200==e.code&&(e.data.length<1?t.addClass("empty"):(i="",s=parseInt(t.css("padding-left"))+30+"px",$(e.data).each(function(e,t){i+='<li data-id="'+t.id+'"><div class="zd_tree_item" style="padding-left: '+s+'"><span></span><span></span><span>'+t.name+"</span></div></li>"}),n.append("<ul>"+i+"</ul>")))})))}),t.on("done",function(){t.hide(),i.length<1||postJson(a+"share/save",{id:o,file:i,parent:s},function(e){parseAjax(e)})})}Vue.filter("time",function(e){var t;if(e)return/^\d+$/.test(e)?((t=new Date).setTime(1e3*parseInt(e)),t.getFullYear()+"-"+(t.getMonth()+1)+"-"+t.getDate()+" "+t.getHours()+":"+t.getMinutes()):e}),Vue.filter("size",function(e){var t;return e?0==(e=parseFloat(e))?"0 B":(t=Math.floor(Math.log(e)/Math.log(1e3)),(e/Math.pow(1e3,t)).toPrecision(3)+" "+["B","KB","MB","GB","TB","PB","EB","ZB","YB"][t]):"--"}),Vue.filter("status",function(e){switch(e){case 0:return"文件校验中";case 1:return"校验完成";case 2:return"文件上传中";case 3:return"上传成功！";case 4:return"秒传！";case 9:return"文件太大了！";default:return"上传失败！"}});