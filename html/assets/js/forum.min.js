var Editor=function(){function t(t){this.element=t,this.textField=this.element.find("textarea")[0],this.init(),this.bindEvent()}return t.prototype.init=function(){this.element.prepend('<div class="editor-plugin">\n        <i class="fa fa-code" title="插入代码"></i>\n        <i class="fa fa-eye-slash" title="插入隐藏内容""></i>\n        <i class="fa fa-download" title="插入可下载内容"></i>\n        <i class="fa fa-image" title="插入图片"></i>\n        <i class="fa fa-video" title="插入视频"></i>\n        <i class="fa fa-link" title="插入链接"></i>\n    </div>')},t.prototype.bindEvent=function(){var i=this;this.element.on("keydown","textarea",function(t){9===t.keyCode&&(t.preventDefault(),i.saveRange(),i.insertTab())}).on("blur","textarea",function(t){i.saveRange()}).on("click",".editor-plugin .fa",function(){var t=$(this);if(!i.isInAttr()){var e=i.getBlock();(!e||"hide"===e||"a"===e&&t.hasClass("fa-image"))&&(t.hasClass("fa-code")?i.insert("<code></code>",6,!0):t.hasClass("fa-eye-slash")?i.append("<hide></hide>",6,!0):t.hasClass("fa-download")?i.insert("<file></file>",6,!0):t.hasClass("fa-image")?i.insert("<img></img>",5,!0):t.hasClass("fa-video")?i.insert("<video></video>",7,!0):t.hasClass("fa-link")&&i.insert('<a href=""></a>',9,!0))}})},t.prototype.checkRange=function(){this.range||(this.range={start:this.textField.value.length,end:this.textField.value.length})},t.prototype.saveRange=function(){this.range={start:this.textField.selectionStart,end:this.textField.selectionEnd}},t.prototype.isInAttr=function(){return!(!this.range||this.range.start<3)&&(!!/\<[^\<\>]+$/.test(this.textField.value.substr(0,this.range.start))&&(!(this.range.start<this.range.end&&/[\<\>]/.test(this.textField.value.substr(this.range.start,this.range.end-this.range.start)))&&!!/^[^\<\>]*\>/.test(this.textField.value.substr(this.range.end))))},t.prototype.getBlock=function(){if(!this.range)return null;var t=this.textField.value;if(t.length<3)return null;var e=this.range.start;if(e<2)return null;for(var i=0,s=0;0<e;){e--;var n=t.charAt(e);if(0!==s||">"!==n)if(1!==s||"/"!==n)if(2!==s){if(1===s&&"<"==n){if(0<i){i--;continue}return this.getBlockTag(e+1,t)}}else{if("<"!==n){s=1;continue}s=0,i++}else s=2;else s=1}return null},t.prototype.getBlockTag=function(t,e){for(var i=[];t<e.length;){var s=e.charAt(t);if(" "===s||">"===s)break;i.push(s),t++}return i.join("")},t.prototype.insertTab=function(){if(!this.isInAttr())return this.insert("    ",4,!0);for(var t=this.range.start,e=this.textField.value;;){if(">"===e.charAt(t))break;t++}this.range.start=t+1,this.range.end=Math.max(t+1,this.range.end),this.focus()},t.prototype.insert=function(t,e,i){void 0===e&&(e=0),void 0===i&&(i=!0),this.checkRange(),this.textField.value=this.textField.value.substr(0,this.range.start)+t+this.textField.value.substr(this.range.start),this.move(e),i&&this.focus()},t.prototype.replace=function(t,e,i){if(void 0===e&&(e=0),void 0===i&&(i=!0),this.checkRange(),this.range.start===this.range.end)return this.insert("function"==typeof t?t(""):t,e,i);var s="function"==typeof t?t(this.textField.value.substr(this.range.start,this.range.end-this.range.start)):t;this.textField.value=this.textField.value.substr(0,this.range.start)+s+this.textField.value.substr(this.range.end),this.move(e),i&&this.focus()},t.prototype.append=function(e,i,t){void 0===i&&(i=0),void 0===t&&(t=!0),this.replace(function(t){return t.length<1?e:i<1?t+e:i>e.length?e+t:e.substr(0,i)+t+e.substr(i)},i,t)},t.prototype.move=function(t){0!==t&&(t=this.range.start+t,this.range={start:t,end:Math.max(t,this.range.end)})},t.prototype.focus=function(){this.checkRange(),this.textField.selectionStart=this.range.start,this.textField.selectionEnd=this.range.end,this.textField.focus()},t}();$(function(){new Editor($(".editor"))});