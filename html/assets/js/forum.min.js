var __spreadArrays=this&&this.__spreadArrays||function(){for(var t=0,e=0,i=arguments.length;e<i;e++)t+=arguments[e].length;var n=Array(t),r=0;for(e=0;e<i;e++)for(var a=arguments[e],s=0,o=a.length;s<o;s++,r++)n[r]=a[s];return n},Editor=function(){function r(t){this.element=t,this.events={},this.textField=this.element.find("textarea")[0],this.init(),this.bindEvent()}return r.prototype.on=function(t,e){return this.events[t]=e,this},r.prototype.hasEvent=function(t){return this.events.hasOwnProperty(t)},r.prototype.trigger=function(t){for(var e,i=[],n=1;n<arguments.length;n++)i[n-1]=arguments[n];if(this.hasEvent(t))return(e=this.events[t]).call.apply(e,__spreadArrays([this],i))},r.prototype.init=function(){for(var t="",e=0,i=r.plugins;e<i.length;e++){var n=i[e];t+='<i class="fa '+n.icon+'" data-name="'+n.name+'" title="'+n.title+'"></i>',this.on(n.name,n.handle)}this.element.prepend('<div class="editor-plugin">'+t+"</div>")},r.prototype.bindEvent=function(){var i=this;this.element.on("keydown","textarea",function(t){9===t.keyCode&&(t.preventDefault(),i.saveRange(),i.insertTab())}).on("blur","textarea",function(t){i.saveRange()}).on("click",".editor-plugin .fa",function(){var t=$(this);if(!i.isInAttr()){var e=i.getBlock();i.trigger(t.data("name"),e,t)}})},r.prototype.checkRange=function(){this.range||(this.range={start:this.textField.value.length,end:this.textField.value.length})},r.prototype.saveRange=function(){this.range={start:this.textField.selectionStart,end:this.textField.selectionEnd}},r.prototype.isInAttr=function(){return!(!this.range||this.range.start<3)&&(!!/\<[^\<\>]+$/.test(this.textField.value.substr(0,this.range.start))&&(!(this.range.start<this.range.end&&/[\<\>]/.test(this.textField.value.substr(this.range.start,this.range.end-this.range.start)))&&!!/^[^\<\>]*\>/.test(this.textField.value.substr(this.range.end))))},r.prototype.getBlock=function(){if(!this.range)return null;var t=this.textField.value;if(t.length<3)return null;var e=this.range.start;if(e<2)return null;for(var i=0,n=0;0<e;){e--;var r=t.charAt(e);if(0!==n||">"!==r)if(1!==n||"/"!==r)if(2!==n){if(1===n&&"<"==r){if(0<i){i--;continue}return this.getBlockTag(e+1,t)}}else{if("<"!==r){n=1;continue}n=0,i++}else n=2;else n=1}return null},r.prototype.getBlockTag=function(t,e){for(var i=[];t<e.length;){var n=e.charAt(t);if(" "===n||">"===n)break;i.push(n),t++}return i.join("")},r.prototype.insertTab=function(){if(!this.isInAttr())return this.insert("    ",4,!0);for(var t=this.range.start,e=this.textField.value;;){if(">"===e.charAt(t))break;t++}this.range.start=t+1,this.range.end=Math.max(t+1,this.range.end),this.focus()},r.prototype.insert=function(t,e,i){void 0===e&&(e=0),void 0===i&&(i=!0),this.checkRange(),this.textField.value=this.textField.value.substr(0,this.range.start)+t+this.textField.value.substr(this.range.start),this.move(e),i&&this.focus()},r.prototype.replace=function(t,e,i){if(void 0===e&&(e=0),void 0===i&&(i=!0),this.checkRange(),this.range.start===this.range.end)return this.insert("function"==typeof t?t(""):t,e,i);var n="function"==typeof t?t(this.textField.value.substr(this.range.start,this.range.end-this.range.start)):t;this.textField.value=this.textField.value.substr(0,this.range.start)+n+this.textField.value.substr(this.range.end),this.move(e),i&&this.focus()},r.prototype.append=function(e,i,t){void 0===i&&(i=0),void 0===t&&(t=!0),this.replace(function(t){return t.length<1?e:i<1?t+e:i>e.length?e+t:e.substr(0,i)+t+e.substr(i)},i,t)},r.prototype.at=function(t,e){var i='<at parent="'+t+'">'+e+"</at>";this.textField.value=i+this.textField.value.replace(/<at[\s\S]+<\/at>/,""),$("html,body").animate({scrollTop:this.element.offset().top+"px"},500),this.focus()},r.prototype.insertFile=function(e,t){void 0===t&&(t="");var i=this;this.upload||(this.upload=new Upload(null,{url:UPLOAD_URI,name:"upfile",template:"{url}",onafter:function(t){return"SUCCESS"==t.state?e.call(i,t.url,t):302===t.code&&(location.href=t.url),!1}})),this.upload.options.filter=t,this.upload.start()},r.prototype.clear=function(t){void 0===t&&(t=!0),this.textField.value="",t&&this.focus()},r.prototype.move=function(t){0!==t&&(t=this.range.start+t,this.range={start:t,end:Math.max(t,this.range.end)})},r.prototype.focus=function(){this.checkRange(),this.textField.selectionStart=this.range.start,this.textField.selectionEnd=this.range.end,this.textField.focus()},r.plugin=function(t,e,i){"object"!=typeof t&&(t={icon:t,title:"function"==typeof e?i:e,handle:"function"==typeof e?e:i}),t.name||(t.name=t.icon),t.title||(t.title=t.name),this.plugins.push(t)},r.plugins=[],r}();Editor.plugin("fa-code","插入代码",function(t){t&&"hide"!==t||this.insert("<code></code>",6,!0)}),Editor.plugin("fa-eye-slash","插入隐藏内容",function(t){t||this.append("<hide></hide>",6,!0)}),Editor.plugin("fa-download","插入可下载内容",function(t){var e=this;t&&"hide"!==t||this.insertFile(function(t){e.insert("<file>"+t+"</file>",6,!0)})}),Editor.plugin("fa-image","插入图片",function(t){var e=this;t&&"hide"!==t&&"a"!==t||this.insertFile(function(t){e.insert("<img>"+t+"</img>",5,!0)},"image/*")}),Editor.plugin("fa-music","插入音频",function(t){var e=this;t&&"hide"!==t||this.insertFile(function(t){e.insert("<audio>"+t+"</audio>",7,!0)},"audio/*")}),Editor.plugin("fa-video","插入视频",function(t){var e=this;t&&"hide"!==t||this.insertFile(function(t){e.insert("<video></video>",7,!0)},"video/*")}),Editor.plugin("fa-link","插入链接",function(t){t&&"hide"!==t||this.insert('<a href=""></a>',9,!0)}),Editor.plugin("fa-chart-bar","插入投票",function(t){t||this.insert("<vote>\n\t说明\n\t<v>选项1</v>\n\t<v>选项2</v>\n</vote>",7,!0)}),Editor.plugin("fa-trash","清空",function(){this.clear(!0)}),$(function(){var i=new Editor($(".editor"));$(".thread-box").on("click",'.post-item [data-action="reply"]',function(t){t.preventDefault();var e=$(this).closest(".post-item");i.at(e.data("id"),e.find(".post-user .name").text())}).on("click",'[data-action="toggle"]',function(t){t.preventDefault();var e=$(this);confirm("您确定要"+e.text())&&postJson(e.attr("href"),parseAjax)}).on("click","a[data-action=confirm]",function(t){t.preventDefault();var e=$(this);confirm(e.data("message"))&&postJson(e.attr("href"),function(t){200==t.code?$("#post-"+t.data.id+" .content").html(t.data.content):parseAjax(t)})}),$(".thread-list").on("click",".thread-item a",function(t){t.stopPropagation()}).on("click",".thread-item",function(){window.location.href=$(this).find("a.title").attr("href")}).on("mouseover","*[data-action=user]",function(){$(this)})});