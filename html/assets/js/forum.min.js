var __spreadArray=this&&this.__spreadArray||function(t,e,i){if(i||2===arguments.length)for(var n,a=0,r=e.length;a<r;a++)!n&&a in e||((n=n||Array.prototype.slice.call(e,0,a))[a]=e[a]);return t.concat(n||Array.prototype.slice.call(e))},Editor=function(){function a(t){this.element=t,this.events={},this.textField=this.element.find("textarea")[0],this.init(),this.bindEvent()}return a.prototype.on=function(t,e){return this.events[t]=e,this},a.prototype.hasEvent=function(t){return this.events.hasOwnProperty(t)},a.prototype.trigger=function(t){for(var e,i=[],n=1;n<arguments.length;n++)i[n-1]=arguments[n];if(this.hasEvent(t))return(e=this.events[t]).call.apply(e,__spreadArray([this],i,!1))},a.prototype.init=function(){for(var t="",e=0,i=a.plugins;e<i.length;e++){var n=i[e];t+='<i class="fa '+n.icon+'" data-name="'+n.name+'" title="'+n.title+'"></i>',this.on(n.name,n.handle)}this.element.prepend('<div class="editor-plugin">'+t+"</div>")},a.prototype.bindEvent=function(){var i=this;this.element.on("keydown","textarea",function(t){9===t.keyCode&&(t.preventDefault(),i.saveRange(),i.insertTab())}).on("blur","textarea",function(t){i.saveRange()}).on("click",".editor-plugin .fa",function(){var t,e=$(this);i.isInAttr()||(t=i.getBlock(),i.trigger(e.data("name"),t,e))})},a.prototype.checkRange=function(){this.range||(this.range={start:this.textField.value.length,end:this.textField.value.length})},a.prototype.saveRange=function(){this.range={start:this.textField.selectionStart,end:this.textField.selectionEnd}},a.prototype.isInAttr=function(){return!(!this.range||this.range.start<3||!/\<[^\<\>]+$/.test(this.textField.value.substr(0,this.range.start))||this.range.start<this.range.end&&/[\<\>]/.test(this.textField.value.substr(this.range.start,this.range.end-this.range.start))||!/^[^\<\>]*\>/.test(this.textField.value.substr(this.range.end)))},a.prototype.getBlock=function(){if(this.range){var t=this.textField.value;if(!(t.length<3)){var e=this.range.start;if(!(e<2))for(var i=0,n=0;0<e;){e--;var a=t.charAt(e);if(0===n&&">"===a)n=1;else if(1===n&&"/"===a)n=2;else if(2===n)"<"!==a?n=1:(n=0,i++);else if(1===n&&"<"==a){if(!(0<i))return this.getBlockTag(e+1,t);i--}}}}return null},a.prototype.getBlockTag=function(t,e){for(var i=[];t<e.length;){var n=e.charAt(t);if(" "===n||">"===n)break;i.push(n),t++}return i.join("")},a.prototype.insertTab=function(){if(!this.isInAttr())return this.insert("    ",4,!0);for(var t=this.range.start,e=this.textField.value;">"!==e.charAt(t);)t++;this.range.start=t+1,this.range.end=Math.max(t+1,this.range.end),this.focus()},a.prototype.insert=function(t,e,i){void 0===e&&(e=0),void 0===i&&(i=!0),this.checkRange(),this.textField.value=this.textField.value.substr(0,this.range.start)+t+this.textField.value.substr(this.range.start),this.move(e),i&&this.focus()},a.prototype.replace=function(t,e,i){if(void 0===e&&(e=0),void 0===i&&(i=!0),this.checkRange(),this.range.start===this.range.end)return this.insert("function"==typeof t?t(""):t,e,i);t="function"==typeof t?t(this.textField.value.substr(this.range.start,this.range.end-this.range.start)):t;this.textField.value=this.textField.value.substr(0,this.range.start)+t+this.textField.value.substr(this.range.end),this.move(e),i&&this.focus()},a.prototype.append=function(e,i,t){void 0===i&&(i=0),this.replace(function(t){return t.length<1?e:i<1?t+e:i>e.length?e+t:e.substr(0,i)+t+e.substr(i)},i,t=void 0===t?!0:t)},a.prototype.at=function(t,e){this.textField.value='<at parent="'+t+'">'+e+"</at>"+this.textField.value.replace(/<at[\s\S]+<\/at>/,""),$("html,body").animate({scrollTop:this.element.offset().top+"px"},500),this.focus()},a.prototype.insertFile=function(e,t){void 0===t&&(t="");var i=this;this.upload||(this.upload=new Upload(null,{url:UPLOAD_URI,name:"upfile",template:"{url}",onafter:function(t){return"SUCCESS"==t.state?e.call(i,t.url,t):302===t.code&&(location.href=t.url),!1}})),this.upload.options.filter=t,this.upload.start()},a.prototype.clear=function(t){void 0===t&&(t=!0),this.textField.value="",t&&this.focus()},a.prototype.move=function(t){0!==t&&(t=this.range.start+t,this.range={start:t,end:Math.max(t,this.range.end)})},a.prototype.focus=function(){this.checkRange(),this.textField.selectionStart=this.range.start,this.textField.selectionEnd=this.range.end,this.textField.focus()},a.plugin=function(t,e,i){(t="object"!=typeof t?{icon:t,title:"function"==typeof e?i:e,handle:"function"==typeof e?e:i}:t).name||(t.name=t.icon),t.title||(t.title=t.name),this.plugins.push(t)},a.plugins=[],a}();Editor.plugin("fa-code","插入代码",function(t){t&&"hide"!==t||this.insert("<code></code>",6,!0)}),Editor.plugin("fa-eye-slash","插入隐藏内容",function(t){t||this.append("<hide></hide>",6,!0)}),Editor.plugin("fa-download","插入可下载内容",function(t){var e=this;t&&"hide"!==t||this.insertFile(function(t){e.insert("<file>"+t+"</file>",6,!0)})}),Editor.plugin("fa-image","插入图片",function(t){var e=this;t&&"hide"!==t&&"a"!==t||this.insertFile(function(t){e.insert("<img>"+t+"</img>",5,!0)},"image/*")}),Editor.plugin("fa-music","插入音频",function(t){var e=this;t&&"hide"!==t||this.insertFile(function(t){e.insert("<audio>"+t+"</audio>",7,!0)},"audio/*")}),Editor.plugin("fa-video","插入视频",function(t){var e=this;t&&"hide"!==t||this.insertFile(function(t){e.insert("<video></video>",7,!0)},"video/*")}),Editor.plugin("fa-link","插入链接",function(t){t&&"hide"!==t||this.insert('<a href=""></a>',9,!0)}),Editor.plugin("fa-chart-bar","插入投票",function(t){t||this.insert("<vote>\n\t说明\n\t<v>选项1</v>\n\t<v>选项2</v>\n</vote>",7,!0)}),Editor.plugin("fa-clone","插入分页",function(t){t||this.insert("<page/>",7,!0)}),Editor.plugin("fa-trash","清空",function(){this.clear(!0)}),$(function(){var e=new Editor($(".editor"));$(".thread-box").on("click",'.post-item [data-action="reply"]',function(t){t.preventDefault();t=$(this).closest(".post-item");e.at(t.data("id"),t.find(".post-user .name").text())}).on("click",'[data-action="toggle"]',function(t){t.preventDefault();t=$(this);confirm("您确定要"+t.text())&&postJson(t.attr("href"),parseAjax)}).on("click","a[data-action=confirm]",function(t){t.preventDefault();t=$(this);confirm(t.data("message"))&&postJson(t.attr("href"),function(t){200!=t.code?parseAjax(t):$("#post-"+t.data.id+" .content").html(t.data.content)})}).on("submit","form[data-action=ajax]",function(){var t=$(this);return postJson(t.attr("action"),t.serialize(),function(t){200!=t.code?parseAjax(t):$("#post-"+t.data.id+" .content").html(t.data.content)}),!1}),$(".thread-list").on("click",".thread-item a",function(t){t.stopPropagation()}).on("click",".thread-item",function(){window.location.href=$(this).find("a.title").attr("href")}).on("mouseover","*[data-action=user]",function(){$(this)})});