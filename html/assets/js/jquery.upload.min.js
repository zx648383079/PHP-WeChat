var __extends=this&&this.__extends||function(){var n=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var o in e)e.hasOwnProperty(o)&&(t[o]=e[o])};return function(t,e){function o(){this.constructor=t}n(t,e),t.prototype=null===e?Object.create(e):(o.prototype=e.prototype,new o)}}(),Eve=function(){function t(){}return t.prototype.on=function(t,e){return this.options["on"+t]=e,this},t.prototype.hasEvent=function(t){return this.options.hasOwnProperty("on"+t)},t.prototype.trigger=function(t){for(var e,o=[],n=1;n<arguments.length;n++)o[n-1]=arguments[n];var i="on"+t;if(this.hasEvent(t))return(e=this.options[i]).call.apply(e,[this].concat(o))},t}(),Upload=function(n){function t(t,e){var o=n.call(this)||this;return o.element=t,o.options=$.extend({},new UploadDefaultOption,e),o.options.data=$.extend({},o.options.data,o.getData()),o.getElement=o.options.getElement.bind(o),o.element&&o.addEvent(),o}return __extends(t,n),t.prototype.addEvent=function(){var t=this;this.element.click(function(){t.start($(this))}),this.options.grid&&$(this.options.grid).on("click",this.options.removeTag,this.options.removeCallback)},t.prototype.start=function(t){this.currentElement=t;var e=this,o=$("."+this.options.fileClass);if(o.length<1){var n=document.createElement("input");n.type="file",n.className=this.options.fileClass,n.multiple=this.options.multiple,n.accept=this.options.filter,document.body.appendChild(n),o=$(n).bind("change",function(){e.uploadFiles(this.files)}).hide()}else o.val(""),o.attr("multiple",this.options.multiple?"true":"false"),o.attr("accept",this.options.filter),this.options.dynamic&&o.unbind("change").bind("change",function(){e.uploadFiles(this.files)});o.click()},t.prototype.uploadFiles=function(t){if(this.options.allowMultiple)this.uploadMany(t);else{var o=this;$.each(t,function(t,e){o.uploadOne(e)})}},t.prototype.uploadMany=function(t){var o,n=this;this.options.ondealfile?o=this.options.ondealfiles.call(this,t):(o=new FormData,$.each(t,function(t,e){o.append(n.options.name,e)})),!1!==this.trigger("before",o,this.currentElement)?this.uploadForm(o,function(t){t instanceof Array?$.each(t,function(t,e){n.deal($.extend({},n.options.data,e))}):n.deal($.extend({},n.options.data,t))}):console.log("before upload is false")},t.prototype.uploadOne=function(t){var e,o=this,n=this.trigger("dealfile",t);!1!==n?(n?e=n:(e=new FormData).append(this.options.name,t),!1!==this.trigger("before",e,this.currentElement)?this.uploadForm(e,function(t){o.deal($.extend({},o.options.data,t))}):console.log("before upload is false")):console.log("deal file is false")},t.prototype.uploadForm=function(t,e){var o=this,n={url:this.options.url,type:"POST",data:t,cache:!1,contentType:!1,processData:!1,success:function(t){0!=(t=o.trigger("after",t,o.currentElement))?e&&e(t):console.log("after upload is false")}};this.options.timeout&&(n.timeout=this.options.timeout),o.options.onprogress&&(n.xhr=function(){var t=$.ajaxSettings.xhr();return o.options.onprogress&&t.upload&&t.upload.addEventListener("progress",o.options.onprogress,!1),t}),$.ajax(n)},t.prototype.formatFileSize=function(t){var e=["Byte","KB","MB","GB"];if(0==t)return"0 KB";var o=Math.floor(Math.log(t)/Math.log(1024));return 0==o?t+e[o]:(t/Math.pow(1024,o)).toFixed(1)+e[o]},t.prototype.sliceUpload=function(n,i){var a,s=1048576,r=this,l=n.size,p=Math.ceil(l/s),c=0,u=function(){var t=c*s,e=Math.min((c+1)*s,l),o=new FormData;o.append(r.options.name,n.slice(t,e)),a&&o.append("name",a),o.append("real_name",n.name),o.append("total",l+""),o.append("status",(c==p-1?2:0==c?0:1)+""),r.uploadForm(o,function(t){i&&i({total:l,size:e},r.currentElement),c!==p-1?(a=t.name,c++,u()):r.deal($.extend({},r.options.data,t))})};u()},t.prototype.photoCompress=function(t,e,o){var n=new FileReader,i=this;n.readAsDataURL(t),n.onload=function(){var t=this.result;i._canvasDataURL(t,e,o)}},t.prototype._canvasDataURL=function(t,p,c){var e=new Image;e.src=t,e.onload=function(){var t=this.width,e=this.height,o=t/e;t=p.width||t,e=p.height||t/o;var n=.7,i=document.createElement("canvas"),a=i.getContext("2d"),s=document.createAttribute("width");s.nodeValue=t;var r=document.createAttribute("height");r.nodeValue=e,i.setAttributeNode(s),i.setAttributeNode(r),a.drawImage(this,0,0,t,e),p.quality&&p.quality<=1&&0<p.quality&&(n=p.quality);var l=i.toDataURL("image/jpeg",n);c(l)}},t.prototype.convertBase64UrlToBlob=function(t){for(var e=t.split(","),o=e[0].match(/:(.*?);/)[1],n=atob(e[1]),i=n.length,a=new Uint8Array(i);i--;)a[i]=n.charCodeAt(i);return new Blob([a],{type:o})},t.prototype.deal=function(t){var n="function"==typeof this.options.template?this.options.template.call(this,t):this.replace(t);if(0!=n)if(!1!==this.trigger("success",t,this.currentElement)){var e=this.options.grid;if(this.currentElement&&0<this.currentElement.length&&(e=this.currentElement.attr("data-grid")||this.options.grid),e){var o=e.split("|"),i=this;o.forEach(function(t){var e=i.getElement(t,i.currentElement);0!=e.length&&e.each(function(t,e){var o=$(e);o.is("input")||o.is("textarea")?o.val(n):o.is("img")?o.attr("src",n):i.options.isAppend?o.append(n):o.prepend(n)})})}else console.log("grid element is false")}else console.log("success is false");else console.log("template is false")},t.prototype.getData=function(){if(!this.element||this.element.length<1)return{};var n={},t=this.element.attr("data-data");return t&&t.split(",").forEach(function(t){var e=t.split(":"),o=e[0].trim();o&&(n[o]=e[1].trim())}),n},t.prototype.replace=function(t){var e="function"==typeof this.options.template?this.options.template.call(this,t):this.options.template;for(var o in t)t.hasOwnProperty(o)&&(e=e.replace(new RegExp("{"+o+"}","g"),t[o]));return e},t}(Eve),UploadDefaultOption=function(){this.name="file",this.isAppend=!0,this.template="{url}",this.removeTag=".delete",this.removeCallback=function(){$(this).parent().remove()},this.multiple=!1,this.allowMultiple=!1,this.data={},this.fileClass="zdUploadFile",this.filter="",this.onafter=function(t){return"object"!=typeof t&&(t=JSON.parse(t)),0==t.code&&t.data},this.dynamic=!0,this.getElement=function(t){return $(t)}};jQuery.fn.upload=function(t){return new Upload(this,t)};