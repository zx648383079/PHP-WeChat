var Upload=function(){function t(t,e){this.element=t,this.option=$.extend({},new UploadDefaultOption,e),this.option.data=$.extend({},this.option.data,this.getData()),this.option.success&&(this.success=this.option.success.bind(this)),this.getElement=this.option.getElement.bind(this),this.addEvent()}return t.prototype.addEvent=function(){var i=this;this.element.click(function(){i.currentElement=$(this);var t=$("."+i.option.fileClass);if(t.length<1){var e=document.createElement("input");e.type="file",e.className=i.option.fileClass,e.multiple=i.option.multiple,e.accept=i.option.filter,document.body.appendChild(e),t=$(e).bind("change",function(){$.each(this.files,function(t,e){i.uploadOne(e)})}).hide()}else t.val(""),t.attr("multiple",i.option.multiple?"true":"false"),t.attr("accept",i.option.filter),i.option.dynamic&&t.unbind("change").bind("change",function(){$.each(this.files,function(t,e){i.uploadOne(e)})});t.click()}),$(this.option.grid).on("click",this.option.removeTag,this.option.removeCallback)},t.prototype.uploadOne=function(t){var e=this,i=new FormData;i.append(this.option.name,t),this.option.beforeUpload&&0==this.option.beforeUpload.call(this,i,this.currentElement)||$.ajax({url:this.option.url,type:"POST",data:i,cache:!1,contentType:!1,processData:!1,success:function(t){0==(t=e.option.afterUpload.call(e,t,e.currentElement))||e.deal($.extend({},e.option.data,t))}})},t.prototype.deal=function(t){var e=this.currentElement.attr("data-grid")||this.option.grid;if(e&&(!this.success||!1!==this.success(t,this.currentElement))){var i=e.split("|"),n=this.replace(t),o=this;i.forEach(function(t){var e=o.getElement(t,o.currentElement);0!=e.length&&e.each(function(t,e){var i=$(e);i.is("input")||i.is("textarea")?i.val(n):i.is("img")?i.attr("src",n):o.option.isAppend?i.append(n):i.prepend(n)})})}},t.prototype.getData=function(){var n={},t=this.element.attr("data-data");return t&&t.split(",").forEach(function(t){var e=t.split(":"),i=e[0].trim();i&&(n[i]=e[1].trim())}),n},t.prototype.replace=function(t){var e=this.option.template;for(var i in t)t.hasOwnProperty(i)&&(e=e.replace(new RegExp("{"+i+"}","g"),t[i]));return e},t}(),UploadDefaultOption=function(){this.name="file",this.isAppend=!0,this.template="<li>{url}</li>",this.removeTag=".delete",this.removeCallback=function(){$(this).parent().remove()},this.multiple=!1,this.data={},this.fileClass="zdUploadFile",this.filter="",this.afterUpload=function(t){return"object"!=typeof t&&(t=JSON.parse(t)),0==t.code&&t.data},this.dynamic=!0,this.getElement=function(t){return $(t)}};jQuery.fn.upload=function(t){return new Upload(this,t)};