var Upload=function(){function t(t,e){this.element=t,this.option=$.extend({},new UploadDefaultOption,e),this.option.data=$.extend({},this.option.data,this.getData()),this.option.success&&(this.success=this.option.success.bind(this)),this.getElement=this.option.getElement.bind(this),this.addEvent()}return t.prototype.addEvent=function(){var t=this;this.element.click(function(){t.currentElement=$(this);var e=$("."+t.option.fileClass);if(e.length<1){var i=document.createElement("input");i.type="file",i.className=t.option.fileClass,i.multiple=t.option.multiple,i.accept=t.option.filter,document.body.appendChild(i),e=$(i).bind("change",function(){$.each(this.files,function(e,i){t.uploadOne(i)})}).hide()}else e.val(""),e.attr("multiple",t.option.multiple?"true":"false"),e.attr("accept",t.option.filter),t.option.dynamic&&e.unbind("change").bind("change",function(){$.each(this.files,function(e,i){t.uploadOne(i)})});e.click()}),$(this.option.grid).on("click",this.option.removeTag,this.option.removeCallback)},t.prototype.uploadOne=function(t){var e=this,i=new FormData;i.append(this.option.name,t),this.option.beforeUpload&&0==this.option.beforeUpload.call(this,i,this.currentElement)||$.ajax({url:this.option.url,type:"POST",data:i,cache:!1,contentType:!1,processData:!1,success:function(t){0==(t=e.option.afterUpload.call(e,t,e.currentElement))||e.deal($.extend({},e.option.data,t))}})},t.prototype.deal=function(t){var e=this.currentElement.attr("data-grid")||this.option.grid;if(e&&(!this.success||!1!==this.success(t,this.currentElement))){var i=e.split("|"),n=this.replace(t),o=this;i.forEach(function(t){var e=o.getElement(t,o.currentElement);0!=e.length&&e.each(function(t,e){var i=$(e);i.is("input")||i.is("textarea")?i.val(n):i.is("img")?i.attr("src",n):o.option.isAppend?i.append(n):i.prepend(n)})})}},t.prototype.getData=function(){var t={},e=this.element.attr("data-data");if(!e)return t;return e.split(",").forEach(function(e){var i=e.split(":"),n=i[0].trim();n&&(t[n]=i[1].trim())}),t},t.prototype.replace=function(t){var e=this.option.template;for(var i in t)t.hasOwnProperty(i)&&(e=e.replace(new RegExp("{"+i+"}","g"),t[i]));return e},t}(),UploadDefaultOption=function(){return function(){this.name="file",this.isAppend=!0,this.template="<li>{url}</li>",this.removeTag=".delete",this.removeCallback=function(){$(this).parent().remove()},this.multiple=!1,this.data={},this.fileClass="zdUploadFile",this.filter="",this.afterUpload=function(t){return"object"!=typeof t&&(t=JSON.parse(t)),0==t.code&&t.data},this.dynamic=!0,this.getElement=function(t){return $(t)}}}();jQuery.fn.upload=function(t){return new Upload(this,t)};