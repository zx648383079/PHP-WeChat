/**
 * post 提交
 * @param url
 * @param data
 * @param callback
 */
function postJson(url, data, callback) {
    if (typeof data == 'function') {
        callback = data;
        data = {};
    }
    $.post(url, data, callback || parseAjax, 'json');
}
;
function ajaxForm(url, data, callback) {
    postJson(url, data, function (data) {
        if (callback) {
            callback(data);
            return;
        }
        parseAjax(data);
    });
}
function formData(item) {
    var data = [];
    item.find('input,textarea,select').each(function () {
        if (this.type && ['radio', 'checkbox'].indexOf(this.type) >= 0 && !this.checked) {
            return;
        }
        data.push(encodeURIComponent(this.name) + '=' +
            encodeURIComponent($(this).val().toString()));
    });
    return data.join('&');
}
/**
 * 转化请求响应结果
 * @param data
 */
function parseAjax(data) {
    if (data.code === 302 || (data.code === 401 && data.url)) {
        window.location.href = data.url;
        return;
    }
    if (data.code !== 200) {
        Dialog.tip(data.message || '操作执行失败！');
        return;
    }
    Dialog.tip(data.message || '操作执行完成！');
    if (data.data && data.data.refresh) {
        setTimeout(function () {
            if (typeof parseAjaxUri == 'function') {
                parseAjaxUri(window.location.href);
                return;
            }
            window.location.reload();
        }, 500);
    }
    if (data.data && data.data.url) {
        setTimeout(function () {
            if (data.data.url === -1) {
                history.go(-1);
                return;
            }
            if (typeof parseAjaxUri == 'function') {
                parseAjaxUri(data.data.url);
                return;
            }
            window.location.href = data.data.url;
        }, 500);
    }
}
;
/**
 * 转化float
 * @param arg
 */
var toFloat = function (arg) {
    if (!arg) {
        return 0;
    }
    arg = arg.toString().replace(',', '').match(/[\d\.]+/);
    if (!arg) {
        return 0;
    }
    return parseFloat(arg);
};
/**
 * 转化数字
 * @param arg
 */
var toInt = function (arg) {
    if (!arg) {
        return 0;
    }
    arg = arg.toString().replace(',', '').match(/[\d]+/);
    if (!arg) {
        return 0;
    }
    return parseInt(arg, 10);
};
var strFormat = function (arg) {
    var args = [];
    for (var _i = 1; _i < arguments.length; _i++) {
        args[_i - 1] = arguments[_i];
    }
    return arg.replace(/\{(\d+)\}/g, function (m, i) {
        return args[i];
    });
};
$(function () {
    if (typeof Upload === 'function' && typeof UPLOAD_URI === 'string') {
        var file_upload = new Upload(null, {
            url: UPLOAD_URI,
            name: 'upfile',
            template: '{url}',
            onafter: function (data, element) {
                if (data.state == 'SUCCESS') {
                    element.prev('input').val(data.url);
                }
                else if (data.code === 302) {
                    location.href = data.url;
                }
                return false;
            }
        });
    }
    $(document).on('click', "a[data-type=refresh]", function () {
        window.location.reload();
    })
        .on('click', "a[data-type=del]", function (e) {
        e.preventDefault();
        var tip = $(this).attr('data-tip') || '确定删除这条数据？';
        if (!confirm(tip)) {
            return;
        }
        var loading = Dialog.loading();
        postJson($(this).attr('href'), function (data) {
            loading.close();
            if (data.code == 200 && !data.msg) {
                data.msg = '删除成功！';
            }
            parseAjax(data);
        });
    })
        .on('click', "a[data-type=ajax]", function (e) {
        e.preventDefault();
        var $this = $(this);
        var successTip = $this.attr('data-success') || '提交成功！';
        var errorTip = $this.attr('data-error') || '提交失败！';
        var callback = $this.attr('data-callback');
        var loading = Dialog.loading();
        postJson($this.attr('href'), function (data) {
            loading.close();
            if (data.code == 200 && !data.msg) {
                data.msg = successTip;
            }
            if (data.code == 200 && callback) {
                eval(callback + '($this, data);');
            }
            parseAjax(data);
        });
    })
        .on('submit', "form[data-type=ajax]", function () {
        var $this = $(this);
        var loading = Dialog.loading();
        ajaxForm($this.attr('action'), $this.serialize(), function (res) {
            loading.close();
            parseAjax(res);
        });
        return false;
    })
        .on('click', "a[data-type=post]", function (e) {
        e.preventDefault();
        var form = $('<form action="' + $(this).attr('href') + '" method="post"></form');
        $(document.body).append(form);
        form.submit();
    })
        .on('click', ".file-input [data-type=upload]", function () {
        var that = $(this);
        file_upload.options.filter = that.data('allow') || '';
        file_upload.start(that);
    })
        .on('click', ".file-input [data-type=preview]", function () {
        var img = $(this).parents('.file-input').find('input').val();
        if (!img) {
            Dialog.tip('请上传图片！');
            return;
        }
        Dialog.box({
            title: '预览',
            content: '<img src="' + img + '">'
        });
    })
        .on('click', ".zd-tab .zd-tab-head .zd-tab-item", function () {
        var $this = $(this);
        $this.addClass("active").siblings().removeClass("active");
        var tab = $this.closest(".zd-tab").find(".zd-tab-body .zd-tab-item").eq($this.index()).addClass("active");
        tab.siblings().removeClass("active");
        tab.trigger('tabActived', $this.index());
    }).on('click', ".tab-box .tab-header .tab-item", function () {
        var $this = $(this);
        $this.addClass("active").siblings().removeClass("active");
        var tab = $this.closest(".tab-box").find(".tab-body .tab-item").eq($this.index()).addClass("active");
        tab.siblings().removeClass("active");
        tab.trigger('tabActived', $this.index());
    })
        .on('click', ".page-tip .toggle", function () {
        $(this).closest('.page-tip').toggleClass('min');
    });
    $('.sidebar-container .sidebar-container-toggle').click(function () {
        var box = $(this).closest('.app-wrapper').toggleClass('wrapper-min');
        if (box.find('ul').height() < $(window).height() - 100) {
            box.toggleClass('sidebar-fixed', box.hasClass('wrapper-min'));
        }
        $(window).trigger('resize');
    });
    $('.sidebar-container li a').click(function () {
        var $this = $(this), box = $this.closest('li');
        if (box.find('ul').length > 0) {
            box.toggleClass('expand');
            return;
        }
        $('.sidebar-container li').removeClass('active');
        box.addClass('active');
        $this.closest('.app-wrapper').removeClass('wrapper-min');
    });
    var autoRedirct = function () {
        var ele = $(".autoRedirct");
        if (ele.length < 1) {
            return;
        }
        var url = ele.attr('href') || ele.attr('data-url');
        var text = ele.text();
        var time = toInt(ele.attr('data-time'));
        if (time < 1) {
            time = 3;
        }
        ele.text(text + '(' + time + ' 秒)');
        var handle = setInterval(function () {
            time--;
            ele.text(text + '(' + time + ' 秒)');
            if (time <= 0) {
                clearInterval(handle);
                ele.text(text + '(正在跳转...)');
                window.location.href = url;
            }
        }, 1000);
    };
    autoRedirct();
});
