var DIALOG_CLOSE="dialog-close";function bindMicroPage(){var i,n=new Upload(null,{url:UPLOAD_URI,name:"upfile",template:"{url}",onafter:function(t,e){return"SUCCESS"==t.state?(e.find(".dialog-body .add-btn").before('<div class="file-item"><img src="'+t.url+'" alt=""><input type="hidden" name="file[]" value="'+t.url+'"><i class="fa fa-times"></i></div>'),e.show()):302===t.code&&(location.href=t.url),!1}}),a=$(".dialog-upload").on(DIALOG_CLOSE,function(){a.hide(),a.find(".file-item").remove()}).on("click",".dialog-header .fa-times",function(){a.trigger(DIALOG_CLOSE)}).on("click",".file-item .fa-times",function(){$(this).closest(".file-item").remove()}).on("click",".add-btn",function(){n.options.filter="",n.start(a)}),o=$(".dialog-emoji").on("click",".dialog-header .fa-times",function(){o.hide()}).on("click",".dialog-header .tab-header li",function(){var t=$(this);t.addClass("active").siblings().removeClass("active"),t.closest(".dialog-emoji").find(".dialog-body .tab-item").eq(t.index()).addClass("active").siblings().removeClass("active")}).on("click",".emoji-item",function(){var t=$(this),e=i.find("textarea");e.val(e.val()+"["+t.attr("title")+"]"),o.hide()});$(".micro-publish").on("submit","form",function(){var t=$(this),e=[""];return a.find(".file-item input").each(function(){e.push("file[]="+this.value)}),postJson(t.attr("action"),t.serialize()+e.join("&"),function(t){200==t.code?(window.location.reload(),a.trigger(DIALOG_CLOSE)):parseAjax(t)}),!1}).on("input propertychange","textarea",function(){var t=$(this),e=t.closest(".micro-publish").find(".tip"),t=t.val().length;e.toggle(0<t).find("em").text(t)}).on("click",".actions .tools .fa-smile",function(){var t=$(this).offset();o.css({left:t.left,top:t.top+20}).show(),i=$(this).closest(".comment-publish,form")}).on("click",".actions .tools .fa-image,.actions .tools .fa-video",function(){var t=$(this),e=(n.options.filter=t.hasClass("fa-image")?"image/*":"",n.start(a),t.offset());a.css({left:e.left,top:e.top+20}),a.find(".file-item").remove(),i=t.closest(".comment-publish,form")}),$(".micro-item").on("click","[data-action=comment]",function(){var t=$(this).closest(".micro-item"),e=t.find(".comment-box").toggle();e.is(":hidden")||$.get(BASE_URI+"comment",{id:t.data("id")},function(t){e.html(t)})}).on("click","[data-action=recommend]",function(){var e=$(this),t=e.closest(".micro-item");$.getJSON(BASE_URI+"recommend",{id:t.data("id")},function(t){200==t.code&&e.text("赞"+(t.data&&0<t.data.recommend_count?t.data.recommend_count:"")).toggleClass("active",t.data.is_recommended),parseAjax(t)})}).on("click","[data-action=collect]",function(){var e=$(this),t=e.closest(".micro-item");$.getJSON(BASE_URI+"collect",{id:t.data("id")},function(t){200==t.code&&e.toggleClass("active",t.data.is_collected),parseAjax(t)})}).on("click","[data-action=remove]",function(){var e;confirm("确定要删除此条微博？")&&(e=$(this).closest(".micro-item"),$.getJSON(BASE_URI+"delete",{id:e.data("id")},function(t){200==t.code&&e.remove(),parseAjax(t)}))}).on("click",'[data-action="dialog"]',function(t){t.preventDefault();var t=$(this),e=Dialog.box({url:t.attr("href"),title:"转发微博",hasYes:!1,hasNo:!1,ondone:function(){var t=this.find(".forward-box");postJson(t.attr("action"),t.serialize(),function(t){e.close(),parseAjax(t)})}})}).on("click",".reply-input .btn",function(t){t.preventDefault();var e=$(this),t=e.attr("href"),i=e.closest(".reply-input");i.find("textarea").val().trim().length<0||postJson(t,formData(i),function(t){200==t.code&&t.data.url&&$.get(t.data.url,function(t){e.closest(".comment-box").html(t)})})}).on("input propertychange",".reply-input textarea",function(){var t=$(this),e=t.val();t.height(18*e.split("\n").length),t.closest(".reply-input").find(".btn").toggleClass("btn-disable",e.length<1)}).on("click",'[data-type="reply"]',function(t){t.preventDefault();var e,t=$(this),i=t.closest(".actions");0<i.next(".reply-input").length?i.next(".reply-input").toggle():(e=t.attr("href"),t=t.attr("title"),i.after('<div class="reply-input">\n        <div class="input">\n            <textarea name="content">'.concat(t,':</textarea>\n        </div>\n        <div class="input-actions">\n            <div class="tools">\n                <i class="fa fa-smile"></i>\n                <i class="fa fa-image"></i>\n            </div>\n            <a class="btn" href="').concat(e,'">回复</a>\n        </div>\n    </div>')))}).on("click",".attachment li",function(){var t=$(this),e=t.closest(".attachment");e.addClass("media-slider"),e.find(".media-large img").attr("src",t.find("img").attr("src"))}).on("click",".attachment .fa-times",function(){$(this).closest(".attachment").removeClass("media-slider")}).on("click",".attachment .media-large img",function(){$(this).closest(".attachment").removeClass("media-slider")})}function bindSharePage(){$(".micro-publish").on("submit","form",function(){var t=$(this);return postJson(t.attr("action"),t.serialize(),function(t){parseAjax(t)}),!1}).on("input propertychange","textarea[name=content]",function(){var t=$(this),e=t.closest(".micro-publish").find(".tip"),t=t.val().length;e.toggle(0<t).find("em").text(t)}).on("click",".pic-box .fa-times",function(){$(this).closest(".img-item").remove()})}function bindCode(){$(".micro-publish").on("submit","form",function(){var t=$(this);return postJson(t.attr("action"),t.serialize(),function(t){200==t.code?window.location.reload():parseAjax(t)}),!1}).on("keydown","textarea",function(t){9===t.keyCode&&(t.preventDefault(),t=this.selectionStart+4,this.value=this.value.substr(0,this.selectionStart)+"    "+this.value.substr(this.selectionStart),this.selectionStart=t,this.selectionEnd=t,this.focus())}),$(".micro-item").on("click","[data-action=comment]",function(){var t=$(this).closest(".micro-item"),e=t.find(".comment-box").toggle();e.is(":hidden")||$.get(BASE_URI+"comment",{id:t.data("id")},function(t){e.html(t)})}).on("click","[data-action=recommend]",function(){var e=$(this),t=e.closest(".micro-item");$.getJSON(BASE_URI+"recommend",{id:t.data("id")},function(t){200==t.code&&e.text("赞"+(t.data&&0<t.data.recommend_count?t.data.recommend_count:"")).toggleClass("active",t.data.is_recommended),parseAjax(t)})}).on("click","[data-action=collect]",function(){var e=$(this),t=e.closest(".micro-item");$.getJSON(BASE_URI+"collect",{id:t.data("id")},function(t){200==t.code&&e.toggleClass("active",t.data.is_collected),parseAjax(t)})}).on("click","[data-action=remove]",function(){var e;confirm("确定要删除此条微博？")&&(e=$(this).closest(".micro-item"),$.getJSON(BASE_URI+"delete",{id:e.data("id")},function(t){200==t.code&&e.remove(),parseAjax(t)}))}).on("click",".reply-input .btn",function(t){t.preventDefault();var e=$(this),t=e.attr("href"),i=e.closest(".reply-input");i.find("textarea").val().trim().length<0||postJson(t,formData(i),function(t){200==t.code&&t.data.url&&$.get(t.data.url,function(t){e.closest(".comment-box").html(t)})})}).on("input propertychange",".reply-input textarea",function(){var t=$(this),e=t.val();t.height(18*e.split("\n").length),t.closest(".reply-input").find(".btn").toggleClass("btn-disable",e.length<1)}).on("click",'[data-type="reply"]',function(t){t.preventDefault();var e,t=$(this),i=t.closest(".actions");0<i.next(".reply-input").length?i.next(".reply-input").toggle():(e=t.attr("href"),t=t.attr("title"),i.after('<div class="reply-input">\n        <div class="input">\n            <textarea name="content">'.concat(t,':</textarea>\n        </div>\n        <div class="input-actions">\n            <a class="btn" href="').concat(e,'">回复</a>\n        </div>\n    </div>')))})}