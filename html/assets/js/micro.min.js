var DIALOG_CLOSE="dialog-close";function bindMicroPage(){var e,a=new Upload(null,{url:UPLOAD_URI,name:"upfile",template:"{url}",onafter:function(t,i){return"SUCCESS"==t.state?(i.find(".dialog-body .add-btn").before('<div class="file-item"><img src="'+t.url+'" alt=""><input type="hidden" name="file[]" value="'+t.url+'"><i class="fa fa-times"></i></div>'),i.show()):302===t.code&&(location.href=t.url),!1}}),n=$(".dialog-upload").on(DIALOG_CLOSE,function(){n.hide(),n.find(".file-item").remove()}).on("click",".dialog-header .fa-times",function(){n.trigger(DIALOG_CLOSE)}).on("click",".file-item .fa-times",function(){$(this).closest(".file-item").remove()}).on("click",".add-btn",function(){a.options.filter="",a.start(n)}),o=$(".dialog-emoji").on("click",".dialog-header .fa-times",function(){o.hide()}).on("click",".dialog-header .tab-header li",function(){var t=$(this);t.addClass("active").siblings().removeClass("active"),t.closest(".dialog-emoji").find(".dialog-body .tab-item").eq(t.index()).addClass("active").siblings().removeClass("active")}).on("click",".emoji-item",function(){var t=$(this),i=e.find("textarea");i.val(i.val()+"["+t.attr("title")+"]"),o.hide()});$(".micro-publish").on("submit","form",function(){var t=$(this),i=[""];return n.find(".file-item input").each(function(){i.push("file[]="+this.value)}),postJson(t.attr("action"),t.serialize()+i.join("&"),function(t){if(200==t.code)return window.location.reload(),void n.trigger(DIALOG_CLOSE);302!=t.code?parseAjax(t):window.location.href=t.url}),!1}).on("input propertychange","textarea",function(){var t=$(this),i=t.closest(".micro-publish").find(".tip"),e=t.val().length;i.toggle(0<e).find("em").text(e)}).on("click",".actions .tools .fa-smile",function(){var t=$(this).offset();o.css({left:t.left,top:t.top+20}).show(),e=$(this).closest(".comment-publish,form")}).on("click",".actions .tools .fa-image,.actions .tools .fa-video",function(){var t=$(this);a.options.filter=t.hasClass("fa-image")?"image/*":"",a.start(n);var i=t.offset();n.css({left:i.left,top:i.top+20}),n.find(".file-item").remove(),e=t.closest(".comment-publish,form")}),$(".micro-item").on("click","[data-action=comment]",function(){var t=$(this).closest(".micro-item"),i=t.find(".comment-box").toggle();i.is(":hidden")||$.get(BASE_URI+"comment",{id:t.data("id")},function(t){i.html(t)})}).on("click","[data-action=recommend]",function(){var i=$(this),t=i.closest(".micro-item");$.getJSON(BASE_URI+"recommend",{id:t.data("id")},function(t){200==t.code&&i.text("赞"+(t.data&&0<t.data.recommend_count?t.data.recommend_count:"")).toggleClass("active",t.data.is_recommended),302!=t.code||(window.location.href=t.url)})}).on("click",'[data-action="dialog"]',function(t){t.preventDefault();var i=$(this),e=Dialog.box({url:i.attr("href"),title:"转发微博",hasYes:!1,hasNo:!1,ondone:function(){var t=this.find(".forward-box");postJson(t.attr("action"),t.serialize(),function(t){e.close(),parseAjax(t)})}})}).on("click",".reply-input .btn",function(t){t.preventDefault();var i=$(this),e=i.attr("href"),a=i.closest(".reply-input");a.find("textarea").val().trim().length<0||postJson(e,formData(a),function(t){200==t.code&&t.data.url&&$.get(t.data.url,function(t){i.closest(".comment-box").html(t)})})}).on("input propertychange",".reply-input textarea",function(){var t=$(this),i=t.val();t.height(18*i.split("\n").length),t.closest(".reply-input").find(".btn").toggleClass("btn-disable",i.length<1)}).on("click",'[data-type="reply"]',function(t){t.preventDefault();var i=$(this),e=i.closest(".actions");if(0<e.next(".reply-input").length)e.next(".reply-input").toggle();else{var a=i.attr("href"),n=i.attr("title");e.after('<div class="reply-input">\n        <div class="input">\n            <textarea name="content">'+n+':</textarea>\n        </div>\n        <div class="input-actions">\n            <div class="tools">\n                <i class="fa fa-smile"></i>\n                <i class="fa fa-image"></i>\n            </div>\n            <a class="btn" href="'+a+'">回复</a>\n        </div>\n    </div>')}}).on("click",".attachment li",function(){var t=$(this),i=t.closest(".attachment");i.addClass("media-slider"),i.find(".media-large img").attr("src",t.find("img").attr("src"))}).on("click",".attachment .fa-times",function(){$(this).closest(".attachment").removeClass("media-slider")}).on("click",".attachment .media-large img",function(){$(this).closest(".attachment").removeClass("media-slider")})}