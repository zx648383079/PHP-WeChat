var BASE_URI,Attribute=function(){function t(t,e){this.element=t,this.goodsId=e,this.attrBox=this.element.find(".attr-box"),this.productBox=this.element.find(".product-table"),this.bindEvent()}return t.prototype.bindEvent=function(){var r=this;this.attrBox.on("click",".add-box .btn",function(){var t=$(this).closest(".input-group"),e=t.attr("data-id"),i="",n=0;t.find(".add-box input").each(function(t,e){t<1?i=e.value:n=parseFloat(e.value),e.value=""}),r.addAttr(e,i,n)}).on("click",".check-label input[type=checkbox]",function(){var t=$(this).closest(".input-group").attr("data-id"),e=$(this).is(":checked"),i="";$(this).next().find("input").each(function(t,e){t<1&&(i=e.value)}),r.toggleAttr(t,i,e)}).on("click",".fa-remove",function(t){t.stopPropagation();var e=$(this).closest(".input-group").attr("data-id"),i=$(this).closest(".check-label").data("id");r.deleteAttrById(e,i)}).on("propertychange change","input[type=text]",function(){var t=$(this);r.editAttr(t.attr("name"),t.val())}),this.element.on("click",".batch-box .btn",function(){var n={};$(this).closest(".batch-box").find("input").each(function(){var t=$(this),e=t.data("type"),i=t.val();void 0!==e&&""!==e&&""!==i&&(n[e]=i)}),$.isEmptyObject(n)||(r.productList.forEach(function(t,e){r.productList[e].form=$.extend({},r.productList[e].form,n)}),r.renderProduct())}),this.productBox.on("propertychange change","input",function(){var t=$(this),e=t.attr("name"),i=t.parent().parent().data("index");r.productList[i].form[e]=t.val()})},t.prototype.editAttr=function(t,e){var i=this,n={goods_id:this.goodsId};n[t]=e,postJson(BASE_URI+"goods/edit_attribute",n,function(t){200==t.code&&(i.setAttr(t.data),i.refresh())})},t.prototype.setAttr=function(t){var e=this.getGroupById(t.attribute_id);if(e.type<0)e.attr_items=[t];else{for(var i=0;i<e.attr_items.length;i++)if(e.attr_items[i].id==t.id||e.attr_items[i].value==t.value)return void(e.attr_items[i]=$.extend({},e.attr_items[i],t));e.attr_items.push(t)}},t.prototype.deleteAttrById=function(t,e){var i=this.getGroupById(t);if(1!=i.input_type){var n=this;postJson(BASE_URI+"goods/delete_attribute",{goods_id:this.goodsId,id:e},function(t){200==t.code&&n.deleteAttrListById(i,e)})}},t.prototype.toggleAttr=function(t,e,i){void 0===i&&(i=!1);var n=this.getGroupById(t);if(1==n.input_type){var r=this;i?postJson(BASE_URI+"goods/save_attribute",{goods_id:this.goodsId,attribute_id:t,value:e},function(t){200==t.code&&(n.attr_items.push(t.data),r.refresh())}):postJson(BASE_URI+"goods/delete_attribute",{goods_id:this.goodsId,attribute_id:t,value:e},function(t){200==t.code&&r.deleteAttr(n,e)})}},t.prototype.deleteAttr=function(t,e){for(var i=0;i<t.attr_items.length;i++)if(t.attr_items[i].value==e){t.attr_items.splice(i,1);break}this.refresh()},t.prototype.deleteAttrListById=function(t,e){for(var i=0;i<t.attr_items.length;i++)if(t.attr_items[i].id==e){t.attr_items.splice(i,1);break}this.refresh()},t.prototype.addAttr=function(t,e,i){void 0===i&&(i=0);var n=this.getGroupById(t);if(!this.getAttrItem(e,n.attr_items)){var r=this;postJson(BASE_URI+"goods/save_attribute",{goods_id:this.goodsId,attribute_id:t,value:e,price:i},function(t){200==t.code&&(n.attr_items.push(t.data),r.refresh())})}},t.prototype.getGroupById=function(t){for(var e=0;e<this.attrList.length;e++)if(this.attrList[e].id==t)return this.attrList[e]},t.prototype.refresh=function(){this.renderHtml()},t.prototype.renderHtml=function(){this.renderAttr(),this.renderProduct()},t.prototype.renderProduct=function(){if(this.attrList.length<1)this.productBox.empty().parent().hide();else{var t=this.buildAttrList(),e=t[0],i=t[1];e.length<1?this.productBox.empty().parent().hide():this.productBox.html(template("tpl_spec_table",{attr_list:e,product_list:i})).parent().show()}},t.prototype.renderAttr=function(){var i=this;if(this.element.toggle(0<this.attrList.length),!(this.attrList.length<1)){var n="";this.attrList.forEach(function(t){var e="";e=t.type<1?i.getOnlyAttr(t):1==t.type?i.getSingleAttr(t):i.getMutliAttr(t),n+='<div class="input-group" data-id="'+t.id+'"><label>'+t.name+"</label><div>"+e+"</div></div>"}),this.attrBox.html(n)}},t.prototype.getMutliAttr=function(r){var a=this,o="";return 1==r.input_type?(r.default_value.forEach(function(t,e){var i=a.getAttrId(t,r.attr_items),n=i?i.id:"";o+='<span class="check-label attr-block" data-id="'+n+'"><input type="checkbox" id="attr_'+r.id+"_"+e+'" name="attr['+r.id+"]["+n+'][checked]" value="1" '+(n?"checked":"")+'><label for="attr_'+r.id+"_"+e+'"><input type="text" name="attr['+r.id+"]["+n+'][value]" value="'+t+'" readonly><input type="text" name="attr['+r.id+"]["+n+'][price]" value="'+(i?i.price:"")+'" placeholder="价格"></label></span>'}),o):(r.attr_items.forEach(function(t,e){o+='<span class="check-label attr-block" data-id="'+t.id+'"><input type="checkbox" id="attr_'+r.id+"_"+e+'" name="attr['+r.id+"]["+t.id+'][checked]" value="1" checked><label for="attr_'+r.id+"_"+e+'"><input type="text" name="attr['+r.id+"]["+t.id+'][value]" value="'+t.value+'"><input type="text" name="attr['+r.id+"]["+t.id+'][price]" value="'+t.price+'" placeholder="价格"></label><i class="fa fa-remove"></i></span>'}),o+'<div class="add-box attr-block"><input type="text"><input type="text" placeholder="价格"><button type="button" class="btn">添加</button></div>')},t.prototype.getSingleAttr=function(n){var r=this,a="";return 1==n.input_type?(n.default_value.forEach(function(t,e){var i=r.getAttrId(t,n.attr_items);a+='<span class="check-label" data-id="'+i+'"><input type="checkbox" id="attr_'+n.id+"_"+e+'" name="attr['+n.id+"]["+i+'][checked]" value="1" '+(i?"checked":"")+'><label for="attr_'+n.id+"_"+e+'"><input type="text" name="attr['+n.id+"]["+i+'][value]" value="'+t+'" readonly></label></span>'}),a):(n.attr_items.forEach(function(t,e){a+='<span class="check-label" data-id="'+t.id+'"><input type="checkbox" id="attr_'+n.id+"_"+e+'" name="attr['+n.id+"]["+t.id+'][checked]" value="1" checked><label for="attr_'+n.id+"_"+e+'"><input type="text" name="attr['+n.id+"]["+t.id+'][value]" value="'+t.value+'"></label><i class="fa fa-remove"></i></span>'}),a+'<div class="add-box"><input type="text"><button type="button" class="btn">添加</button></div>')},t.prototype.getAttrId=function(t,e){for(var i=0;i<e.length;i++)if(e[i].value==t)return e[i].id;return""},t.prototype.getAttrItem=function(t,e){for(var i=0;i<e.length;i++)if(e[i].value==t)return e[i]},t.prototype.getOnlyAttr=function(t){var e="",i="";return 0<t.attr_items.length&&(e=t.attr_items[0].id,i=t.attr_items[0].value),'<input type="text" class="form-control" name="attr['+t.id+"]["+e+'][value]" value="'+i+'">'},t.prototype.refreshByGroup=function(t){if(t<0)this.clear();else{var e=this;$.getJSON(BASE_URI+"goods/attribute",{group_id:t,goods_id:this.goodsId},function(t){200==t.code&&(e.attrList=t.data.attr_list,e.productList=t.data.product_list,e.refresh())})}},t.prototype.clear=function(){this.html("")},t.prototype.html=function(t){return this.element.html(t)},t.prototype.getRadioAttr=function(){for(var t=[],e=0;e<this.attrList.length;e++)1==this.attrList[e].type&&t.push(this.attrList[e]);return t},t.prototype.buildAttrList=function(){var e,t=1,i=this.getRadioAttr();for(e=0;e<i.length;e++)t*=i[e].attr_items.length;var n=[];for(e=0;e<t;e++){for(var r=[],a=1,o=[],c=0;c<i.length;c++){var s=i[c].attr_items,d=t/(a*=s.length),p=e/d%s.length;0==e%d&&r.push({rowspan:d,item_id:s[p].id,spec_value:s[p].value}),o.push(s[parseInt(p.toString())].id)}n.push({attributes:o.sort().join("_"),rows:r,form:{}})}if(0<this.productList.length&&0<n.length)for(e=0;e<n.length;e++){var l=this.productList.filter(function(t){return t.attributes===n[e].attributes});0<l.length&&(n[e].form=l[0].form)}return[i,this.productList=n]},t}();function bindGoods(t){BASE_URI=t;UE.getEditor("container");var e=new Attribute($(".attribute-box"));$("#attribute_group_id").change(function(){e.refreshByGroup(parseInt($(this).val()+""))}).trigger("change"),$(".btn-save").click(function(){$("input[name=product]").val(JSON.stringify(e.productList)),$(this).closest("form").submit()})}var RegionalChoice=function(){function t(t,e){this.element=t,this.datas=e,this.initInterface()}return t.prototype.render=function(t,e){this.initInterface(),0<(t=t||[]).length&&this.setAlready(t),0<(e=e||[]).length&&this.setChecked(e)},t.prototype.initInterface=function(){var t=this;t.element.empty().append($("<div/>",{class:"place-div"}).append($("<div/>",{}).append($("<div/>",{class:"checkbtn"}).append($("<label/>",{}).append($("<input/>",{type:"checkbox",change:function(){var t=$(this).is(":checked"),e=$(".place").find("input[type=checkbox]");$(".ratio").html(""),e.prop("checked",t)}})).append(" 全国")).append($("<a/>",{class:"clearCheck",text:"清空",click:function(){t.destroy()}}))).append($("<div/>",{class:"place clearfloat"}).append(t.getSmallPlace()))))},t.prototype.getSmallPlace=function(){var e=this;return $("<div/>",{class:"smallplace clearfloat"}).append($.map(e.datas,function(t){return $("<div/>",{class:"place-tooltips"}).append($("<label/>",{}).append($("<input/>",{id:"region_"+t.id,type:"checkbox",class:"province",change:function(){var t=$(this),e=t.parent().next(".citys").find("input"),i=t.parents(".place-tooltips");t.prop("checked")?(e.prop("checked",!0),i.find(".ratio").html("("+e.length+"/"+e.length+")")):(e.prop("checked",!1),i.find(".ratio").html(""))}})).append($("<span/>",{class:"province_name",text:t.name})).append(function(){if(t.children)return $("<span/>",{class:"ratio"})})).append(function(){if(t.children)return $("<div/>",{class:"citys"}).append($("<i/>",{class:"jt"}).append($("<i/>",{}))).append(e.getSmallCitys(t.children))})}))},t.prototype.getSmallCitys=function(t){return $("<div/>",{class:"row-div clearfloat"}).append($.map(t,function(t){return $("<p/>",{}).append($("<label/>",{}).append($("<input/>",{id:"region_"+t.id,type:"checkbox",name:"city[]",class:"city",change:function(){var t=$(this).parents(".citys"),e=$(this).parents(".place-tooltips"),i=t.find("input:checked").length,n=e.find(".province"),r=e.find(".ratio");0<i?(n.prop("checked",!0),r.html("("+i+"/"+t.find("input").length+")")):0===i&&(n.prop("checked",!1),r.html(""))}})).append($("<span/>",{text:t.name})))}))},t.prototype.getCheckedIds=function(){var i=[];return $('input[type=checkbox][name="city[]"]:checked').each(function(t,e){i.push(e.id.replace("region_",""))}),i},t.prototype.getCheckedTree=function(){var o=this,c=[];return $("input.province:checked").each(function(t,e){var i=$(this),n=e.id.replace("region_",""),r=i.parent().next().find("input.city:checked"),a=[];Object.keys(o.datas[n].children).length!==r.length&&r.each(function(t,e){a.push({id:e.id.replace("region_",""),name:$(this).next().text()})}),c.push({id:n,name:i.next().text(),children:a})}),c},t.prototype.getCheckedContent=function(){var t=this.getCheckedTree(),e=this.getCheckedIds(),i="";if(373===e.length)i="全国";else{var n="";t.forEach(function(t){if(n+=t.name,0<t.children.length){var e="";t.children.forEach(function(t){e+=t.name+"、"}),n+=' (<span class="am-link-muted">'+e.substring(0,e.length-1)+"</span>)"}n+="、"}),i=n.substring(0,n.length-1)}return{content:i,ids:e}},t.prototype.setChecked=function(t){var n=$(".place-div");$.each(t,function(t,e){var i=n.find("#region_"+e);i.length<1||(i[0].checked=!0,i.trigger("change"))})},t.prototype.setAlready=function(t){var n=$(".place-div");$.each(t,function(t,e){var i=n.find("#region_"+e).parent().parent();0<i.siblings().length?i.remove():i.closest(".place-tooltips").remove()})},t.prototype.destroy=function(){var t=$(".place-div");t.find("input[type=checkbox]").prop("checked",!1),t.find(".ratio").html("")},t}(),Delivery=function(){function t(t){this.element=t;var e=this;$.getJSON(BASE_URI+"region/tree",function(t){200==t.code&&e.init(t.data)})}return t.prototype.init=function(t){this.dialog=$(".regional-choice").dialog(),this.region=new RegionalChoice(this.dialog.find(".dialog-body"),t),this.initCreateRegion(),this.clickEditEvent(),this.clickDeleteEvent(),this.clickMethodEvent()},t.prototype.initCreateRegion=function(){var e=this;e.element.find(".add-region").click(function(){var i="";$(e.element).find("input[type=hidden]").each(function(t,e){i+=$(e).val()+","});var t=0<i.length?i.substring(0,i.length-1).split(","):[];if(373===t.length)return Dialog.tip("已经选择了所有区域~"),!1;e.region.render(t),e.showRegionalModal(function(){var t=e.region.getCheckedContent();0<t.ids.length&&e.appendRulesTr(t.content,t.ids)})})},t.prototype.appendRulesTr=function(t,e){var i=$('<tr><td class="am-text-left">   <p class="selected-content am-margin-bottom-xs">   '+t+'   </p>   <p class="operation am-margin-bottom-xs">       <a class="edit" href="javascript:;">编辑</a>       <a class="delete" href="javascript:;">删除</a>   </p>   <input type="hidden" name="shipping[region][]" value="'+e+'"></td><td>   <input type="number" name="shipping[first_step][]" value="1" required></td><td>   <input type="number" name="shipping[first_fee][]" value="0.00" required></td><td>   <input type="number" name="shipping[additional][]" value="0"></td><td>   <input type="number" name="shipping[additional_fee][]" value="0.00"></td><td>   <input type="number" name="shipping[free_step][]" value="0.00"></td></tr>');this.element.children().find("tr:last").before(i)},t.prototype.showRegionalModal=function(t){var e=this;this.dialog.on("done",function(){t&&t(),this.hide()}).on("close",function(){e.region.destroy()}).css({width:"820px",height:"520px"}).showCenter()},t.prototype.clickEditEvent=function(){var r=this;this.element.on("click",".edit",function(){var t=$(this).parent().parent(),e=t.find(".selected-content"),i=t.find("input[type=hidden]"),n="";$(r.element).find("input[type=hidden]").each(function(t,e){e!=i[0]&&(n+=$(e).val()+",")}),r.region.render(n.split(","),i.val().split(",")),r.showRegionalModal(function(){var t=r.region.getCheckedContent();0<t.ids.length&&(e.html(t.content),i.val(t.ids))})})},t.prototype.clickDeleteEvent=function(){this.element.on("click",".delete",function(){var t=$(this);confirm("确定要删除吗？")&&t.parents("tr").remove()})},t.prototype.clickMethodEvent=function(){$('input:radio[name="method"]').change(function(t){var e=$(".first"),i=$(".additional");"1"===t.currentTarget.value?e.text("首重 (Kg)")&&i.text("续重 (Kg)"):e.text("首件 (个)")&&i.text("续件 (个)")})},t}();function bindShipping(t){BASE_URI=t;new Delivery($(".regional-table"))}function bindEditAd(){var t=$(".type-group .input-group");$("#type").change(function(){t.eq(parseInt($(this).val())%2).show().siblings().hide()}).trigger("change")}$(function(){$(document).on("click","[data-type=toggle]",function(){var e=$(this);postJson(e.data("url"),function(t){200==t.code&&e.toggleClass("active")})})});