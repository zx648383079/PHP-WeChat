var Timer=function(){function t(){}return t.prototype.start=function(t,e,i){this.stop(),this.element=t,this.startAt=new Date("number"==typeof e?1e3*e:e);var a=this;this._handle=setInterval(function(){a._showTime(),i&&i()},500)},t.prototype._showTime=function(){this.element.text(t.format((new Date).getTime()-this.startAt.getTime()))},t.prototype.stop=function(){this.element&&(this.element.text("统计中。。。"),clearInterval(this._handle)),this.element=void 0,this._handle=0},t.format=function(t){var e=(t=Math.floor(t/1e3))%60,i=Math.floor(t/60)%60,a=function(t){return t<10?"0"+t:t};return a(Math.floor(t/3600))+":"+a(i)+":"+a(e)},t}(),timer=new Timer,isLoading=!1,times=120;function bindTask(e){"Notification"in window&&Notification.requestPermission(),refreshPanel(e),$(".panel ").on("click",".task-item .fa-pause-circle",function(){pauseTask(e,$(this).closest(".task-item"))}).on("click",".task-item .fa-play-circle",function(){playTask(e,$(this).closest(".task-item"))}).on("click",".task-item .fa-stop-circle",function(){stopTask(e,$(this).closest(".task-item"))});var i=$(".dialog-panel");$("[data-action=add]").click(function(t){t.preventDefault(),i.show()}),i.on("click",".task-item",function(){$(this).toggleClass("active")}).on("click",".btn",function(){var t=[];i.find(".task-item.active").each(function(){t.push($(this).removeClass("active").data("id"))}),i.hide(),t.length<1||postJson(e+"task/batch_add",{id:t},function(t){200===t.code?refreshPanel(e):parseAjax(t)})})}function refreshPanel(i){timer.stop(),$.get(i+"home/panel",function(t){$(".panel .panel-body").html(t),$(".panel .task-item").each(function(){var t=$(this),e=t.find(".time");t.hasClass("active")?timer.start(e,parseInt(e.data("start"),10),function(){checkTask(i,t)}):e.text(Timer.format(1e3*parseInt(e.text())))})})}function checkTask(e,t){times--,isLoading||0<times||(isLoading=!0,times=120,postJson(e+"task/check",{id:t.data("id")},function(t){isLoading=!1,200==t.code&&t.data&&(refreshPanel(e),Dialog.notify("提示",t.messages),alert(t.messages))}))}function pauseTask(e,t){timer.stop(),postJson(e+"task/pause",{id:t.data("id")},function(t){200==t.code&&refreshPanel(e)})}function playTask(e,t){postJson(e+"task/play",{id:t.data("id")},function(t){200==t.code&&refreshPanel(e)})}function stopTask(e,t){if(t.hasClass("active"))return timer.stop(),void postJson(e+"task/stop",{id:t.data("id")},function(t){refreshPanel(e)});confirm("是否确定结束此任务？")&&postJson(e+"task/stop_task",{id:t.data("id")},function(t){refreshPanel(e)})}