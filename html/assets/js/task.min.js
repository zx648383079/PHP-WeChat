var Timer=function(){function n(){this._timeSpace=300,this._timeDown=0,this._maxTime=1}return n.prototype.start=function(t,e){this.stop(),this.element=t,this.dialog=void 0,this.startAt=new Date("number"==typeof e?1e3*e:e);var i=this;this._handle=setInterval(function(){i._showTime()},this._timeSpace)},n.prototype._showTime=function(){var t=(new Date).getTime()-this.startAt.getTime();if(this.element.trigger(TASK_REFRESH_TIME,n.format(t)),this._timeDown-=this._timeSpace,this._timeDown<=0&&(this.element.trigger(TASK_CHECK),this._timeDown=6e4*this._maxTime),this.dialog){var e=this.element.data("time");if(!(e<1)){var i=6e4*e-t;this.dialog.trigger(TASK_TICK_TIMER,n.format(Math.max(0,i)))}}},n.prototype.stop=function(){this.element&&(this.element.text("统计中。。。"),clearInterval(this._handle)),this.element=void 0,this._handle=0,this.dialog=void 0},n.format=function(t){var e=(t=Math.floor(t/1e3))%60,i=Math.floor(t/60)%60,n=Math.floor(t/3600),a=function(t){return t<10&&0<=t?"0"+t:t};return(0<n?a(n)+":":"")+a(i)+":"+a(e)},n}(),timer=new Timer,isLoading=!1,times=120,TASK_START="task_start",TASK_PAUSE="task_pause",TASK_STOP="task_stop",TASK_CHECK="task_check",TASK_REFRESH_TIME="task_refresh_time",TASK_SHOW_TIMER="task_show_timer",TASK_HIDE_TIMER="task_hide_timer",TASK_TICK_TIMER="task_tick_timer",TASK_BATCH_ADD="task_batch_add";function bindTask(i){"Notification"in window&&Notification.requestPermission(),refreshPanel(i),$(".panel").on("dragover",function(t){t.stopPropagation(),t.preventDefault()}).on("drop",function(t){t.stopPropagation(),t.preventDefault();var e=parseInt(t.originalEvent.dataTransfer.getData("task"),10);e<1||n.trigger(TASK_BATCH_ADD,e)}).on(TASK_START,".task-item",function(){playTask(i,$(this))}).on(TASK_PAUSE,".task-item",function(){pauseTask(i,$(this))}).on(TASK_STOP,".task-item",function(){stopTask(i,$(this))}).on(TASK_REFRESH_TIME,".task-item",function(t,e){$(this).find(".time").text(e)}).on(TASK_CHECK,".task-item",function(){checkTask(i,$(this))}).on(TASK_SHOW_TIMER,".task-item",function(){$(this).hasClass("active")&&a.trigger(TASK_SHOW_TIMER,$(this).find(".name").text())}).on("click",".task-item .fa-pause-circle",function(){$(this).closest(".task-item").trigger(TASK_PAUSE)}).on("click",".task-item .fa-play-circle",function(){$(this).closest(".task-item").trigger(TASK_START)}).on("click",".task-item .fa-stop-circle",function(){$(this).closest(".task-item").trigger(TASK_STOP)}).on("click",".task-item .name",function(){$(this).closest(".task-item").trigger(TASK_SHOW_TIMER)}).on("click",".last-task-time .time",function(){var t=$(this),e=t.data("time");0<=t.text().indexOf("前")?t.text(e):t.text(Timer.format((new Date).getTime()-new Date(e).getTime())+"秒前")});var n=$(".dialog-panel");$("[data-action=add]").click(function(t){t.preventDefault(),n.show()}),n.on("click",".task-item",function(){$(this).toggleClass("active")}).on("click",".btn",function(){var t=[];n.find(".task-item.active").each(function(){t.push($(this).removeClass("active").data("id"))}),n.hide(),t.length<1||n.trigger(TASK_BATCH_ADD,t)}).on(TASK_BATCH_ADD,function(t,e){e&&postJson(i+"task/batch_add",{id:e},function(t){200===t.code?refreshPanel(i):parseAjax(t)})}).on("mouseenter",".task-item",function(){$(this).attr("draggable","true")}).on("dragstart",".task-item",function(t){t.originalEvent.dataTransfer.setData("task",$(this).data("id"))});var a=$(".dialog-timer"),o=null;a.on(TASK_HIDE_TIMER,function(t,e){void 0===e&&(e=0),animation(e,-$(window).height(),function(t){a.css("transform","translateY("+t+"px)")},function(){a.removeClass("closing"),a.hide(),exitFullscreen()})}).on(TASK_SHOW_TIMER,function(t,e){a.find(".timer-tip").text(e),a.show(),timer.dialog=a,fullScreen(),animation(-$(window).height(),0,function(t){a.css("transform","translateY("+t+"px)")},function(){a.removeClass("closing")})}).on(TASK_TICK_TIMER,function(t,e){a.find(".timer-box").text(e)}).on(TASK_PAUSE,function(){timer.element.trigger(TASK_PAUSE),a.trigger(TASK_HIDE_TIMER)}).on(TASK_STOP,function(t,e){timer.element.trigger(TASK_STOP),a.trigger(TASK_HIDE_TIMER,e)}).on("click",".timer-close",function(t){t.preventDefault(),a.trigger(TASK_STOP)}).on("click",".timer-pause",function(t){t.preventDefault(),a.trigger(TASK_PAUSE)}).on("touchstart",function(t){o={x:t.touches[0].clientX,y:t.touches[0].clientY}}).on("touchmove",function(t){var e=Math.min(t.changedTouches[0].clientY-o.y,0);a.css("transform","translateY("+e+"px)"),a.addClass("closing")}).on("touchend",function(t){var e=o.y-t.changedTouches[0].clientY;e<$(window).height()/3?animation(-e,0,function(t){a.css("transform","translateY("+t+"px)")},function(){a.removeClass("closing")}):a.trigger(TASK_STOP,-e)})}function animation(t,e,i,n){var a=e<t?-1:1,o=1,s=setInterval(function(){if(t+=o++*a,0<a&&e<=t||a<0&&t<=e)return clearInterval(s),i(e),void(n&&n());i(t)},16)}function refreshPanel(t){timer.stop(),$.get(t+"home/panel",function(t){$(".panel .panel-body").html(t),$(".panel .task-item").each(function(){var t=$(this),e=t.find(".time");t.hasClass("active")?timer.start(t,parseInt(e.data("start"),10)):t.trigger(TASK_REFRESH_TIME,Timer.format(1e3*parseInt(e.text())))})})}function checkTask(e,t){isLoading||(isLoading=!0,postJson(e+"task/check",{id:t.data("id")},function(t){isLoading=!1,200==t.code&&t.data&&(timer.dialog&&timer.dialog.trigger(TASK_HIDE_TIMER),refreshPanel(e),Dialog.notify("提示",t.messages),alert(t.messages))}))}function pauseTask(e,t){timer.stop(),postJson(e+"task/pause",{id:t.data("id")},function(t){200==t.code&&refreshPanel(e)})}function playTask(e,t){postJson(e+"task/play",{id:t.data("id")},function(t){200==t.code&&refreshPanel(e)})}function stopTask(e,t){if(t.hasClass("active"))return timer.stop(),void postJson(e+"task/stop",{id:t.data("id")},function(t){refreshPanel(e)});confirm("是否确定结束此任务？")&&postJson(e+"task/stop_task",{id:t.data("id")},function(t){refreshPanel(e)})}function bindRecord(){$("#today").datetimer({format:"yyyy-mm-dd"}),$(".search-box form").submit(function(){var t=$(this);return $.get(t.attr("action"),t.serialize(),function(t){$(".chart-box").html(t)}),!1}).trigger("submit")}function bindReview(){$("#today").datetimer({format:"yyyy-mm-dd"}),$(".search-box form").submit(function(){var t=$(this);return $.get(t.attr("action"),t.serialize(),function(t){$(".review-box").html(t)}),!1}).trigger("submit")}function fullScreen(){var t=document.documentElement;t.requestFullscreen&&t.requestFullscreen()}function exitFullscreen(){document.exitFullscreen&&document.exitFullscreen()}