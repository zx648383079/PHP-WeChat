var Timer=function(){function i(){this._timeSpace=300,this._timeDown=0,this._maxTime=1}return i.prototype.start=function(t,e){this.stop(),this.element=t,this.dialog=void 0,this.startAt=new Date("number"==typeof e?1e3*e:e);var i=this;this._handle=setInterval(function(){i._showTime()},this._timeSpace)},i.prototype._showTime=function(){var t,e=(new Date).getTime()-this.startAt.getTime();this.element.trigger(TASK_REFRESH_TIME,i.format(e)),this._timeDown-=this._timeSpace,this._timeDown<=0&&(this.element.trigger(TASK_CHECK),this._timeDown=6e4*this._maxTime),!this.dialog||(t=this.element.data("time"))<1||this.dialog.trigger(TASK_TICK_TIMER,i.format(Math.max(0,6e4*t-e)))},i.prototype.stop=function(){this.element&&(this.element.text("统计中。。。"),clearInterval(this._handle)),this.element=void 0,this._handle=0,this.dialog=void 0},i.format=function(t,e){isNaN(t)&&(t=0);function i(t){return t<10&&0<=t?"0"+t:t}var n=(t=Math.floor(t/1e3))%60,a=e&&e.indexOf("h")<0?Math.floor(t/60):Math.floor(t/60)%60,t=Math.floor(t/3600);return e?e.replace(/h+/,i(t)).replace(/i+/,i(a)).replace(/s+/,i(n)):(0!==t?i(t)+":":"")+i(a)+":"+i(n)},i}(),timer=new Timer,isLoading=!1,times=120,TASK_START="task_start",TASK_PAUSE="task_pause",TASK_STOP="task_stop",TASK_CHECK="task_check",TASK_REFRESH_TIME="task_refresh_time",TASK_SHOW_TIMER="task_show_timer",TASK_HIDE_TIMER="task_hide_timer",TASK_TICK_TIMER="task_tick_timer",TASK_BATCH_ADD="task_batch_add";function bindTask(n){"Notification"in window&&Notification.requestPermission(),refreshPanel(n),$(".panel").on("dragover",function(t){t.stopPropagation(),t.preventDefault()}).on("drop",function(t){t.stopPropagation(),t.preventDefault();t=parseInt(t.originalEvent.dataTransfer.getData("task"),10);t<1||e.trigger(TASK_BATCH_ADD,t)}).on(TASK_START,".task-item",function(){playTask(n,$(this))}).on(TASK_PAUSE,".task-item",function(){pauseTask(n,$(this))}).on(TASK_STOP,".task-item",function(){stopTask(n,$(this))}).on(TASK_REFRESH_TIME,".task-item",function(t,e){$(this).find(".time").text(e)}).on(TASK_CHECK,".task-item",function(){checkTask(n,$(this))}).on(TASK_SHOW_TIMER,".task-item",function(){$(this).hasClass("active")&&i.trigger(TASK_SHOW_TIMER,$(this).find(".name").text())}).on("click",".task-item .fa-pause-circle",function(){$(this).closest(".task-item").trigger(TASK_PAUSE)}).on("click",".task-item .fa-play-circle",function(){$(this).closest(".task-item").trigger(TASK_START)}).on("click",".task-item .fa-stop-circle",function(){$(this).closest(".task-item").trigger(TASK_STOP)}).on("click",".task-item .name",function(){$(this).closest(".task-item").trigger(TASK_SHOW_TIMER)}).on("click",".last-task-time .time",function(){var t=$(this),e=t.data("time");0<=t.text().indexOf("前")?t.text(e):t.text(Timer.format((new Date).getTime()-new Date(e).getTime(),"i分s秒")+"前")});var e=$(".dialog-panel"),i=($("[data-action=add]").on("click",function(t){t.preventDefault(),e.show()}),e.on("click",".task-item",function(){$(this).toggleClass("active")}).on("click",".btn",function(){var t=[];e.find(".task-item.active").each(function(){t.push($(this).removeClass("active").data("id"))}),e.hide(),t.length<1||e.trigger(TASK_BATCH_ADD,t)}).on(TASK_BATCH_ADD,function(t){for(var e=[],i=1;i<arguments.length;i++)e[i-1]=arguments[i];e&&postJson(n+"task/batch_add",{id:e},function(t){200!==t.code?parseAjax(t):refreshPanel(n)})}).on("mouseenter",".task-item",function(){$(this).attr("draggable","true")}).on("dragstart",".task-item",function(t){t.originalEvent.dataTransfer.setData("task",$(this).data("id"))}),$(".dialog-timer")),a=null;i.on(TASK_HIDE_TIMER,function(t,e){animation(e=void 0===e?0:e,-$(window).height(),function(t){i.css("transform","translateY("+t+"px)")},function(){i.removeClass("closing"),i.hide(),exitFullscreen()})}).on(TASK_SHOW_TIMER,function(t,e){i.find(".timer-tip").text(e),i.show(),timer.dialog=i,fullScreen(),animation(-$(window).height(),0,function(t){i.css("transform","translateY("+t+"px)")},function(){i.removeClass("closing")})}).on(TASK_TICK_TIMER,function(t,e){i.find(".timer-box").text(e)}).on(TASK_PAUSE,function(){timer.element.trigger(TASK_PAUSE),i.trigger(TASK_HIDE_TIMER)}).on(TASK_STOP,function(t,e){timer.element.trigger(TASK_STOP),i.trigger(TASK_HIDE_TIMER,e)}).on("click",".timer-close",function(t){t.preventDefault(),i.trigger(TASK_STOP)}).on("click",".timer-pause",function(t){t.preventDefault(),i.trigger(TASK_PAUSE)}).on("touchstart",function(t){a={x:t.touches[0].clientX,y:t.touches[0].clientY}}).on("touchmove",function(t){t=Math.min(t.changedTouches[0].clientY-a.y,0);i.css("transform","translateY("+t+"px)"),i.addClass("closing")}).on("touchend",function(t){t=a.y-t.changedTouches[0].clientY;t<$(window).height()/3?animation(-t,0,function(t){i.css("transform","translateY("+t+"px)")},function(){i.removeClass("closing")}):i.trigger(TASK_STOP,-t)})}function animation(t,e,i,n){var a=e<t?-1:1,o=1,s=setInterval(function(){t+=o++*a,0<a&&e<=t||a<0&&t<=e?(clearInterval(s),i(e),n&&n()):i(t)},16)}function refreshPanel(t){timer.stop(),$.get(t+"home/panel",function(t){$(".panel .panel-body").html(t),$(".panel .task-item").each(function(){var t=$(this),e=t.find(".time");t.hasClass("active")?timer.start(t,parseInt(e.data("start"),10)):t.trigger(TASK_REFRESH_TIME,Timer.format(1e3*parseInt(e.text())))})})}function checkTask(e,t){isLoading||(isLoading=!0,postJson(e+"task/check",{id:t.data("id")},function(t){isLoading=!1,200==t.code&&t.data&&(timer.dialog&&timer.dialog.trigger(TASK_HIDE_TIMER),refreshPanel(e),Dialog.notify("提示",t.message),alert(t.message))}))}function pauseTask(e,t){timer.stop(),postJson(e+"task/pause",{id:t.data("id")},function(t){200==t.code&&refreshPanel(e)})}function playTask(e,t){postJson(e+"task/play",{id:t.data("id")},function(t){200==t.code&&refreshPanel(e)})}function stopTask(e,t){t.hasClass("active")?(timer.stop(),postJson(e+"task/stop",{id:t.data("id")},function(t){refreshPanel(e)})):confirm("是否确定结束此任务？")&&postJson(e+"task/stop_task",{id:t.data("id")},function(t){refreshPanel(e)})}function bindRecord(){$("#today").datetimer({format:"yyyy-mm-dd"}),$(".page-search-bar form").on("submit",function(){var t=$(this);return $.get(t.attr("action"),t.serialize(),function(t){$(".chart-box").html(t)}),!1}).trigger("submit")}function bindReview(){$("#today").datetimer({format:"yyyy-mm-dd"}),$(".page-search-bar form").on("submit",function(){var t=$(this);return $.get(t.attr("action"),t.serialize(),function(t){$(".review-box").html(t)}),!1}).trigger("submit")}function fullScreen(){var t=document.documentElement;t.requestFullscreen&&t.requestFullscreen()}function exitFullscreen(){document.exitFullscreen&&document.exitFullscreen()}