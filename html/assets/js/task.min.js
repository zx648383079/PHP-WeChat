var Timer=function(){function n(){this._timeSpace=300,this._timeDown=0,this._maxTime=1}return n.prototype.start=function(t,i){this.stop(),this.element=t,this.dialog=void 0,this.startAt=new Date("number"==typeof i?1e3*i:i);var e=this;this._handle=setInterval(function(){e._showTime()},this._timeSpace)},n.prototype._showTime=function(){var t=(new Date).getTime()-this.startAt.getTime();if(this.element.trigger(TASK_REFRESH_TIME,n.format(t)),this._timeDown-=this._timeSpace,this._timeDown<=0&&(this.element.trigger(TASK_CHECK),this._timeDown=6e4*this._maxTime),this.dialog){var i=this.element.data("time");if(!(i<1)){var e=6e4*i-t;this.dialog.trigger(TASK_TICK_TIMER,n.format(Math.max(0,e)))}}},n.prototype.stop=function(){this.element&&(this.element.text("统计中。。。"),clearInterval(this._handle)),this.element=void 0,this._handle=0,this.dialog=void 0},n.format=function(t){var i=(t=Math.floor(t/1e3))%60,e=Math.floor(t/60)%60,n=Math.floor(t/3600),a=function(t){return t<10?"0"+t:t};return(0<n?a(n)+":":"")+a(e)+":"+a(i)},n}(),timer=new Timer,isLoading=!1,times=120,TASK_START="task_start",TASK_PAUSE="task_pause",TASK_STOP="task_stop",TASK_CHECK="task_check",TASK_REFRESH_TIME="task_refresh_time",TASK_SHOW_TIMER="task_show_timer",TASK_HIDE_TIMER="task_hide_timer",TASK_TICK_TIMER="task_tick_timer";function bindTask(i){"Notification"in window&&Notification.requestPermission(),refreshPanel(i),$(".panel ").on(TASK_START,".task-item",function(){playTask(i,$(this))}).on(TASK_PAUSE,".task-item",function(){pauseTask(i,$(this))}).on(TASK_STOP,".task-item",function(){stopTask(i,$(this))}).on(TASK_REFRESH_TIME,".task-item",function(t,i){$(this).find(".time").text(i)}).on(TASK_CHECK,".task-item",function(){checkTask(i,$(this))}).on(TASK_SHOW_TIMER,".task-item",function(){$(this).hasClass("active")&&n.trigger(TASK_SHOW_TIMER,$(this).find(".name").text())}).on("click",".task-item .fa-pause-circle",function(){$(this).closest(".task-item").trigger(TASK_PAUSE)}).on("click",".task-item .fa-play-circle",function(){$(this).closest(".task-item").trigger(TASK_START)}).on("click",".task-item .fa-stop-circle",function(){$(this).closest(".task-item").trigger(TASK_STOP)}).on("click",".task-item .name",function(){$(this).closest(".task-item").trigger(TASK_SHOW_TIMER)});var e=$(".dialog-panel");$("[data-action=add]").click(function(t){t.preventDefault(),e.show()}),e.on("click",".task-item",function(){$(this).toggleClass("active")}).on("click",".btn",function(){var t=[];e.find(".task-item.active").each(function(){t.push($(this).removeClass("active").data("id"))}),e.hide(),t.length<1||postJson(i+"task/batch_add",{id:t},function(t){200===t.code?refreshPanel(i):parseAjax(t)})});var n=$(".dialog-timer"),a=null;n.on(TASK_HIDE_TIMER,function(t,i){void 0===i&&(i=0),animation(i,-$(window).height(),function(t){n.css("transform","translateY("+t+"px)")},function(){n.removeClass("closing"),n.hide()})}).on(TASK_SHOW_TIMER,function(t,i){n.find(".timer-tip").text(i),n.show(),timer.dialog=n,animation(-$(window).height(),0,function(t){n.css("transform","translateY("+t+"px)")},function(){n.removeClass("closing")})}).on(TASK_TICK_TIMER,function(t,i){n.find(".timer-box").text(i)}).on(TASK_PAUSE,function(){timer.element.trigger(TASK_PAUSE),n.trigger(TASK_HIDE_TIMER)}).on(TASK_STOP,function(t,i){timer.element.trigger(TASK_STOP),n.trigger(TASK_HIDE_TIMER,i)}).on("click",".timer-close",function(t){t.preventDefault(),n.trigger(TASK_STOP)}).on("click",".timer-pause",function(t){t.preventDefault(),n.trigger(TASK_PAUSE)}).on("touchstart",function(t){a={x:t.touches[0].clientX,y:t.touches[0].clientY}}).on("touchmove",function(t){var i=Math.min(t.changedTouches[0].clientY-a.y,0);n.css("transform","translateY("+i+"px)"),n.addClass("closing")}).on("touchend",function(t){var i=a.y-t.changedTouches[0].clientY;i<$(window).height()/3?animation(-i,0,function(t){n.css("transform","translateY("+t+"px)")},function(){n.removeClass("closing")}):n.trigger(TASK_STOP,-i)})}function animation(t,i,e,n){var a=i<t?-1:1,s=1,o=setInterval(function(){if(t+=s++*a,0<a&&i<=t||a<0&&t<=i)return clearInterval(o),e(i),void(n&&n());e(t)},16)}function refreshPanel(t){timer.stop(),$.get(t+"home/panel",function(t){$(".panel .panel-body").html(t),$(".panel .task-item").each(function(){var t=$(this),i=t.find(".time");t.hasClass("active")?timer.start(t,parseInt(i.data("start"),10)):t.trigger(TASK_REFRESH_TIME,Timer.format(1e3*parseInt(i.text())))})})}function checkTask(i,t){isLoading||(isLoading=!0,postJson(i+"task/check",{id:t.data("id")},function(t){isLoading=!1,200==t.code&&t.data&&(refreshPanel(i),Dialog.notify("提示",t.messages),alert(t.messages))}))}function pauseTask(i,t){timer.stop(),postJson(i+"task/pause",{id:t.data("id")},function(t){200==t.code&&refreshPanel(i)})}function playTask(i,t){postJson(i+"task/play",{id:t.data("id")},function(t){200==t.code&&refreshPanel(i)})}function stopTask(i,t){if(t.hasClass("active"))return timer.stop(),void postJson(i+"task/stop",{id:t.data("id")},function(t){refreshPanel(i)});confirm("是否确定结束此任务？")&&postJson(i+"task/stop_task",{id:t.data("id")},function(t){refreshPanel(i)})}function bindRecord(){$("#today").datetimer({format:"yyyy-mm-dd"}),$(".search-box form").submit(function(){var t=$(this);return $.get(t.attr("action"),t.serialize(),function(t){$(".chart-box").html(t)}),!1}).trigger("submit")}function bindReview(){$("#today").datetimer({format:"yyyy-mm-dd"}),$(".search-box form").submit(function(){var t=$(this);return $.get(t.attr("action"),t.serialize(),function(t){$(".review-box").html(t)}),!1}).trigger("submit")}