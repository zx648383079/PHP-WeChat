var Timer=function(){function i(){}return i.prototype.start=function(t,e,i){this.stop(),this.element=t,this.dialog=void 0,this.startAt=new Date("number"==typeof e?1e3*e:e);var n=this;this._handle=setInterval(function(){n._showTime(),i&&i()},500)},i.prototype._showTime=function(){var t=(new Date).getTime()-this.startAt.getTime();if(this.element.text(i.format(t)),this.dialog){var e=this.element.closest(".task-item").data("time");e<1||this.dialog.find(".timer-box").text(i.format(6e4*e-t))}},i.prototype.stop=function(){this.element&&(this.element.text("统计中。。。"),clearInterval(this._handle)),this.element=void 0,this._handle=0,this.dialog=void 0},i.format=function(t){function e(t){return t<10?"0"+t:t}var i=(t=Math.floor(t/1e3))%60,n=Math.floor(t/60)%60,a=Math.floor(t/3600);return(0<a?e(a)+":":"")+e(n)+":"+e(i)},i}(),timer=new Timer,isLoading=!1,times=120;function bindTask(n){"Notification"in window&&Notification.requestPermission(),refreshPanel(n),$(".panel ").on("click",".task-item .fa-pause-circle",function(){pauseTask(n,$(this).closest(".task-item"))}).on("click",".task-item .fa-play-circle",function(){playTask(n,$(this).closest(".task-item"))}).on("click",".task-item .fa-stop-circle",function(){stopTask(n,$(this).closest(".task-item"))}).on("click",".task-item .name",function(){$(this).closest(".task-item").hasClass("active")&&(a.find(".timer-tip").text($(this).text()),a.show(),timer.dialog=a)});var e=$(".dialog-panel");$("[data-action=add]").click(function(t){t.preventDefault(),e.show()}),e.on("click",".task-item",function(){$(this).toggleClass("active")}).on("click",".btn",function(){var t=[];e.find(".task-item.active").each(function(){t.push($(this).removeClass("active").data("id"))}),e.hide(),t.length<1||postJson(n+"task/batch_add",{id:t},function(t){200===t.code?refreshPanel(n):parseAjax(t)})});var a=$(".dialog-timer"),s=null;a.on("click",".timer-close",function(t){t.preventDefault(),a.hide(),stopTask(n,timer.element.closest(".task-item"))}).on("click",".timer-pause",function(t){t.preventDefault(),a.hide(),pauseTask(n,timer.element.closest(".task-item"))}).on("touchstart",function(t){s={x:t.touches[0].clientX,y:t.touches[0].clientY}}).on("touchmove",function(t){var e=Math.min(t.changedTouches[0].clientY-s.y,0);a.css("transform","translateY("+e+"px)"),a.addClass("closing")}).on("touchend",function(t){var e=s.y-t.changedTouches[0].clientY,i=$(window).height();e<i/3?animation(-e,0,function(t){a.css("transform","translateY("+t+"px)")},function(){a.removeClass("closing")}):animation(-e,-i,function(t){a.css("transform","translateY("+t+"px)")},function(){a.removeClass("closing"),a.hide(),stopTask(n,timer.element.closest(".task-item"))})})}function animation(t,e,i,n){var a=e<t?-1:1,s=1,o=setInterval(function(){if(t+=s++*a,0<a&&e<=t||a<0&&t<=e)return clearInterval(o),i(e),void(n&&n());i(t)},16)}function refreshPanel(i){timer.stop(),$.get(i+"home/panel",function(t){$(".panel .panel-body").html(t),$(".panel .task-item").each(function(){var t=$(this),e=t.find(".time");t.hasClass("active")?timer.start(e,parseInt(e.data("start"),10),function(){checkTask(i,t)}):e.text(Timer.format(1e3*parseInt(e.text())))})})}function checkTask(e,t){times--,isLoading||0<times||(isLoading=!0,times=120,postJson(e+"task/check",{id:t.data("id")},function(t){isLoading=!1,200==t.code&&t.data&&(refreshPanel(e),Dialog.notify("提示",t.messages),alert(t.messages))}))}function pauseTask(e,t){timer.stop(),postJson(e+"task/pause",{id:t.data("id")},function(t){200==t.code&&refreshPanel(e)})}function playTask(e,t){postJson(e+"task/play",{id:t.data("id")},function(t){200==t.code&&refreshPanel(e)})}function stopTask(e,t){if(t.hasClass("active"))return timer.stop(),void postJson(e+"task/stop",{id:t.data("id")},function(t){refreshPanel(e)});confirm("是否确定结束此任务？")&&postJson(e+"task/stop_task",{id:t.data("id")},function(t){refreshPanel(e)})}function bindRecord(){$("#today").datetimer({format:"yyyy-mm-dd"}),$(".search-box form").submit(function(){var t=$(this);return $.get(t.attr("action"),t.serialize(),function(t){$(".chart-box").html(t)}),!1}).trigger("submit")}function bindReview(){$("#today").datetimer({format:"yyyy-mm-dd"}),$(".search-box form").submit(function(){var t=$(this);return $.get(t.attr("action"),t.serialize(),function(t){$(".review-box").html(t)}),!1}).trigger("submit")}