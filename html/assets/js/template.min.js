var DEL_URI="weight/destroy",NEW_URI="weight/create",REFRESH_URI="weight/refresh",EDIT_URI="weight/save",SETTING_URI="weight/setting",SAVE_SETTING_URI="weight/save_setting",INFO_URI="weight/info",Panel=function(){function t(t,e){this.page=e,this.element=$(t),this._init()}return t.prototype._init=function(){this._bindEvent()},t.prototype._bindEvent=function(){var t=this;this.element.find(".panel .head .fa-close").click(function(){t.element.addClass("min")}),this.element.find(".menu>li>.head").click(function(){$(this).parent().toggleClass("active")})},t.prototype.toggle=function(t){return"boolean"==typeof t&&(t=!t),this.element.toggleClass("min",t),this},t.prototype.bindDrag=function(){var n=this;this.element.find(".weight-edit-grid").draggable({connectToSortable:".weight-row",helper:"clone",opacity:.3,revert:"invalid",start:function(){n.page.body.addClass("hover")},stop:function(t,e){n.page.body.removeClass("hover"),console.log(arguments);var i=e.helper,o=i.closest(".weight-row");if(!o||o.length<1){if(!i.hasClass("weight-row"))return;o=i}n.page.addWeight(i,o)}})},t}(),Weight=function(){function t(t){this.box=t}return t.prototype.toggle=function(t){return this.box.toggleClass("weight-edit-mode",t),this},t.prototype.toggleLoading=function(t){return this.box.toggleClass("weight-loading",t),this},t.prototype.html=function(t){return this.box.replaceWith(t)},t.prototype.id=function(){return parseInt(this.box.attr("data-id"))},t.prototype.weightId=function(){return parseInt(this.box.attr("data-weight"))},t}(),Page=function(){function t(t,e){this.id=t,this.baseUri=e,this.box=$("#page-box"),this.element=$("#mainMobile"),this.bodyBox=$("#mainGrid"),this.body=this.bodyBox.contents().find("body"),this.weightBox=new Panel("#weight",this),this.propertyBox=new Panel("#property",this),this._init()}return t.prototype._init=function(){this._bindEvent(),this.resize()},t.prototype._bindEvent=function(){var e=this;$(window).resize(function(){e.resize()}),this.body.find(".weight-row").sortable({connectWith:".weight-row"}),this.body.on("click",".weight-action .del",function(){e.removeWeight($(this).closest(".weight-edit-grid"))}).on("click",".weight-action .edit",function(t){t.stopPropagation(),e.setWeight($(this).parents(".weight-edit-grid"))}).on("click",".weight-action .refresh",function(t){t.stopPropagation(),e.refreshWeight($(this).closest(".weight-edit-grid"))}),this.weightBox.bindDrag(),this.bindRule()},t.prototype.bindRule=function(){var i,e=0,o=this.element.find(".rule-box").on("mousedown",".rule-lines div",function(t){t.stopPropagation(),e=0,i=$(this)}).on("mousedown",".top-rule",function(){e=1}).on("mousemove",".top-rule",function(){1===e&&(i=$('<div class="h-line"></div>'),o.find(".rule-lines").append(i),e=0)}).on("mousedown",".left-rule",function(){e=2}).on("mousemove",".left-rule",function(){2===e&&(i=$('<div class="v-line"></div>'),o.find(".rule-lines").append(i),e=0)});$(document).on("mousemove",function(t){if(i)if(i.hasClass("v-line"))i.css("left",t.clientX+"px");else{var e=t.clientY-o.offset().top;i.css("top",e+"px")}}).on("mouseup",function(){i&&(i.hasClass("v-line")?i.offset().left<20&&i.remove():i.offset().top-o.offset().top<20&&i.remove(),i=void 0)})},t.prototype.refreshWeight=function(t){var e=t.attr("data-id"),i=this.setWeight(t,!1).toggleLoading(!0);this.post(REFRESH_URI,{id:e},function(t){i.toggleLoading(!1),200==t.code&&i.html(t.data.html)})},t.prototype.setWeight=function(t,e){return void 0===e&&(e=!0),this.weight&&this.weight.toggle(!1),this.weight=new Weight(t),this.weight.toggle(!0),e&&(this.weightBox.toggle(!0),this.propertyBox.toggle(!0)),this.weight},t.prototype.removeWeight=function(e){this.post(DEL_URI,{id:e.attr("data-id")},function(t){200==t.code&&e.remove()})},t.prototype.addWeight=function(t,e){t.width("auto");var i=this.setWeight(t).toggleLoading(!0);return this.post(NEW_URI,{weight_id:t.attr("data-weight"),parent_id:e.attr("data-id")},function(t){i.toggleLoading(!1),200==t.code&&i.html(t.data.html)}),i},t.prototype.resize=function(){this.box.height($(window).height()-57),this.drawRule(this.element.find(".top-rule"),20),this.drawRule(this.element.find(".left-rule"),20),this.bodyBox.width(this.element.width()-10),this.bodyBox.height(this.element.height())},t.prototype.html=function(){return $.htmlClean(this.body.html(),{format:!0,allowedAttributes:[["id"],["class"],["data-toggle"],["data-target"],["data-parent"],["role"],["data-dismiss"],["aria-labelledby"],["aria-hidden"],["data-slide-to"],["data-slide"]]})},t.prototype.getSetting=function(e,i){var o=this;return this._cacheSettings.hasOwnProperty(e)?i&&i(this._cacheSettings[e]):this.post(SETTING_URI,{id:e},function(t){200==t.code&&(o._cacheSettings[e]=t.data,i&&i(t.data))}),this},t.prototype.saveSetting=function(e,t,i){var o=this;return this.post(SAVE_SETTING_URI,{id:e,setting:t},function(t){200==t.code&&(o._cacheSettings[e]=t,i&&i(t.data))}),this},t.prototype.post=function(t,e,i){return e.page_id=this.id,postJson(this.baseUri+t,e,i),this},t.prototype.drawRule=function(t,e,i){void 0===i&&(i=1);var o=t.width(),n=t.height(),s=t[0];s.width=o,s.height=n;var h=s.getContext("2d");h.clearRect(0,0,s.width,s.height);for(var a=s.width>s.height,r=a?s.width:s.height,l=0;l<r;l+=10){var d=l-e,g=d%50==0?10:5;this.drawLine(h,a,l,g,5<g?d.toString():void 0)}},t.prototype.drawLine=function(t,e,i,o,n){e?(t.moveTo(i,20-o),t.lineTo(i,20)):(t.moveTo(20-o,i),t.lineTo(20,i)),t.lineWidth=1,t.strokeStyle="red",t.stroke(),n&&(t.font="6px Microsoft YaHei",e?t.fillText(n,i-5,10):t.fillText(n,0,i+3))},t}();function bindPage(t,e){var i=new Page(t,e);$(".mobile-size li").click(function(){$(".mobile-size").parent().removeClass("open");var t=$(this).attr("data-size").split("*");i.element.removeClass().addClass("mobile-"+t[0])}),$(".navbar>li>div").click(function(){$(this).parent().toggleClass("open")}),$(".mobile-size li").click(function(){$(this).addClass("active").siblings().removeClass("active")}),$(".mobile-rotate").click(function(){i.element.toggleClass("rotate")}),$(".expand>.head").click(function(){$(this).parent().toggleClass("open")})}