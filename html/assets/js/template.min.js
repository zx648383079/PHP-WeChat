var DEL_URI="weight/destroy",NEW_URI="weight/create",REFRESH_URI="weight/refresh",EDIT_URI="weight/save",SETTING_URI="weight/setting",SAVE_SETTING_URI="weight/save_setting",INFO_URI="weight/info",Weight=function(){function t(t){this.box=t}return t.prototype.toggle=function(t){return this.box.toggleClass("weight-edit-mode",t),this},t.prototype.toggleLoading=function(t){return this.box.toggleClass("weight-loading",t),this},t.prototype.html=function(t){return this.box.replaceWith(t)},t.prototype.id=function(){return parseInt(this.box.attr("data-id"))},t.prototype.weightId=function(){return parseInt(this.box.attr("data-weight"))},t}(),Page=function(){function t(t,e){var i=this;this.id=t,this.baseUri=e,this.box=$("#page-box"),this.element=$("#mainMobile"),this.bodyBox=$("#mainGrid"),this.panelGroup=this.box.find(".panel-group"),this.bodyBox.contents().ready(function(){i.body=i.bodyBox.contents().find("body"),i._init()})}return t.prototype._init=function(){this._bindEvent(),this.resize()},t.prototype._bindEvent=function(){var e=this;$(window).resize(function(){e.resize()}),this.body.on("click",".weight-action .del",function(){e.removeWeight($(this).closest(".weight-edit-grid"))}).on("click",".weight-action .edit",function(t){t.stopPropagation(),e.setWeight($(this).parents(".weight-edit-grid"))}).on("click",".weight-action .refresh",function(t){t.stopPropagation(),e.refreshWeight($(this).closest(".weight-edit-grid"))}).on("click",".weight-action .property",function(t){t.stopPropagation(),e.setWeight($(this).closest(".weight-edit-grid")),e.showPanel("property")}),this.panelGroup.on("click",".panel-item .panel-header .fa-close",function(t){t.stopPropagation(),$(this).closest(".panel-item").addClass("min"),e.resize()}).on("click",".panel-item .panel-header",function(){var t=$(this).closest(".panel-item");t.hasClass("min")&&(t.removeClass("min").siblings().addClass("min"),e.resize())}).find(".weight-edit-grid").attr("draggable","true").on("dragstart",function(t){t.originalEvent.dataTransfer.setData("Text",t.target.id),i=$(this)});var i=null;this.body.find(".weight-row").on("dragover",function(t){t.stopPropagation(),t.preventDefault()}).on("drop",function(t){t.stopPropagation(),t.preventDefault(),e.addWeight(i.clone(),$(this))}),this.bindRule()},t.prototype.showPanel=function(t){var e=this.panelGroup.find("[data-panel="+t+"]");return e.removeClass("min").siblings().addClass("min"),e},t.prototype.bindRule=function(){var i,e=0,o=this.element.find(".rule-box").on("mousedown",".rule-lines div",function(t){t.stopPropagation(),e=0,i=$(this)}).on("mousedown",".top-rule",function(){e=1}).on("mousemove",".top-rule",function(){1===e&&(i=$('<div class="h-line"></div>'),o.find(".rule-lines").append(i),e=0)}).on("mousedown",".left-rule",function(){e=2}).on("mousemove",".left-rule",function(){2===e&&(i=$('<div class="v-line"></div>'),o.find(".rule-lines").append(i),e=0)});$(document).on("mousemove",function(t){if(i)if(i.hasClass("v-line"))i.css("left",t.clientX+"px");else{var e=t.clientY-o.offset().top;i.css("top",e+"px")}}).on("mouseup",function(){i&&(i.hasClass("v-line")?i.offset().left<20&&i.remove():i.offset().top-o.offset().top<20&&i.remove(),i=void 0)})},t.prototype.refreshWeight=function(t){var e=t.attr("data-id"),i=this.setWeight(t,!1).toggleLoading(!0);this.post(REFRESH_URI,{id:e},function(t){i.toggleLoading(!1),200==t.code&&i.html(t.data.html)})},t.prototype.setWeight=function(t,e){return void 0===e&&(e=!0),this.weight&&this.weight.toggle(!1),this.weight=new Weight(t),this.weight.toggle(!0),this.weight},t.prototype.removeWeight=function(e){this.post(DEL_URI,{id:e.attr("data-id")},function(t){200==t.code&&e.remove()})},t.prototype.addWeight=function(t,e){e.append(t),t.width("auto");var i=this.setWeight(t).toggleLoading(!0);return this.post(NEW_URI,{weight_id:t.attr("data-weight"),parent_id:e.attr("data-id")},function(t){i.toggleLoading(!1),200==t.code&&i.html(t.data.html)}),i},t.prototype.resize=function(){var t=16;this.panelGroup.find(".panel-item").each(function(){$(this).hasClass("min")||(t=240)}),this.panelGroup.width(t),this.box.css("padding-left",t+"px");var e=$(window).height()-this.box.offset().top;this.box.height(e);var i=!!this.element.attr("class");i||this.element.height(e-25);var o=i?this.bodyBox.offset().top-this.element.offset().top-20:0,n=i?this.bodyBox.offset().left-this.element.offset().left-20:0;this.drawRule(this.element.find(".top-rule").css("top",o+"px"),n+20),this.drawRule(this.element.find(".left-rule").css("left",n+"px"),o+20),this.bodyBox.width(this.element.width()-20),this.bodyBox.height(this.element.height()-20)},t.prototype.html=function(){return $.htmlClean(this.body.html(),{format:!0,allowedAttributes:[["id"],["class"],["data-toggle"],["data-target"],["data-parent"],["role"],["data-dismiss"],["aria-labelledby"],["aria-hidden"],["data-slide-to"],["data-slide"]]})},t.prototype.getSetting=function(e,i){var o=this;return this._cacheSettings.hasOwnProperty(e)?i&&i(this._cacheSettings[e]):this.post(SETTING_URI,{id:e},function(t){200==t.code&&(o._cacheSettings[e]=t.data,i&&i(t.data))}),this},t.prototype.saveSetting=function(e,t,i){var o=this;return this.post(SAVE_SETTING_URI,{id:e,setting:t},function(t){200==t.code&&(o._cacheSettings[e]=t,i&&i(t.data))}),this},t.prototype.post=function(t,e,i){return e.page_id=this.id,postJson(this.baseUri+t,e,i),this},t.prototype.drawRule=function(t,e,i){void 0===i&&(i=1);var o=t.width(),n=t.height(),s=t[0];s.width=o,s.height=n;var a=s.getContext("2d");a.clearRect(0,0,s.width,s.height);for(var r=s.width>s.height,h=r?s.width:s.height,l=e;l<h;l+=10){var d=l-e,c=d%50==0?10:5;this.drawLine(a,r,l,c,5<c?d.toString():void 0)}},t.prototype.drawLine=function(t,e,i,o,n){e?(t.moveTo(i,20-o),t.lineTo(i,20)):(t.moveTo(20-o,i),t.lineTo(20,i)),t.lineWidth=1,t.strokeStyle="red",t.stroke(),n&&(t.font="6px Microsoft YaHei",e?t.fillText(n,i-5,10):t.fillText(n,0,i+3))},t}();function bindPage(t,e){var i=new Page(t,e);$(".mobile-size li").click(function(){$(".mobile-size").parent().removeClass("open");var t=$(this).attr("data-size").split("*");i.element.removeClass().removeAttr("style").addClass("mobile-"+t[0]),i.resize()}),$(".navbar>li>div").click(function(){$(this).parent().toggleClass("open")}),$(".mobile-size li").click(function(){$(this).addClass("active").siblings().removeClass("active")}),$(".mobile-rotate").click(function(){i.element.toggleClass("rotate")}),$(".expand>.head").click(function(){$(this).parent().toggleClass("open")})}function bindEdit(){$(".theme-select").on("click",".theme-item",function(){$(this).addClass("active").siblings().removeClass("active"),$("input[name=theme_id]").val($(this).data("id"))})}function bindPageEdit(){var e=$("#page-dialog").dialog(),i=null;$(".card-add a").click(function(t){t.preventDefault(),e.show(),i=$(this).attr("href")}),$(".page-select").on("click",".page-item",function(){$(this).addClass("active").siblings().removeClass("active")}),e.on("done",function(){var t=this.find(".page-item.active");t.length<1?alert("请选择模板"):(this.close(),postJson(i,{page_id:t.data("id")},function(t){parseAjax(t)}))})}